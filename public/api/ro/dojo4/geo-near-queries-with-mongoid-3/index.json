{
  "data": {
    "dojo4/geo-near-queries-with-mongoid-3": {
      "published_at": "2013-01-22 00:00:00 UTC",
      "title": "geoNear queries with mongoid 3",
      "author": "ara@dojo4.com",
      "body": "<div class=\"ro markdown\">\n  <p>today i was rolling out some new search functionality and really needed the ‘geoNear’ functionality of mongo</p>\n\n<p><a href=\"http://docs.mongodb.org/manual/reference/command/geoNear/\" target=\"_blank\">http://docs.mongodb.org/manual/reference/command/geoNear/</a></p>\n\n<p>unfortunately the mongoid (3) gem doesn’t directly support it.</p>\n\n<p>fortunately durran’s (<a href=\"https://twitter.com/modetojoy\" target=\"_blank\">https://twitter.com/modetojoy</a>) code is tight enough that a few moments of digging found the solution, and led to this actual code:</p>\n\n<div class=\"language-ruby highlighter-rouge\"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>\n</div><div class='code-line code-line-2'><span style=\"color: #6e7781\"># http://stackoverflow.com/questions/5319988/how-is-maxdistance-measured-in-mongodb</span>\n</div><div class='code-line code-line-3'><span style=\"color: #6e7781\">#   1° latitude = 69.047 miles = 111.12 kilometers</span>\n</div><div class='code-line code-line-4'><span style=\"color: #6e7781\">#</span>\n</div><div class='code-line code-line-5'>\n</div><div class='code-line code-line-6'>&nbsp;&nbsp;<span style=\"color: #953800\">DEGREES_PER_MILE</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #0550ae\">1</span>&nbsp;<span style=\"color: #0550ae\">/</span>&nbsp;<span style=\"color: #0550ae\">69.047</span>\n</div><div class='code-line code-line-7'>&nbsp;&nbsp;<span style=\"color: #953800\">MILES_PER_DEGREE</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #0550ae\">1</span>&nbsp;<span style=\"color: #0550ae\">/</span>&nbsp;<span style=\"color: #953800\">DEGREES_PER_MILE</span>\n</div><div class='code-line code-line-8'>\n</div><div class='code-line code-line-9'>&nbsp;&nbsp;<span style=\"color: #cf222e\">def</span>&nbsp;<span style=\"color: #953800\">Store</span><span style=\"color: #0550ae\">.</span><span style=\"color: #8250df\">find_all_by_lat_lng</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">lat</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">lng</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">options</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">{})</span>\n</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">options</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">to_options!</span>\n</div><div class='code-line code-line-11'>\n</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">miles</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">options</span><span style=\"color: #24292f;background-color: #f6f8fa\">[</span><span style=\"color: #0a3069\">:miles</span><span style=\"color: #24292f;background-color: #f6f8fa\">]</span>&nbsp;<span style=\"color: #0550ae\">||</span>&nbsp;<span style=\"color: #0550ae\">100</span>\n</div><div class='code-line code-line-13'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">max_distance</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">miles</span>&nbsp;<span style=\"color: #0550ae\">*</span>&nbsp;<span style=\"color: #953800\">DEGREES_PER_MILE</span>\n</div><div class='code-line code-line-14'>\n</div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">doc</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;\n</div><div class='code-line code-line-16'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #953800\">Mongoid</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">session</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #0a3069\">:default</span><span style=\"color: #24292f;background-color: #f6f8fa\">).</span>\n</div><div class='code-line code-line-17'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #8250df\">command</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span>\n</div><div class='code-line code-line-18'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #0a3069\">:geoNear</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #0550ae\">=&gt;</span>&nbsp;<span style=\"color: #953800\">Store</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">collection_name</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>\n</div><div class='code-line code-line-19'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #0a3069\">:near</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #0550ae\">=&gt;</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">{</span><span style=\"color: #0a3069\">:lat</span>&nbsp;<span style=\"color: #0550ae\">=&gt;</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">lat</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #0a3069\">:lng</span>&nbsp;<span style=\"color: #0550ae\">=&gt;</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">lng</span><span style=\"color: #24292f;background-color: #f6f8fa\">},</span>\n</div><div class='code-line code-line-20'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #0a3069\">:maxDistance</span>&nbsp;<span style=\"color: #0550ae\">=&gt;</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">max_distance</span>\n</div><div class='code-line code-line-21'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-22'>\n</div><div class='code-line code-line-23'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">stores</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">[]</span>\n</div><div class='code-line code-line-24'>\n</div><div class='code-line code-line-25'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">if</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">doc</span><span style=\"color: #24292f;background-color: #f6f8fa\">[</span><span style=\"color: #0a3069\">'ok'</span><span style=\"color: #24292f;background-color: #f6f8fa\">]</span>&nbsp;<span style=\"color: #0550ae\">==</span>&nbsp;<span style=\"color: #0550ae\">1.0</span>\n</div><div class='code-line code-line-26'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">results</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #953800\">Array</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">doc</span><span style=\"color: #24292f;background-color: #f6f8fa\">[</span><span style=\"color: #0a3069\">'results'</span><span style=\"color: #24292f;background-color: #f6f8fa\">])</span>\n</div><div class='code-line code-line-27'>\n</div><div class='code-line code-line-28'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">results</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">each</span>&nbsp;<span style=\"color: #cf222e\">do</span>&nbsp;<span style=\"color: #0550ae\">|</span><span style=\"color: #24292f;background-color: #f6f8fa\">result</span><span style=\"color: #0550ae\">|</span>\n</div><div class='code-line code-line-29'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">distance_in_degrees</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">result</span><span style=\"color: #24292f;background-color: #f6f8fa\">[</span><span style=\"color: #0a3069\">'dis'</span><span style=\"color: #24292f;background-color: #f6f8fa\">]</span>\n</div><div class='code-line code-line-30'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">obj</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">result</span><span style=\"color: #24292f;background-color: #f6f8fa\">[</span><span style=\"color: #0a3069\">'obj'</span><span style=\"color: #24292f;background-color: #f6f8fa\">]</span>\n</div><div class='code-line code-line-31'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">store</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #953800\">Store</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">instantiate</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">obj</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-32'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">store</span><span style=\"color: #24292f;background-color: #f6f8fa\">[</span><span style=\"color: #0a3069\">'distance'</span><span style=\"color: #24292f;background-color: #f6f8fa\">]</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #953800\">Float</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">distance_in_degrees</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>&nbsp;<span style=\"color: #0550ae\">*</span>&nbsp;<span style=\"color: #953800\">MILES_PER_DEGREE</span>\n</div><div class='code-line code-line-33'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">stores</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">push</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">store</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-34'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-35'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-36'>\n</div><div class='code-line code-line-37'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">stores</span>\n</div><div class='code-line code-line-38'>&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-39'>\n</div><div class='code-line code-line-40'>\n</div></code></div>\n\n</div>\n",
      "assets": {},
      "_meta": {
        "identifier": "dojo4/geo-near-queries-with-mongoid-3",
        "type": "dojo4",
        "id": "geo-near-queries-with-mongoid-3",
        "urls": [
          "/ro/dojo4/geo-near-queries-with-mongoid-3/body.md"
        ],
        "created_at": "2025-05-06 08:47:14 +0000",
        "updated_at": "2025-05-06 08:47:14 +0000",
        "rel": {
          "curr": "dojo4/geo-near-queries-with-mongoid-3",
          "prev": "dojo4/beginning-and-ending-properly",
          "next": "dojo4/running-dropbox-for-multiple-accounts-on-one-machine"
        }
      }
    }
  },
  "_meta": {
    "url": "/ro",
    "type": "dojo4",
    "id": "geo-near-queries-with-mongoid-3"
  }
}