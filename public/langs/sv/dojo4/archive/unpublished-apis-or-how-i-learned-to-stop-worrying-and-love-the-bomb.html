<html color-mode="user" lang="sv">
  <head>
    <base href='/sv' />
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DQVD9T27V4');
</script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

  <!-- meta -->
    <title>Opublicerade API:er eller, Hur Jag Lärde Mig Att Sluta Oroa Mig Och Älska Bomben.</title>

<meta property="og:title" content="Opublicerade API:er eller, Hur Jag Lärde Mig Att Sluta Oroa Mig Och Älska Bomben."/>
<meta property="og:description" content="fortsätt." />
<meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

<meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"opublicerade-api-eller-hur-jag-lärde-mig-att-sluta-oroa-mig-och-älska-bomben"}">
    <meta property="site:path_info" content=""/opublicerade-api-eller-hur-jag-lärde-mig-att-sluta-oroa-mig-och-älska-bomben"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) {
          progressBar.remove();
        }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a>
<hr>
    </header>

    <main>
      <div class="ro markdown">
  <p>Ibland har du några tråkiga upprepade uppgifter online eller du behöver automatisera en del av eller hela en arbetsflöde på en webbplats. Att skripta dessa interaktioner kan förhindra att vi slösar tonvis av människotimmar på att monotont klicka igenom samma sidor på en webbplats.</p>

<p>Många av oss kommer att använda <a href="http://mechanize.rubyforge.org/">Mechanize</a> direkt. Sedan upptäcker du att webbplatsens användargränssnitt som du försöker automatisera en uppgift för är JavaScript-tungt eller AJAX-tungt. Vad gör du nu?</p>

<p><a href="http://http://phantomjs.org/">Phantomjs</a> till undsättning. Phantomjs är en snabb, lätt skriptbar, headless WebKit-webbläsare. När jobbet misslyckas av någon anledning kan du ta en skärmbild för granskning. För oss innebar det att e-posta den till en administratör eftersom jobben körs på servrar och inte lokalt. Vi använder också <a href="https://github.com/westoque/phantomjs.rb">Phantomjs.rb</a> för att hantera sökvägen och utdata från Phantomjs.</p>

<p>Här är lite kod från vad vi gör.</p>

<pre><code>class InvitationAcceptor
  attr_accessor :invitation, :tmpdir

  def initialize(invitation)
    self.invitation = invitation
  end

  def accept!
    fail_image_path = false

    Dir.mktmpdir(invitation.id.to_s) do |tmpdir|
      self.tmpdir = tmpdir

      Phantomjs.inline(js) do |line|
        puts line
        fail_image_path = line.gsub('FAIL:', '').chomp if line.starts_with?('FAIL')
      end

      if fail_image_path
        Mailer.invitaion_failed(invitation, fail_image_path).deliver
      else
        invitation.invitation_accepted!
      end
    end
  end

  private

    def js
      fail_image = "#{tmpdir}/failed.png"

      &lt;&lt;-JS
        // https://github.com/ariya/phantomjs/blob/master/examples/waitfor.js
        function waitFor(testFx, onReady, timeOutMillis) {
          var maxtimeOutMillis = timeOutMillis ? timeOutMillis : 10000,
            start = new Date().getTime(),
            condition = false
          var interval = setInterval(function() {
            if ((new Date().getTime() - start &lt; maxtimeOutMillis) &amp;&amp; !condition) {
              condition = (typeof(testFx) === "string" ? eval(testFx) : testFx());
            } else {
              if (! condition) {
                fail()
              } else {
                console.log("'waitFor()' waited " + (new Date().getTime() - start) + "ms.");
                typeof(onReady) === "string" ? eval(onReady) : onReady();
                clearInterval(interval);
              }
            }
          }, 250);
        };

        var page = require('webpage').create(),
          testindex = 0,
          loadInProgress = false,
          tries = 0;

        // detta är viktigt för vår app eftersom webbplatsen vi automatiserar försöker blockera automatisering.
        page.settings.userAgent = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.116 Safari/537.36'

        var fail = function() {
          // skicka misslyckandemeddelandet och bildsökvägen till Ruby-skriptet
          console.log("FAIL:#{fail_image}");
          // spara skärmbilden till filsystemet så att den kan e-postas
          page.render("#{fail_image}");
          phantom.exit()
        }

        page.onConsoleMessage = function(msg) {
          console.log(msg);
        };

        page.onLoadStarted = function() {
          loadInProgress = true;
          console.log("laddning startad");
        };

        page.onLoadFinished = function(status) {
          loadInProgress = false;
          console.log("laddning slutförd");
        };

        var steps = [
          function() {
            console.log("Ladda inloggningssidan");

            page.open("#{invitation.invitation_received.subject}")
          },
          function() {
            console.log("Verifiera att inbjudan fortfarande är giltig");

            success = page.evaluate(function() {
              if (null == document.getElementById('hasSomeElement')) {
                return false;
              }

              return true;
            })

            if (! success) {
              fail();
            }

          },
          function() {
            console.log("Ange inloggningsuppgifter");

            page.evaluate(function() {
              document.getElementById('hasSomeElement').checked;
              document.getElementById('hasSomeElement').checked;
              document.getElementById('email').value = '#{invitation.email}';
              document.getElementById('password').value = '#{invitation.password}';
              document.getElementById('login').click();
            });
          },
          function() {
            console.log("Acceptera villkoren");

            page.evaluate(function() {
              document.getElementById('accept').click()
            });
          },
          function() {
            console.log("Vänta på att JavaScript-galenskapen ska slutföras");

            waitFor(function() {
              return page.evaluate(function() {
                return document.getElementsByClassName('someExpectedContent').length != 0
              });
            }, function() {
              phantom.exit();
            });
          }
        ]

        interval = setInterval(function() {
          if (!loadInProgress &amp;&amp; typeof steps[testindex] == "function") {
            steps[testindex]();
            // användbart för felsökning
            page.render("#{tmpdir}/step" + (testindex + 1) + ".png");
            testindex++;
          }
        }, 250);
      JS
    end

end
</code></pre>

<p>Du kan också injicera skript i sidan, med <a href="http://phantomjs.org/api/webpage/method/inject-js.html">injectJs</a> eller <a href="http://phantomjs.org/api/webpage/method/include-js.html">includeJs</a> men jag föredrar att hålla mig till vad som redan finns eller bara använda grunderna för att undvika eventuella krockar med vad som kan finnas på sidan redan.</p>

</div>
    </main>

    <footer>
      <hr>
<a href="/goto" name="goto">&mdash;&gt; gå till</a>
<blockquote>
<ul>
  <li>
    <a href="/about">om<a>
  </li>
  <li>
    <a href="mailto:i-hate-this@drawohara.io?subject=/opublicerade-api-eller-hur-jag-lärde-mig-att-sluta-oroa-mig-och-älska-bomben">i-hate-this<a>
  </li>
  <li>
    <a href="mailto:i-love-this@drawohara.io?subject=/opublicerade-api-eller-hur-jag-lärde-mig-att-sluta-oroa-mig-och-älska-bomben">i-love-this<a>
  </li>
  <li>
    <a href="/contact">kontakt<a>
  </li>
</ul>
</blockquote>
<a href="/">&lt;&mdash; ut</a>
    </footer>
  </body>
</html>