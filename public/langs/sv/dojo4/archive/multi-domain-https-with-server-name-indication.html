<html color-mode="user" lang="sv">
  <head>
  <base href='/sv' />
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DQVD9T27V4');
</script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

  <!-- meta -->
    <title>Multidomän HTTPS med Server Name Indication</title>

<meta property="og:title" content="Multidomän HTTPS med Server Name Indication"/>
<meta property="og:description" content="fortsätt." />
<meta property="og:image" content="https://drawohara.io/media/mick.jpg" />


  <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"multi-domain-https-with-server-name-indication"}">
    <meta property="site:path_info" content=""/multi-domain-https-with-server-name-indication"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) {
          progressBar.remove();
        }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a>
<hr>
    </header>

    <main>
      <div class="ro markdown">
  <p>(Detta är en förkortad version av <a href="http://www.stuff-things.net/2014/11/14/yes-virginia-you-can-use-sni/">Yes, Virginia, You Can Use SNI</a> som ursprungligen publicerades på Spikes <a href="http://www.stuff-things.net/">Stuff... And Things... blogg</a>)</p>

<p>När du ansluter till en webbserver säkert med HTTPS förhandlas säkerheten fram med <a href="http://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</a>. Två saker händer, serverns identitet verifieras och anslutningen krypteras.</p>

<p>Verifieringen är viktig, det spelar ingen roll om anslutningen är krypterad om du av någon anledning har omdirigerats till en elak servers. Dock kan denna verifiering vara problematisk om en webbserver serverar fler än en värdnamn.</p>

<p>Du kan läsa de <a href="http://en.wikipedia.org/wiki/Transport_Layer_Security#TLS_handshake">blodiga detaljerna</a>, men den förenklade versionen av processen är att servern skickar ett signerat <a href="http://en.wikipedia.org/wiki/Public_key_certificate">offentligt nyckelcertifikat</a> som måste matcha värdnamnet i URL:en. Om en klient bläddrar till dojo4.com måste certifikatet vara för dojo4.com, annars visar webbläsaren ett stort skrämmande varning.</p>

<p>Tekniskt sett är det möjligt att ha flera värdnamn på ett certifikat, faktiskt är det vanligt att ha både “dojo4.com” och “www.dojo.com” för fullständighet. Dock är det en enorm plåga att lägga till och ta bort värdnamn från ett certifikat. Du måste få utgivaren att generera ett nytt och återkalla det gamla. Och om du arbetar med ett Content Delivery Network är det mycket osannolikt att de lägger till dina värdnamn till deras certifikat.</p>

<p>Ursprungligen stödde TLS endast ett certifikat per webbserver (eller mer korrekt, per IP-adress som är kopplad till webbservern) <a href="http://en.wikipedia.org/wiki/Server_Name_Indication">Server Name Indication (SNI)</a> lades till i TLS för att lösa detta problem. I början av TLS-förhandlingen berättar klienten för servern namnet på värden den försöker ansluta till och servern kan då välja och skicka en korrekt certifikatfil. Problem löst!</p>

<p>Förutom… Alla webbläsare stödjer inte SNI. Alla <em>vet</em> detta, och som ett resultat tenderar de att hoppa över SNI och gå direkt till dedikerade IP-adresser per webbplats eller till och med flera servrar. Detta är en dyr alternativ, särskilt när man arbetar med CDN:er som CloudFront. När detta kom upp för mig bestämde jag mig för att se vad “inte alla webbläsare” egentligen betydde.</p>

<p>Det visar sig att SNI har brett stöd, med de stora problemen som är IE8 och nedåt och vilken version av IE som körs på Windows XP (eftersom det underliggande operativsystemsbiblioteket inte stödjer SNI). Det finns även några äldre versioner av Android som saknar stöd.</p>

<p>Så, de flesta besökare kommer inte att ha några problem med SNI och gruppen som gör det är liten nog så att vi kan hantera dem som ett speciellt fall.</p>

<p>För de webbläsare utan SNI-stöd är lösningen att omdirigera dem till ett certifikat som kommer att fungera eller en smidig “uppdatera din webbläsare”-sida. Om du googlear hittar du en massa lösningar om att bygga vitlistor av bra webbläsare och/eller svartlistor av dåliga och sedan använda dessa listor i serversida omdirigeringsregler. Fult. Listorna måste underhållas och beroende på servern bryter cachningen.</p>

<p>Det finns ett smartare sätt. Medan jag vadade genom ett hav av exempel på Apache-omdirigeringskonfigurationer hittade jag det i den här <a href="https://www.ebower.com/wiki/Detecting_SNI_with_Apache">posten</a>. Postens kärnidé kan destilleras ner till detta, om en webbläsare som inte stödjer SNI försöker ladda SNI-innehåll kommer den att få ett fel. Om vi testar detta i bakgrunden och skiljer mellan fel och framgång kan vi omdirigera besökaren på lämpligt sätt. Och det enklaste sättet att göra det är att försöka lägga till en pixlar stor bild på sidan.</p>

<p>I kod ser det ut så här:</p>

<div class="language-javascript highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #cf222e">function</span>&nbsp;<span style="color: #8250df">secure_redirect</span><span style="color: #24292f;background-color: #f6f8fa">()</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #0550ae">=</span><span style="color: #953800">document</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">createElement</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">img</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>&nbsp;<span style="color: #6e7781">// skapa ett img-element.</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Ange src till en SNI-URL för en pixlar stor bild</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">src</span><span style="color: #0550ae">=</span><span style="color: #0a3069">'</span><span style="color: #0a3069">https://www.example.org/pixel.gif</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Det här utförs om SNI fungerar.</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">onload</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">()</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Omdirigera till den säkra sidan.</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">href</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">https://example.org/</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">};</span>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Det här utförs om SNI inte fungerar.</span>
</div><div class='code-line code-line-11'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">onerror</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #24292f;background-color: #f6f8fa">)</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Omdirigera annorstädes</span>
</div><div class='code-line code-line-13'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">href</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">http://example.org/snarky-old-browser-message</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-14'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">};</span>
</div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Visa inte faktiskt bilden</span>
</div><div class='code-line code-line-16'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">style</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">display</span><span style="color: #0550ae">=</span><span style="color: #0a3069">'</span><span style="color: #0a3069">none</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-17'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// men lägg till den på sidan så att den laddas.</span>
</div><div class='code-line code-line-18'>&nbsp;&nbsp;&nbsp;<span style="color: #953800">document</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">body</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">appendChild</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-19'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
</div></code></div>

<p>Här utnyttjar jag två HTML-callbacks på <em>img</em>-taggen, ‘OnLoad’ som utlöses när en bild har slutförts laddningen, och ‘OnError’ som utlöses om bilden inte kan laddas. Om en webbläsare inte stödjer SNI kommer bilden att misslyckas med att laddas på grund av ett certifikatfel, vilket utlöser ‘OnError’. Men eftersom vi lägger till bilden på en redan laddad sida kommer den inte att orsaka ett fel i webbläsaren.</p>

<p>Nu kan vi testa för SNI och hantera brist på stöd på ett elegant sätt. Julen är räddad!</p>

<p>Dock, vad vi egentligen har åstadkommit är något klokare. Observera att koden egentligen inte testar för SNI, bara förmågan att säkert ladda bilden. Om HTTPS-URL:en i fråga inte kräver SNI, finns det bara ett certifikat eller det första certifikatet matchar den begärda domänen, fungerar det fortfarande. Problemet har reducerats till “Kan den här besökarens webbläsare visa den säkra webbplatsen eller inte?” och i slutändan är det allt vi bryr oss om.</p>

</div>
    </main>

    <footer>
      <hr>
<a href="/goto" name="goto">&mdash;&gt; gå till</a>
<blockquote>
<ul>
  <li>
    <a href="/about">om<a>
  </li>
  <li>
    <a href="mailto:i-hate-this@drawohara.io?subject=/multi-domain-https-with-server-name-indication">i-hate-this<a>
  </li>
  <li>
    <a href="mailto:i-love-this@drawohara.io?subject=/multi-domain-https-with-server-name-indication">i-love-this<a>
  </li>
  <li>
    <a href="/contact">kontakt<a>
  </li>
</ul>
</blockquote>
<a href="/">&lt;&mdash; avsluta</a>
    </footer>
  </body>
</html>