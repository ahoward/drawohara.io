<html color-mode="user" lang="es">
  <head>
    <base href='/es' />
    <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DQVD9T27V4');
    </script>

    <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

    <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- meta -->
    <title>Consejos para Migraciones de MongoDB en Rails</title>

    <meta property="og:title" content="Consejos para Migraciones de MongoDB en Rails"/>
    <meta property="og:description" content="sigue adelante." />
    <meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

    <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archivo/:id"">
    <meta property="site:params" content="{"ext":null,"id":"consejos-para-migraciones-de-mongodb-en-rails"}">
    <meta property="site:path_info" content=""/consejos-para-migraciones-de-mongodb-en-rails"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) {
          progressBar.remove();
        }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/inicio">@drawohara</a>
      <hr>
    </header>

    <main>
      <p>Quise compartir un método rápido y fácil para probar migraciones de Rails cuando se usa la base de datos MongoDB. La flexibilidad de mongo y ruby hace que esto sea bastante sencillo. En este ejemplo, estaremos renombrando un campo en nuestra colección de ejemplo "libros" de "isbn" a "número_de_libro". Este es un tipo de migración bastante común y, una vez que domines este caso sencillo, las migraciones más complejas siguen el mismo patrón. Primero, generemos nuestro script de plantilla de migración con marca de tiempo.</p>
      <pre><code>rails generate migration renombrar_isbn_a_numero_de_libro
</code>
</pre>
      <p>Luego editaremos el archivo que se generó en <code>db/migrate</code>. Dividiremos nuestro código en varias secciones de la siguiente manera.</p>
      <ol>
        <li>Algunas constantes de clase compartidas por todos los métodos</li>
        <li>El método <code>self.up</code> que realiza la migración hacia adelante</li>
        <li>Un método auxiliar para configurar algunos datos de muestra para probar la migración hacia adelante</li>
        <li>El método <code>self.down</code> que realiza el rollback</li>
        <li>Un método auxiliar para configurar algunos datos de muestra (si es necesario) para probar el rollback</li>
      </ol>
      <p>Primero, solo define algunas constantes que usarán nuestros métodos. Almacenamos el hash de opciones de actualización de mongo <code>MultiUpdate</code> por conveniencia, ya que la mayoría de las operaciones de actualización de migración quieren upsert false (no crear ningún documento nuevo), multi true (actualizar todos los documentos coincidentes) y safe true.</p>
      <p>Luego también definimos una constante para el nombre de la colección. Para la migración real, la colección es "libros", pero para las pruebas, crearemos una nueva colección llamada "test_libros_migración" a medida que desarrollamos nuestro código.</p>
      <pre><code>class RenombrarIsbnANumeroDeLibro < Mongoid::Migration
  MultiUpdate = {:upsert => false, :multi => true, :safe=>true}
  Collection = db.collection("libros") #Código de producción final
  Collection = db.collection("test_libros_migración") #Solo para pruebas en la consola
  def up
  end

  def down
  end
end
</code>
</pre>
      <p>OK, ese es nuestro plantilla inicial. El siguiente paso es hacer una copia de seguridad de nuestra base de datos de desarrollo si hay algún dato allí que no queramos estropear accidentalmente. Luego comenzamos a codificar un pequeño método auxiliar para poblar nuestra colección de prueba con documentos falsos que se parezcan a lo que esperamos ver en producción, pero centrándonos solo en los campos relevantes para la migración. Agrega este método a tu clase de migración.</p>
      <pre><code>def datos_falsos_para_pruebas_up
  3.times {|number| Collection.insert({"isbn" => "#{number}"})}
end

def mostrar_colección
  Collection.find({}).each {|_| puts _}
end
</code>
</pre>
      <p>Esto creará 3 documentos falsos que podemos usar para las pruebas. Estamos colocando este código en un método para que sea fácil de volver a ejecutar a medida que ajustamos y probamos nuestro código de migración. Para migraciones complejas, pueden ser necesarias muchas rondas de ajustes para abordar todos los casos límite.</p>
      <p>Ahora podemos iniciar una consola de rails y ejecutar este código copiando y pegando las 2 constantes de clase y el método datos_falsos_para_pruebas_up en la consola y luego ejecutando datos_falsos_para_pruebas_up</p>
      <pre><code>$ bundle exec rails console
Cargando entorno de desarrollo (Rails 3.1.1)
irb(main):001:0> #Pega lo siguiente en la consola
MultiUpdate = {:upsert => false, :multi => true, :safe=>true}
Collection = db.collection("test_libros_migración") #Solo para pruebas en la consola
def datos_falsos_para_pruebas_up
  3.times {|number| Collection.insert({"isbn" => "#{number}"})}
  Collection.find({}).each {|_| puts _}
end
def mostrar_colección
  Collection.find({}).each {|_| puts _}
end
irb(main):008:0> datos_falsos_para_pruebas_up
datos_falsos_para_pruebas_up
MONGODB app_development['test_libros_migración'].insert([{"isbn"=>"0", :_id=>BSON::ObjectId('4ef5f43b2a4397a5d7000001')}])
MONGODB app_development['test_libros_migración'].insert([{"isbn"=>"1", :_id=>BSON::ObjectId('4ef5f43b2a4397a5d7000002')}])
MONGODB app_development['test_libros_migración'].insert([{"isbn"=>"2", :_id=>BSON::ObjectId('4ef5f43b2a4397a5d7000003')}])
irb(main):009:0> mostrar_colección
MONGODB app_development['test_libros_migración'].find({})
{"_id"=>BSON::ObjectId('4ef5f3812a4397a5bd000001'), "isbn"=>"0"}
{"_id"=>BSON::ObjectId('4ef5f3812a4397a5bd000002'), "isbn"=>"1"}
{"_id"=>BSON::ObjectId('4ef5f3812a4397a5bd000003'), "isbn"=>"2"}
=> nil
</code>
</pre>
      <p>Entonces, ahora tenemos una colección de prueba separada y bien entendida lista para probar nuestra migración simple. Codifiquemos nuestro método <code>up</code>. Para hacer nuestra migración.</p>
      <pre><code>def up
  #Queremos renombrar el campo libro.isbn a libro.número_de_libro
  Collection.find({"isbn" => {"$exists" => 1}}).each do |libro|
    update_op = {
      "$unset" => {"isbn" => 1},
      "$set" => {"número_de_libro" => libro["isbn"]}
    }
  Collection.update({"_id" => libro["_id"]}, update_op, MultiUpdate)
end
</code>
</pre>
      <p>Podemos pegar eso en la consola y ejecutarlo para probar nuestra migración. Podemos verificar los resultados con <code>mostrar_colección</code>. Si queremos probar otros registros para el rollback, podemos crear un método <code>datos_falsos_para_pruebas_down</code>.</p>
      <p>Esto debería darte una forma realmente rápida de experimentar y hacer que tu código de migración funcione. Mongo tiene algunas capacidades avanzadas de consulta y modificación que pueden hacer cosas asombrosas, y una forma fácil de hacer algunas pruebas y errores es útil. Si haces un desastre con tus datos de prueba, puedes usar <code>Collection.drop</code> para obtener un lienzo limpio. Aquí tienes el código de migración final para referencia. <strong>No olvides</strong> eliminar la constante de la colección de prueba y eliminar la colección de prueba de tu base de datos cuando estés listo para comenzar a ejecutar tu código en serio con <code>rake db:migrate</code>.</p>
      <pre><code>class RenombrarIsbnANumeroDeLibro < Mongoid::Migration
  MultiUpdate = {:upsert => false, :multi => true, :safe=>true}
  Collection = db.collection("libros") #Código de producción final

  def up
    #Queremos renombrar el campo libro.isbn a libro.número_de_libro
    Collection.find({"isbn" => {"$exists" => 1}}).each do |libro|
      update_op = {
        "$unset" => {"isbn" => 1},
        "$set" => {"número_de_libro" => libro["isbn"]}
      }
      Collection.update({"_id" => libro["_id"]}, update_op, MultiUpdate)
    end
  end

  def down
    #Queremos renombrar el campo libro.número_de_libro a libro.isbn
    Collection.find({"número_de_libro" => {"$exists" => 1}}).each do |libro|
      update_op = {
        "$unset" => {"número_de_libro" => 1},
        "$set" => {"isbn" => libro["número_de_libro"]}
      }
      Collection.update({"_id" => libro["_id"]}, update_op, MultiUpdate)
    end
  end

  #Estos métodos no son llamados por la migración. Solo para pruebas manuales
  #por copiar/pegar en la consola
  #Para probar (copiando/pegando desde aquí a la consola)
  #1. Establece la constante MultiUpdate. Ajusta "Collection" para que sea una colección de prueba
  #2. Copia/pega los 2 métodos a continuación
  #2. Ejecuta datos_falsos_para_pruebas_up
  #3. Ejecuta el cuerpo de self.up
  #3b. Opcionalmente, ejecuta el cuerpo de self.up nuevamente para asegurarte de que sea idempotente
  def datos_falsos_para_pruebas_up
    3.times {|number| Collection.insert({"isbn" => "#{number}"})}
  end

  def mostrar_colección
    Collection.find({}).each {|_| puts _}
  end
end
</code>
</pre>
    </main>

    <footer>
      <hr>
      <a href="/ir" name="ir">&mdash;&gt; ir</a>
      <blockquote>
        <ul>
          <li>
            <a href="/sobre">sobre</a>
          </li>
          <li>
            <a href="mailto:odio-esto@drawohara.io?subject=/consejos-para-migraciones-de-mongodb-en-rails">odio-esto</a>
          </li>
          <li>
            <a href="mailto:me-encanta-esto@drawohara.io?subject=/consejos-para-migraciones-de-mongodb-en-rails">me-encanta-esto</a>
          </li>
          <li>
            <a href="/contacto">contacto</a>
          </li>
        </ul>
      </blockquote>
      <a href="/">&lt;&mdash; salir</a>
    </footer>
  </body>
</html>