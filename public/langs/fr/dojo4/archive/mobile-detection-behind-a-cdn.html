<html color-mode="user" lang="fr">
  <head>
  <base href='/fr' />
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DQVD9T27V4');
</script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

  <!-- meta -->
    <title>Détection mobile derrière un CDN</title>

<meta property="og:title" content="Détection mobile derrière un CDN"/>
<meta property="og:description" content="passez votre chemin." />
<meta property="og:image" content="https://drawohara.io/media/mick.jpg" />


  <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"mobile-detection-behind-a-cdn"}">
    <meta property="site:path_info" content=""/mobile-detection-behind-a-cdn"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) {
          progressBar.remove();
        }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/accueil">@drawohara</a>
<hr>
    </header>

    <main>
      <div class="ro markdown">
  <p>Lors d'un projet récent, nous avons été chargés de créer la version mobile d'un site web existant. Le site web existant n'était pas vraiment un bon candidat pour une conception réactive, nous avons donc décidé de créer une toute nouvelle version du site pour les appareils mobiles.</p>

<p>![5547851770<em>3598506559_z.jpg](assets/b.jpeg)<br />
_(photo par <a href="https://www.flickr.com/photos/johanl/5547851770/in/photolist-9sfc3J-63nmeT-3BAAy-dWUBhB-pAZUn-ccjB1w-st5Gc-7B2UEE-bbLNKX-8yTj9M-9e6jeJ-72jTj6-8RU8QS-5TNHyH-8FkSqy-5r7dgL-5A6ymJ-atHdpQ-7BbKMK-8P8X2-7bD7t6-2ViX1A-5E6qqL-6NDF76-9hBh7m-4bSRnn-sZomP-6VbEE-buapa2-5Kw5si-85KrwR-5kpSzg-bjEUUE-bV9J19-5GXRmg-6zbLPt-8yWpiA-akq64F-5n4ciA-9hmSj5-msHvhK-hZpPt-bFe25b-Bjwzo-mFYCVT-d3v8y-6wRQrs-f1p7uv-f8rrUJ-ebxiKS">Johan Larsson</a>)</em></p>

<p>Au début, nous pensions utiliser le modèle m.example.com, où les sites sont des domaines entièrement séparés. Cependant, comme nous ne gérons pas l'infrastructure de ce site, nous souhaitions opter pour une approche nécessitant le moins de changements d'infrastructure possible. La prise en charge d'un autre domaine sur les mêmes serveurs n'est pas très difficile, mais c'est une autre tâche qui est facile à rater et qui n'est pas nécessaire dans notre cas.</p>

<p>J'ai également publié cette technique pour que tout le monde puisse l'utiliser facilement dans une application rails via un moteur rails :</p>

<ul>
  <li>https://github.com/milesmatthias/cdddn</li>
  <li>http://rubygems.org/gems/cdddn</li>
</ul>

<h2 id="intro-to-cloudfront">Introduction à CloudFront</h2>

<p>Un énorme avantage de ce site web particulier est qu'il utilise <a href="http://aws.amazon.com/cloudfront/">CloudFront</a>. CloudFront est un réseau de distribution de contenu (ou CDN), où les pages web statiques sont hébergées dans <a href="http://aws.amazon.com/cloudfront/details/">52 centres de données dans le monde entier</a>. Cela permet à la page d'être servie au navigateur aussi rapidement que possible car, où que vous soyez dans le monde, vous ne serez pas loin d'un des nœuds de CloudFront, ce qui prendra moins de temps pour que le site web soit livré à votre appareil. CloudFront fait partie de l'offre AWS d'Amazon et, en plus de garantir la vitesse, ils garantissent le temps de disponibilité. (Contrairement à <a href="http://aws.amazon.com/s3/">S3</a>, où seule la disponibilité est garantie.)</p>

<p>Lorsque vous utilisez CloudFront, vous lui indiquez où se trouve votre serveur web afin que CloudFront puisse obtenir la dernière version des pages web qu'il sert pour vous. CloudFront ne demande également à votre serveur web de nouvelles versions de vos pages web que toutes les quelques minutes, ou quel que soit l'intervalle de temps que vous configurez dans votre tableau de bord CloudFront. Normalement, c'est quelque part autour de 24 heures. Cela permet à CloudFront de se concentrer sur la disponibilité et la vitesse, tout en réduisant considérablement la charge sur votre serveur web. (Cela prend également du temps pour que CloudFront prenne une nouvelle version d'une page et mette à jour les 52 centres de données.)</p>

<p>Cependant, cela introduit le problème de suivre l'état. Par exemple, si votre site est entièrement servi par CloudFront, comment gérez-vous les utilisateurs qui se connectent à votre site ? Si je suis un utilisateur nommé Bob et que la page à <code>/mon/compte</code> dit « Bonjour Bob ! », CloudFront pensera que tout le monde qui demande la page à <code>/mon/compte</code> devrait voir la version de la page qui dit « Bonjour Bob ! ». Les utilisateurs (à l'exception peut-être des personnes nommées Bob...) seront très confus. Non seulement cela, mais que se passe-t-il si un utilisateur met à jour une valeur dans son compte et s'attend à ce que ce changement s'affiche instantanément ? CloudFront n'obtient pas une nouvelle version de la page à chaque demande (ce qui détruirait en quelque sorte l'objectif de CloudFront), il attend quelques minutes pour obtenir une nouvelle version. CloudFront a abordé plusieurs de ces questions avec <a href="http://aws.amazon.com/cloudfront/dynamic-content/">de nouvelles fonctionnalités</a>, mais vous devez être conscient de ces implications lors de l'utilisation de CloudFront.</p>

<p>Dans notre cas, le site sur lequel nous travaillons n'a pas le concept d'« utilisateurs » et personne ne peut se connecter au système. Cependant, nous voulons toujours que CloudFront montre différentes versions du site en fonction de l'appareil à partir duquel vous demandez le site (mobile par rapport à bureau).</p>

<p>CloudFront peut effectuer la détection d'appareil pour vous, puis envoyer un en-tête spécial à votre serveur web pour dire « Donnez-moi la version de la page pour un téléphone », cependant nous voulions contrôler la méthode de détection d'appareil (répondre à la question - est-ce un téléphone ou un bureau ?) et nous voulions la possibilité pour les utilisateurs finaux et les développeurs de remplacer l'appareil choisi pour eux. Par exemple, les utilisateurs finaux sur une tablette peuvent simplement vouloir voir la version bureau même si nous leur montrons initialement la version mobile. Nos développeurs trouveront également cela encombrant de changer leur appareil chaque fois qu'ils souhaitent passer entre les versions lors de la construction du site.</p>

<h2 id="our-solution">Notre solution</h2>

<p>Voici donc la méthode que nous avons inventée pour avoir à la fois une version bureau et mobile d'un site sur le même domaine et servie par CloudFront. Une note requise est que CloudFront désactive normalement tous les cookies pour votre domaine, mais vous pouvez le configurer pour autoriser les cookies que vous nommez. Dans notre cas, nous avons dit à CloudFront d'autoriser un cookie appelé 'appareil'. Notez également que nous sommes dans le contexte d'une application rails 4, mais cette architecture peut être reproduite dans n'importe quelle pile. Le point principal ici est que le client doit déterminer quel appareil l'utilisateur utilise, lui permettre de le remplacer, et garder le serveur informé du type d'appareil afin que le serveur puisse servir les bonnes pages (cela est fait via des cookies).</p>

<h3 id="on-every-page-we-need-to-do-something-like-this-snippet-from-appviewslayoutapplicationhtmlerb">Sur chaque page, nous devons faire quelque chose comme ceci (extrait de app/views/layout/application.html.erb)</h3>

<pre><code class="language-html+erb">&lt;%= javascript_include_tag "mobile_detection" %&gt;

&lt;script&gt;

  if (!window.location.href.match(/get_device|set_device/)){
    console.log('logging the window.location.href = ' + window.location.href);
    localStorage.setItem('referrer_href', window.location.href);
  }

  var device_cookie  = cookie.get('device'),
      cookiesEnabled = cookie.enabled();

  if (cookiesEnabled &amp;&amp; device_cookie == undefined) {
    window.location = '/get_device.html'
  }

&lt;/script&gt;
</code></pre>

<p>Le code ci-dessus se souvient simplement de la page sur laquelle vous avez atterri (généralement la page d'accueil, mais nous voulons que le client puisse partager des liens et que cela fonctionne également sur mobile), puis vous redirige vers la page <code>/get_device</code> pour détecter votre appareil si nous n'avons pas encore fait cela. Notez l'utilisation de <code>localStorage</code>, ce qui signifie que cela ne fonctionnera que sur IE8+ et ne fonctionnera pas sur Opera Mini.</p>

<p>Notez également que l'extrait de code ci-dessus est placé dans le <code>&lt;head&gt;</code> de la mise en page afin qu'il soit exécuté dès que possible et avant tout script que la version bureau pourrait avoir. Dans ce cas, la version bureau utilise beaucoup de javascript pour charger beaucoup de contenu, donc nous ne voulions vraiment pas que tout cela se produise sur un téléphone avant que le site ne reconnaisse que l'utilisateur devrait voir la version mobile du site.</p>

<h3 id="on-every-mobile-page-we-need-to-do-this-from-appviewslayoutapplicationmobileerb">Sur chaque page mobile, nous devons faire ceci (à partir de `app/views/layout/application.mobile.erb):</h3>

<div class="language-js highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #24292f;background-color: #f6f8fa">script</span><span style="color: #0550ae">&gt;</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">device_cookie</span>&nbsp;&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">get</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">device</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">),</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookiesEnabled</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">enabled</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
</div><div class='code-line code-line-4'>&nbsp;
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">if </span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">cookiesEnabled</span>&nbsp;<span style="color: #0550ae">&amp;&amp;</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">device_cookie</span>&nbsp;<span style="color: #0550ae">==</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">desktop</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">)</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">reload</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">true</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #116329">/script</span><span style="color: #f6f8fa;background-color: #82071e">&gt;</span>
</div></code></div>

<p>C'est parce que les appareils mobiles mettent fortement en cache les pages (ce qui est logique) donc si l'utilisateur a changé l'appareil qu'il utilise, nous devons nous assurer d'envoyer ce cookie mis à jour au serveur même si l'URL n'a pas changé (et donc le cache pense que c'est la même page qui doit être servie). Le <code>true</code> dans l'appel de fonction <code>reload</code> indique au navigateur d'ignorer ce qui se trouve dans le cache.</p>

<p>Notez que nous faisons exactement la même chose sur chaque page bureau, à l'exception de la vérification pour voir si l'utilisateur a changé son appareil en <code>'mobile'</code>.</p>

<h3 id="device-detection-at-get_device-appviewshomeget_devicehtml">Détection d'appareil à <code>/get_device</code> (app/views/home/get_device.html)</h3>

<div class="language-js highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #24292f;background-color: #f6f8fa">script</span><span style="color: #0550ae">&gt;</span>
</div><div class='code-line code-line-2'>&nbsp;
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">function</span>&nbsp;<span style="color: #8250df">isMobile</span><span style="color: #24292f;background-color: #f6f8fa">(){</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">MOBILE_USER_AGENTS</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">palm|blackberry|nokia|phone|midp|mobi|symbian|chtml|ericsson|minimo|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">audiovox|motorola|samsung|telit|upg1|windows ce|ucweb|astel|plucker|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">x320|x240|j2me|sgh|portable|sprint|docomo|kddi|softbank|android|mmp|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">pdxgw|netfront|xiino|vodafone|portalmmm|sagem|mot-|sie-|ipod|up</span><span style="color: #0a3069">\\</span><span style="color: #0a3069">.b|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">webos|amoi|novarra|cdm|alcatel|pocket|ipad|iphone|mobileexplorer|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">mobile|zune</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">mobile_regex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">new</span>&nbsp;<span style="color: #953800">RegExp</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">MOBILE_USER_AGENTS</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">i</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-11'>&nbsp;
</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">return</span>&nbsp;<span style="color: #953800">navigator</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">userAgent</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">match</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">mobile_regex</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-13'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
</div><div class='code-line code-line-14'>&nbsp;
</div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// définition du cookie d'appareil sur ce que nous détectons</span>
</div><div class='code-line code-line-16'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">detected_device</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #8250df">isMobile</span><span style="color: #24292f;background-color: #f6f8fa">()</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">?</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">mobile</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">:</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">desktop</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-17'>&nbsp;
</div><div class='code-line code-line-18'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">set</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">device</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">detected_device</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-19'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #116329">domain</span><span style="color: #24292f;background-color: #f6f8fa">:</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">&lt;%= Rails.env.development? ? </span><span style="color: #0a3069">''</span><span style="color: #0a3069"> : Settings.host %&gt;</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
</div><div class='code-line code-line-20'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #116329">path</span>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">:</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">/</span><span style="color: #0a3069">'</span>
</div><div class='code-line code-line-21'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8