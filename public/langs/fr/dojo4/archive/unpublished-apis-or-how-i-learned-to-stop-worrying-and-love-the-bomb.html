<html color-mode="user" lang="fr">
  <head>
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DQVD9T27V4');
</script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

  <!-- meta -->
    <title>APIs non publiées ou, Comment j'ai appris à cesser de m'inquiéter et à aimer la bombe.</title>

<meta property="og:title" content="APIs non publiées ou, Comment j'ai appris à cesser de m'inquiéter et à aimer la bombe."/>
<meta property="og:description" content="circulez." />
<meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

  <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"unpublished-apis-or-how-i-learned-to-stop-worrying-and-love-the-bomb"}">
    <meta property="site:path_info" content=""/unpublished-apis-or-how-i-learned-to-stop-worrying-and-love-the-bomb"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) {
          progressBar.remove();
        }
      });
    </script>
    <base href='/fr' />
  </head>

  <body>
    <header>
      <a href="/accueil">@drawohara</a>
<hr>
    </header>

    <main>
      <div class="ro markdown">
  <p>Parfois, vous avez une tâche en ligne répétitive ennuyeuse ou vous devez automatiser tout ou partie d'un flux de travail sur un site Web. Le script de ces interactions peut nous empêcher de gaspiller des tonnes d'heures-hommes à cliquer de manière monotone sur les mêmes pages d'un site.</p>

<p>Beaucoup d'entre nous vont immédiatement se tourner vers <a href="http://mechanize.rubyforge.org/">Mechanize</a>. Ensuite, vous constatez que l'interface du site que vous essayez d'automatiser une tâche est lourde en JavaScript ou en AJAX. Que faire maintenant ?</p>

<p><a href="http://http://phantomjs.org/">Phantomjs</a> à la rescousse. Phantomjs est un navigateur WebKit rapide, facilement scriptable et sans tête. Lorsque le travail échoue pour une raison quelconque, vous pouvez prendre une capture d'écran pour examen. Pour nous, cela signifiait l'envoyer par e-mail à un administrateur puisque les tâches sont exécutées sur des serveurs et non localement. Nous utilisons également <a href="https://github.com/westoque/phantomjs.rb">Phantomjs.rb</a> pour gérer le chemin et la sortie de Phantomjs.</p>

<p>Voici un peu de code de ce que nous faisons.</p>

<pre><code>class InvitationAcceptor
  attr_accessor :invitation, :tmpdir

  def initialize(invitation)
    self.invitation = invitation
  end

  def accept!
    fail_image_path = false

    Dir.mktmpdir(invitation.id.to_s) do |tmpdir|
      self.tmpdir = tmpdir

      Phantomjs.inline(js) do |line|
        puts line
        fail_image_path = line.gsub('FAIL:', '').chomp if line.starts_with?('FAIL')
      end

      if fail_image_path
        Mailer.invitaion_failed(invitation, fail_image_path).deliver
      else
        invitation.invitation_accepted!
      end
    end
  end

  private

    def js
      fail_image = "#{tmpdir}/failed.png"

      &lt;&lt;-JS
        // https://github.com/ariya/phantomjs/blob/master/examples/waitfor.js
        function waitFor(testFx, onReady, timeOutMillis) {
          var maxtimeOutMillis = timeOutMillis ? timeOutMillis : 10000,
            start = new Date().getTime(),
            condition = false
          var interval = setInterval(function() {
            if ((new Date().getTime() - start &lt; maxtimeOutMillis) &amp;&amp; !condition) {
              condition = (typeof(testFx) === "string" ? eval(testFx) : testFx());
            } else {
              if (! condition) {
                fail()
              } else {
                console.log("'waitFor()' waited " + (new Date().getTime() - start) + "ms.");
                typeof(onReady) === "string" ? eval(onReady) : onReady();
                clearInterval(interval);
              }
            }
          }, 250);
        };

        var page = require('webpage').create(),
          testindex = 0,
          loadInProgress = false,
          tries = 0;

        // ceci est important pour notre application car le site que nous automatisons essaie de bloquer l'automatisation.
        page.settings.userAgent = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.116 Safari/537.36'

        var fail = function() {
          // envoyer le message d'échec et le chemin de l'image au script Ruby
          console.log("FAIL:#{fail_image}");
          // enregistrer la capture d'écran sur le système de fichiers afin qu'elle puisse être envoyée par e-mail
          page.render("#{fail_image}");
          phantom.exit()
        }

        page.onConsoleMessage = function(msg) {
          console.log(msg);
        };

        page.onLoadStarted = function() {
          loadInProgress = true;
          console.log("load started");
        };

        page.onLoadFinished = function(status) {
          loadInProgress = false;
          console.log("load finished");
        };

        var steps = [
          function() {
            console.log("Load Login Page");

            page.open("#{invitation.invitation_received.subject}")
          },
          function() {
            console.log("Vérifiez que l'invitation est toujours valide");

            success = page.evaluate(function() {
              if (null == document.getElementById('hasSomeElement')) {
                return false;
              }

              return true;
            })

            if (! success) {
              fail();
            }

          },
          function() {
            console.log("Entrer les informations d'identification");

            page.evaluate(function() {
              document.getElementById('hasSomeElement').checked;
              document.getElementById('hasSomeElement').checked;
              document.getElementById('email').value = '#{invitation.email}';
              document.getElementById('password').value = '#{invitation.password}';
              document.getElementById('login').click();
            });
          },
          function() {
            console.log("Accepter les conditions");

            page.evaluate(function() {
              document.getElementById('accept').click()
            });
          },
          function() {
            console.log("Attendre que la folie JS soit terminée");

            waitFor(function() {
              return page.evaluate(function() {
                return document.getElementsByClassName('someExpectedContent').length != 0
              });
            }, function() {
              phantom.exit();
            });
          }
        ]

        interval = setInterval(function() {
          if (!loadInProgress &amp;&amp; typeof steps[testindex] == "function") {
            steps[testindex]();
            // utile pour le débogage
            page.render("#{tmpdir}/step" + (testindex + 1) + ".png");
            testindex++;
          }
        }, 250);
      JS
    end

end
</code></pre>

<p>Vous pouvez également injecter des scripts dans la page, avec <a href="http://phantomjs.org/api/webpage/method/inject-js.html">injectJs</a> ou <a href="http://phantomjs.org/api/webpage/method/include-js.html">includeJs</a> mais je préfère m'en tenir à ce qui est déjà là ou juste utiliser les bases pour éviter tout conflit avec ce qui peut déjà être dans la page.</p>

</div>
    </main>

    <footer>
      <hr>
<a href="/goto" name="goto">&mdash;&gt; aller à</a>
<blockquote>
<ul>
  <li>
    <a href="/à-propos">à propos<a>
  </li>
  <li>
    <a href="mailto:je-déteste-ça@drawohara.io?subject=/unpublished-apis-or-how-i-learned-to-stop-worrying-and-love-the-bomb">je-déteste-ça<a>
  </li>
  <li>
    <a href="mailto:j-adore-ça@drawohara.io?subject=/unpublished-apis-or-how-i-learned-to-stop-worrying-and-love-the-bomb">j-adore-ça<a>
  </li>
  <li>
    <a href="/contact">contact<a>
  </li>
</ul>
</blockquote>
<a href="/">&lt;&mdash; éjecter</a>
    </footer>
  </body>
</html>