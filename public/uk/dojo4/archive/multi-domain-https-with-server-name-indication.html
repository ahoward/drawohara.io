<html color-mode="user" lang="uk">
  <head>
    <base href='/uk' />
    <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DQVD9T27V4');
    </script>

    <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

    <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- meta -->
    <title>Мульти-доменний HTTPS з Індикацією Імені Сервера</title>

    <meta property="og:title" content="Мульти-доменний HTTPS з Індикацією Імені Сервера"/>
    <meta property="og:description" content="рухайтесь далі." />
    <meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

    <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content="/dojo4/archive/:id">
    <meta property="site:params" content='{"ext":null,"id":"multi-domain-https-with-server-name-indication"}'>
    <meta property="site:path_info" content="/multi-domain-https-with-server-name-indication">

    <style>
      /* проти pico */
      a {text-decoration: none !important; }

      /* проти turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* проти progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) {
          progressBar.remove();
        }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a>
      <hr>
    </header>

    <main>
      <div class="ro markdown">
        <p>(Це скорочена версія <a href="http://www.stuff-things.net/2014/11/14/yes-virginia-you-can-use-sni/">Так, Вірджинія, Ви можете використовувати SNI</a>, яка спочатку з'явилася в блозі Spike's <a href="http://www.stuff-things.net/">Речі… та ще Речі…</a>)</p>

        <p>Коли Ви підключаєтесь до веб-сервера захищено за допомогою HTTPS, безпека забезпечується за допомогою <a href="http://uk.wikipedia.org/wiki/Transport_Layer_Security">TLS</a>. Відбувається дві речі: перевіряється ідентичність сервера і з'єднання шифрується.</p>

        <p>Перевірка є важливою, не має значення, чи з'єднання зашифроване, якщо Ви якимось чином були перенаправлені на сервер злочинця. Однак, така перевірка може бути проблемою, якщо веб-сервер обслуговує більше одного імені хоста.</p>

        <p>Ви можете прочитати <a href="http://uk.wikipedia.org/wiki/Transport_Layer_Security#TLS_handshake">подробиці</a>, але спрощена версія процесу виглядає так: сервер надсилає підписаний <a href="http://uk.wikipedia.org/wiki/Public_key_certificate">Публічний ключовий сертифікат</a>, який повинен відповідати імені хоста в URL. Якщо клієнт відвідує dojo4.com, то сертифікат повинен бути для dojo4.com, якщо він інший, браузер виводить велике лякаюче повідомлення.</p>

        <p>Технічно можливо мати кілька імен хостів на одному сертифікаті, фактично це звичайно мати, наприклад, і "dojo4.com", і "www.dojo.com", для повноти. Однак, це є величезним болем у задниці для додавання та видалення імен хостів із сертифіката. Ви повинні звернутися до видавця для генерування нового сертифіката та відкликання старого. І якщо Ви працюєте з Мережею Доставки Контенту, вони дуже малоймовірно додадуть Ваші імена хостів до їхнього сертифіката.</p>

        <p>Спочатку TLS підтримував один сертифікат на веб-сервер (або точніше, на IP-адресу, прикріплену до веб-сервера) <a href="http://uk.wikipedia.org/wiki/Server_Name_Indication">Індикація Імені Сервера (SNI)</a> була додана до TLS для вирішення цієї проблеми. На початку переговорів TLS клієнт повідомляє серверу ім'я хоста, до якого він намагається підключитися, і сервер може обрати та надіслати правильний файл сертифіката. Проблема вирішена!</p>

        <p>Окрім... Не всі браузери підтримують SNI. Всі <em>знають</em> це, і в результаті схильні пропустити SNI та перейти до спеціальних IP для кожного сайту або навіть кількох серверів. Це є дорогим варіантом, особливо при роботі з CDN, такими як CloudFront. Коли це виникло для мене, я вирішив дізнатися, що означає "не всі браузери".</p>

        <p>Виявляється, SNI широко підтримується, з великими проблемами в IE8 та нижче, а також у будь-якої версії IE, що працює на Windows XP (оскільки підлегла бібліотека ОС не підтримує SNI). Також існують деякі старі версії Android, які не підтримують це.</p>

        <p>Таким чином, більшість відвідувачів не матимуть жодних проблем з SNI, а група, яка буде мати, достатньо мала, щоб ми могли обробляти їх як спеціальний випадок.</p>

        <p>Для браузерів без підтримки SNI варіант полягає у перенаправленні їх на сертифікат, який буде працювати, або на грубу сторінку "оновіть свій браузер". Якщо пошукаєте в Google, Ви знайдете купу рішень для створення білих списків хороших браузерів і/або чорних списків поганих, а потім використання цих списків у правилах перенаправлення на стороні сервера. Потворно. Списки потрібно підтримувати, і залежно від сервера вони порушують кешування.</p>

        <p>Є розумніший спосіб. Проходячи через море конфігурацій перенаправлення Apache, я знайшов це в <a href="https://www.ebower.com/wiki/Detecting_SNI_with_Apache">пості</a>. Основна ідея посту може бути зведена до цього: якщо браузер, який не підтримує SNI, намагається завантажити вміст SNI, він отримає помилку. Якщо ми тестуємо це на задньому плані та диференціюємо між помилкою та успіхом, ми можемо перенаправити відвідувача відповідно. А найпростіший спосіб зробити це - спробувати додати зображення одного пікселя на сторінку.</p>

        <p>У коді це виглядає так:</p>

        <div class="language-javascript highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #cf222e">function</span>&nbsp;<span style="color: #8250df">secure_redirect</span><span style="color: #24292f;background-color: #f6f8fa">()</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
        </div><div class='code-line code-line-2'>&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #0550ae">=</span><span style="color: #953800">document</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">createElement</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">img</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>&nbsp;<span style="color: #6e7781">// створити елемент img.</span>
        </div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Встановити src на SNI URL зображення одного пікселя</span>
        </div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">src</span><span style="color: #0550ae">=</span><span style="color: #0a3069">'</span><span style="color: #0a3069">https://www.example.org/pixel.gif</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
        </div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Це виконується, якщо SNI працює.</span>
        </div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">onload</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">()</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
        </div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Перенаправлення на захищену сторінку.</span>
        </div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">href</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">https://example.org/</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
        </div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">};</span>
        </div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Це виконується, якщо SNI не працює.</span>
        </div><div class='code-line code-line-11'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">onerror</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #24292f;background-color: #f6f8fa">)</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
        </div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Перенаправлення в інше місце</span>
        </div><div class='code-line code-line-13'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">href</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">http://example.org/snarky-old-browser-message</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
        </div><div class='code-line code-line-14'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">};</span>
        </div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Не відображати зображення фактично</span>
        </div><div class='code-line code-line-16'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">style</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">display</span><span style="color: #0550ae">=</span><span style="color: #0a3069">'</span><span style="color: #0a3069">none</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
        </div><div class='code-line code-line-17'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// але додайте його до сторінок, щоб він завантажився.</span>
        </div><div class='code-line code-line-18'>&nbsp;&nbsp;&nbsp;<span style="color: #953800">document</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">body</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">appendChild</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
        </div><div class='code-line code-line-19'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
        </div></code></div>

        <p>Тут я використовую два HTML-callback на тезі <em>img</em>, 'OnLoad', який спрацьовує, коли завантаження зображення закінчується, і 'OnError', який спрацьовує, якщо зображення не можливо завантажити. Якщо браузер не підтримує SNI, зображення не вдасться завантажити через помилку сертифіката, спрацює 'OnError'. Однак, оскільки ми додаємо зображення до вже завантаженої сторінки, воно не викличе помилки в браузері.</p>

        <p>Тепер ми можемо перевіряти SNI та обробляти відсутність підтримки елегантно. Різдво врятовано!</p>

        <p>Однак, до чого ми дійсно прийшли, так це до чогось більш розумного. Зверніть увагу, що код фактично не перевіряє SNI, а лише можливість безпечного завантаження зображення. Якщо URL-адреса HTTPS не вимагає SNI, є лише один сертифікат або перший сертифікат відповідає запитуваному домену, все одно працює. Проблема була зведена до "Чи може цей браузер відвідувача відображати захищений сайт чи ні?", і в кінцевому рахунку, саме це нас і хвилює.</p>
      </div>
    </main>

    <footer>
      <hr>
      <a href="/goto" name="goto">&mdash;&gt; goto</a>
      <blockquote>
        <ul>
          <li>
            <a href="/about">про</a>
          </li>
          <li>
            <a href="mailto:i-hate-this@drawohara.io?subject=/multi-domain-https-with-server-name-indication">i-hate-this</a>
          </li>
          <li>
            <a href="mailto:i-love-this@drawohara.io?subject=/multi-domain-https-with-server-name-indication">i-love-this</a>
          </li>
          <li>
            <a href="/contact">контакт</a>
          </li>
        </ul>
      </blockquote>
      <a href="/">&lt;&mdash; eject</a>
    </footer>
  </body>
</html>