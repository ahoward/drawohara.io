<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>drawohara</title>

  

  <!-- favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

  <style>
    /* reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* layout */
    body {
      max-width: 42rem;
      margin: 2rem auto;
      padding: 0 1rem;
      font: 16px/1.8 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
      color: #333;
      background: #fff;
    }

    /* typography */
    h1, h2, h3, h4, h5, h6 {
      margin: 1.5rem 0 0.5rem;
      line-height: 1.2;
    }

    h1 { font-size: 2rem; }
    h2 { font-size: 1.5rem; }
    h3 { font-size: 1.25rem; }

    p, blockquote, ul, ol {
      margin: 1rem 0;
    }

    li {
      margin-left: 2rem;
    }

    blockquote {
      margin-left: 1rem;
      padding-left: 1rem;
      border-left: 2px solid #ddd;
      font-style: italic;
    }

    /* links */
    a {
      color: #0066cc;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    a:visited {
      color: #551a8b;
    }

    /* code */
    code, pre {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
      background: #f5f5f5;
    }

    code {
      padding: 0.1em 0.3em;
      font-size: 0.9em;
    }

    pre {
      padding: 1rem;
      overflow-x: auto;
      margin: 1rem 0;
    }

    pre code {
      padding: 0;
      background: none;
    }

    /* images */
    img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 1rem 0;
    }

    /* horizontal rule */
    hr {
      border: none;
      border-top: 1px solid #ddd;
      margin: 1rem 0;
    }

    /* header/footer */
    header {
      margin-bottom: 2rem;
    }

    footer {
      margin-top: 3rem;
      font-size: 0.9em;
      color: #666;
    }

    /* dark mode */
    @media (prefers-color-scheme: dark) {
      body {
        color: #ddd;
        background: #111;
      }

      a {
        color: #58a6ff;
      }

      a:visited {
        color: #a371f7;
      }

      code, pre {
        background: #222;
      }

      blockquote {
        border-left-color: #444;
      }

      hr {
        border-top-color: #333;
      }

      footer {
        color: #888;
      }
    }
  </style>
</head>

<body>
  <header>
    <a href="/">@drawohara</a>
<small>
  <a href="mailto:i-love-this@drawohara.io?subject=/resque-best-practices">‚ù§Ô∏è</a>
  ||
  <a href="mailto:this-makes-me-sad@drawohara.io?subject=/resque-best-practices">üíô</a>
</small>
<hr>
  </header>

  <main>
    <em>published on: 2012-07-16</em>
<br>
<br>
<div class="ro markdown">
  
<h2 id="introduction">Introduction</h2>

<p>Resque ( <a href="https://github.com/defunkt/resque" target="_blank">https://github.com/defunkt/resque</a> ) is a really nice, robust,
production quality background job facility for rails.  However, it leaves alot
of thinking for the developer to do regarding best practices for modeling your jobs, managing
deployments, and managing worker processes.  Following is a set of best
practices for using resque/redis as your background job system.</p>

<h2 id="managing-the-background-processes">Managing The Background Processes</h2>

<p>Resque has some facilities for managing background processes, but they are
cruftly and buggy.  We use this simple wrapper script to manage a single
instance of the background job daemon:</p>

<p><br />
<br /></p>

<script src="https://gist.github.com/3123756.js?file=jobs.rb"></script>

<p><br />
<br /></p>

<h2 id="modeling-your-jobs">Modeling Your Jobs</h2>

<p>One of the first thing to do is to determine how to model your jobs.  Resque
makes is pretty simple to submit arbitrary methods on modules, but we prefer
doing something a little more sanitary.  In particular we like having ids on
jobs, being able to query them easily, and making them uber durable in the
face of system or process failures.  By simply consolodating all job logic
into a single model that shadows the resque job this is quite possible.  Here
is our base job class.</p>

<p><br />
<br /></p>

<script src="https://gist.github.com/3123839.js?file=job.rb"></script>

<p><br />
<br /></p>

<p>As you can probably see, this class (which could easily be ported to ActiveRecord) allows submission of arbitrary jobs,
mailer or otherwise, and each job leaves a turd in the main database that ties
it to the resque/redis entry.  It makes working with jobs objects extremely natural  - for instance having a polling loop check the status of a particular job by id, or getting a quick count of how may jobs have succeeded in the last week.  It also keeps our resque install super vanilla - we don‚Äôt use any plugins - and makes it possible to drop in another background processing system in a matter of minutes.
About the only management it needs is a periodic task to to clean out the job
collection/table.  We use whenever( <a href="https://github.com/javan/whenever/" target="_blank">https://github.com/javan/whenever/</a> ) plus a rake
task to accomplish this:</p>

<p><br />
<br /></p>

<script src="https://gist.github.com/3123860.js?file=jobs.rake"></script>

<p><br />
<br /></p>

<script src="https://gist.github.com/3123860.js?file=schedule.rb"></script>

<p><br />
<br /></p>

<h2 id="deployment">Deployment</h2>

<p>Finally, your deployment needs to keep things going:</p>

<p><br />
<br /></p>

<script src="https://gist.github.com/3123860.js?file=Capfile.rb"></script>

<p><br /></p>

</div>
  </main>

  <footer>
    <hr>
<small>[ <a href="/io">io</a> | <a href="/jess">jess</a> | <a href="/contact">contact</a> | <a href="/cv">cv</a> ]</small>
  </footer>
</body>
</html>