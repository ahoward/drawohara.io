<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>drawohara</title>

  

  <!-- favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">

  <style>
    /* reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* layout */
    body {
      max-width: 42rem;
      margin: 2rem auto;
      padding: 0 1rem;
      font: 16px/1.6 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
      color: #333;
      background: #fff;
    }

    /* typography */
    h1, h2, h3, h4, h5, h6 {
      margin: 1.5rem 0 0.5rem;
      line-height: 1.2;
    }

    h1 { font-size: 2rem; }
    h2 { font-size: 1.5rem; }
    h3 { font-size: 1.25rem; }

    p, blockquote, ul, ol {
      margin: 0.5rem 0;
    }

    li {
      margin-left: 2rem;
    }

    blockquote {
      margin-left: 1rem;
      padding-left: 1rem;
      border-left: 2px solid #ddd;
      font-style: italic;
    }

    /* links */
    a {
      color: #0066cc;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    a:visited {
      color: #551a8b;
    }

    /* code */
    code, pre {
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
      background: #f5f5f5;
    }

    code {
      padding: 0.1em 0.3em;
      font-size: 0.9em;
    }

    pre {
      padding: 1rem;
      overflow-x: auto;
      margin: 1rem 0;
    }

    pre code {
      padding: 0;
      background: none;
    }

    /* images */
    img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 1rem 0;
    }

    /* horizontal rule */
    hr {
      border: none;
      border-top: 1px solid #ddd;
      margin: 1rem 0;
    }

    /* header/footer */
    header {
      margin-bottom: 2rem;
    }

    footer {
      margin-top: 3rem;
      font-size: 0.9em;
      color: #666;
    }

    /* dark mode */
    @media (prefers-color-scheme: dark) {
      body {
        color: #ddd;
        background: #111;
      }

      a {
        color: #58a6ff;
      }

      a:visited {
        color: #a371f7;
      }

      code, pre {
        background: #222;
      }

      blockquote {
        border-left-color: #444;
      }

      hr {
        border-top-color: #333;
      }

      footer {
        color: #888;
      }
    }
  </style>
</head>

<body>
  <header>
    <a href="/">@drawohara</a>
<small>
  <a href="mailto:i-love-this@drawohara.io?subject=/crap-developers-fear-mongo-and-worship-the-rdbms">‚ù§Ô∏è</a>
  ||
  <a href="mailto:this-makes-me-sad@drawohara.io?subject=/crap-developers-fear-mongo-and-worship-the-rdbms">üíô</a>
</small>
<hr>
  </header>

  <main>
    <em>published on: 2015-04-22</em>
<br>
<br>
<div class="ro markdown">
  <h3 id="tl-dr">TL; DR;</h3>

<blockquote>
  <p>99.9% of the web developer world believes that the correct usage of an RDBMS, along with transactions, prevents their applications from seeing bad data and introducing serious data quality errors.  They are <em>DEAD</em> <em>WRONG</em>.</p>
</blockquote>

<p>I read with great interest <a href="https://github.com/aphyr">Kyle Kingsbury‚Äôs</a> excellent article about Mongo‚Äôs consistency model at <a href="https://aphyr.com/posts/322-call-me-maybe-mongodb-stale-reads" target="_blank">https://aphyr.com/posts/322-call-me-maybe-mongodb-stale-reads</a></p>

<p>Obviously this guy is super switched on and knows his stuff.  He‚Äôs doing the work and everything about this article is insightful and well put together.</p>

<p>What I found astonishing, however, were the comments and what they reveal about the average professional developer:</p>

<blockquote>
  <p>Developers think using and RDBMS makes their data safe and they are <em>absolutely wrong</em></p>
</blockquote>

<p>I cannot tell you how many times I‚Äôve gotten into arguments with ‚Äòprofessional‚Äô developers and especially silly sysadmins that actually believe that, by simply saying the word RDBMS, spinning a chicken around their head 3 times, and connecting to the magical unicorn of DBs their data will be safe and sound like, you know, ‚Ä¶ (something something about) ‚Ä¶. banking transaction and all that (nonsense) dither about transactions and fsync.  And a bunch of other stuff no developer I‚Äôve ever met actually understands or has considered in the context of an HTTP (hint: stateless) application.</p>

<p>Before I proceed I‚Äôm going to issue a challenge:</p>

<ul>
  <li>Send me your github handle</li>
  <li>Let me pick a MySQL or PostgreSQL backed application you‚Äôve written (so you can‚Äôt prep it)</li>
  <li>And I will find code paths that supply both read-uncommitted and dirty-reads in your app within 1 day</li>
  <li>If there are none I will pay you <em>$1000 bucks</em></li>
  <li>If there are any I get to post any picture I choose of you as an addendum to this article.  Photoshop <em>is</em> allowed.</li>
</ul>

<p>Find me @ <a href="/contact">/contact</a> or <a href="/team/ara-t-howard">/team/ara-t-howard</a>.  Now on with it‚Ä¶</p>

<p>Riddle me this developer: what‚Äôs wrong with this code path:</p>

<div class="language-ruby highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;<span style="color: #0550ae">@db</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">transaction</span>&nbsp;<span style="color: #cf222e">do</span>
</div><div class='code-line code-line-3'>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">if</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">no_user_exists_with_conditions?</span>
</div><div class='code-line code-line-5'>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">@user</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">make_that_user_exists_with_those_conditions!</span>
</div><div class='code-line code-line-7'>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">deliver_an_activation_email_to!</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">@user</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">end</span>
</div><div class='code-line code-line-10'>
</div><div class='code-line code-line-11'>&nbsp;&nbsp;<span style="color: #cf222e">end</span>
</div><div class='code-line code-line-12'>
</div><div class='code-line code-line-13'>
</div></code></div>

<p>Let me reveal something earth shattering to you:</p>

<p><strong>THIS CODE IS TOTALLY BROKEN ON EVERY MAJOR <em>RDBMS</em>, AND VIRTUALLY EVERY
APPLICATION, IN THE WORLD</strong></p>

<p>I assure you that the email will go out <em>twice</em>.</p>

<p>Explaining transactions is beyond the scope of this article, but let me introduce you to ‚Äòphantom reads‚Äô</p>

<p><a href="http://en.wikipedia.org/wiki/Isolation_%28database_systems%29#Phantom_reads" target="_blank">http://en.wikipedia.org/wiki/Isolation_%28database_systems%29#Phantom_reads</a></p>

<p>In the above code a 2nd, concurrent, transaction can cause the following to happen:</p>

<div class="language-ruby highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;<span style="color: #0550ae">@db</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">transaction</span>&nbsp;<span style="color: #cf222e">do</span>
</div><div class='code-line code-line-3'>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">if</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">no_user_exists_with_conditions?</span>
</div><div class='code-line code-line-5'>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781"># meanwhile, a 2nd transaction has created a duplicate user...</span>
</div><div class='code-line code-line-7'>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781"># the following will will succeed, in __both__ transactions</span>
</div><div class='code-line code-line-9'>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">@user</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">make_that_user_exists_with_those_conditions!</span>
</div><div class='code-line code-line-11'>
</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781"># both transaction will deliver the email</span>
</div><div class='code-line code-line-13'>
</div><div class='code-line code-line-14'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">deliver_an_activation_email_to!</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">@user</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
</div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">end</span>
</div><div class='code-line code-line-16'>
</div><div class='code-line code-line-17'>&nbsp;&nbsp;<span style="color: #cf222e">end</span>
</div><div class='code-line code-line-18'>
</div><div class='code-line code-line-19'>&nbsp;&nbsp;<span style="color: #6e7781"># one of the transactions will fail to commit, and go *BOOM* but, by then,</span>
</div><div class='code-line code-line-20'>&nbsp;&nbsp;<span style="color: #6e7781"># it is too late: the email has been sent twice and the error has been  made</span>
</div><div class='code-line code-line-21'>
</div><div class='code-line code-line-22'>
</div></code></div>

<p>I know I know, you can‚Äôt believe it.  But that‚Äôs just because you never bothered to RTFM when it comes to what ‚Äòtransaction‚Äô means.  Start here:</p>

<p><a href="http://www.postgresql.org/docs/9.1/static/transaction-iso.html" target="_blank">http://www.postgresql.org/docs/9.1/static/transaction-iso.html</a></p>

<p>Note that little table.  Let me translate it for you:</p>

<ul>
  <li>
    <p>Because <em>you</em> don‚Äôt have every <em>single</em> sequence of <em>read&amp;write</em> wrapped in a transaction, and sometimes just sling code against your ORM objects directly, you suffer from the ‚Äòscary‚Äô reality of ‚Äòread-uncommitted‚Äô mentioned in the article</p>
  </li>
  <li>
    <p>Because <em>you</em> rely on the default isolation level you suffer from both non-repeatable-reads and phantom reads. (Do you even know what the default isolation is for your db and what that means????)</p>
  </li>
  <li>
    <p>Because <em>you</em> didn‚Äôt set your transaction level to ‚Äòserializable‚Äô you falsely believe your database is fast and safe.  You‚Äôve wrongly relied on the database to provide data integrity as an abstraction that does not require critical thinking and application code at least 10 times better than yours.  You have all the scary features of Kyle‚Äôs article in your RDBMS backed apps - and, not only do you <em>not know this</em> you are <em>pretty sure your data is ‚Äòsafe‚Äô</em></p>
  </li>
</ul>

<p>And so I ask you which is a worse engineering decision:</p>

<ul>
  <li>
    <p>Pick a standards based tool that everyone is <em>very</em> confident they understand and know how to use safely but, in it‚Äôs common usage, virtually never guarantees that which believe it promises and, furthermore, has been widely <a href="http://en.wikipedia.org/wiki/Isolation_%28database_systems%29#Default_isolation_level">critized as having ambiguous and inaccurate semantics</a> ?</p>
  </li>
  <li>
    <p>Or to accept what has always been true: that by themselves, databases cannot provide abstractions that mean non-extremely-clever developers can‚Äôt trivally screw things up. And that data integrity is a domain specific concept that must be implemented at the application layer, with only a small part of that integrity being aided by the choice of database.</p>
  </li>
</ul>

<p>ps.  I‚Äôve worked on large scale financial, realtime, and HA systems that use both Mongo and PostgreSQL.  It‚Äôs damn hard either way.</p>

<p>pss.  I tried to comment on your blog Kyle, but comments were blowing up ;-)</p>

<p><img src="https://s3.amazonaws.com/ss.dojo4.com/JKeSPdp46a4R3paZkp6oo7X1b7QNhI6hQN4kp1QPx3ZYqn3exRzqht0.png" style="max-width:200px;" /></p>

</div>
  </main>

  <footer>
    <hr>
<small>[ <a href="/cv">cv</a> | <a href="/io">io</a> | <a href="/jess">jess</a> | <a href="/contact">contact</a> ]</small>
<br>
2025
  </footer>
</body>
</html>