<html color-mode="user" lang="es">
  <head>
    <base href='/es' />
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DQVD9T27V4');
</script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

  <!-- meta -->
    <title>marshallar objeto mongoid como mantequilla</title>

<meta property="og:title" content="marshallar objeto mongoid como mantequilla"/>
<meta property="og:description" content="sigue adelante." />
<meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

  <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"marshal-mongoid-object-like-butter"}">
    <meta property="site:path_info" content=""/marshal-mongoid-object-like-butter"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) {
          progressBar.remove();
        }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a>
<hr>
    </header>

    <main>
      <div class="ro markdown">
  <p>Colocar tus modelos en la caché o serializarlos por otras razones no debería ser doloroso. Desafortunadamente, lo es con la mayoría de los ORM, ya que tienen una estrategia de marshalling deficiente por defecto. Sin embargo, esto es fácil de solucionar: la clave radica en entender que cada ORM ya sabe cómo tomar un hash de información de la base de datos e instanciar una instancia completa. Sabiendo esto, podemos hacer que cualquier modelo se serialice como mantequilla.</p>

<p><br /></p>

<div class="language-ruby highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #6e7781">#! /usr/bin/env ruby</span>
</div><div class='code-line code-line-2'>
</div><div class='code-line code-line-3'><span style="color: #6e7781"># algunos modelos tienen mierda rara que no sobrevive a un marshalling de ida y vuelta</span>
</div><div class='code-line code-line-4'><span style="color: #6e7781">#</span>
</div><div class='code-line code-line-5'>&nbsp;&nbsp;<span style="color: #cf222e">class</span>&nbsp;<span style="color: #953800">Modelo</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">include</span>&nbsp;<span style="color: #953800">Mongoid</span><span style="color: #0550ae">::</span><span style="color: #953800">Documento</span>
</div><div class='code-line code-line-7'>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">def</span>&nbsp;<span style="color: #8250df">inicializar</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">*</span><span style="color: #24292f;background-color: #f6f8fa">args</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0550ae">&amp;</span><span style="color: #24292f;background-color: #f6f8fa">bloque</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">super</span>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">asegurar</span>
</div><div class='code-line code-line-11'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">@fallar</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #953800">Clase</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">nuevo</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #953800">abrir</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">__ARCHIVO__</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">fin</span>
</div><div class='code-line code-line-13'>&nbsp;&nbsp;<span style="color: #cf222e">fin</span>
</div><div class='code-line code-line-14'>
</div><div class='code-line code-line-15'><span style="color: #6e7781"># entonces esto fallará</span>
</div><div class='code-line code-line-16'><span style="color: #6e7781">#</span>
</div><div class='code-line code-line-17'>&nbsp;&nbsp;<span style="color: #cf222e">comenzar</span>
</div><div class='code-line code-line-18'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">p</span>&nbsp;<span style="color: #953800">Marshallar</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">cargar</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">Marshallar</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">descargar</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">Modelo</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">crear</span><span style="color: #24292f;background-color: #f6f8fa">))</span>
</div><div class='code-line code-line-19'>&nbsp;&nbsp;<span style="color: #cf222e">rescatar</span>&nbsp;<span style="color: #953800">Objeto</span>&nbsp;<span style="color: #0550ae">=&gt;</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">o</span>
</div><div class='code-line code-line-20'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">advertir</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #24292f">#{</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">o</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">mensaje</span>&nbsp;<span style="color: #24292f">}</span><span style="color: #0a3069"> (</span><span style="color: #24292f">#{</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">o</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">clase</span>&nbsp;<span style="color: #24292f">}</span><span style="color: #0a3069">)"</span>
</div><div class='code-line code-line-21'>&nbsp;&nbsp;<span style="color: #cf222e">fin</span>
</div><div class='code-line code-line-22'>
</div><div class='code-line code-line-23'><span style="color: #6e7781"># pero los modelos de mongoid solo necesitan un hash de información del controlador de mongo</span>
</div><div class='code-line code-line-24'><span style="color: #6e7781"># para vivificarse completamente... ergo esto es todo lo que necesitamos persistir cuando</span>
</div><div class='code-line code-line-25'><span style="color: #6e7781"># se hace marshalling.  esto hace que la carga desde datos marshalling sea *igual que* la carga desde</span>
</div><div class='code-line code-line-26'><span style="color: #6e7781"># la base de datos.</span>
</div><div class='code-line code-line-27'><span style="color: #6e7781">#</span>
</div><div class='code-line code-line-28'><span style="color: #6e7781"># si me preguntas, ¡esto debería ser el comportamiento predeterminado!</span>
</div><div class='code-line code-line-29'><span style="color: #6e7781">#</span>
</div><div class='code-line code-line-30'><span style="color: #6e7781"># hrm - estoy en el núcleo de mongoid... @durran, ¿qué piensas?</span>
</div><div class='code-line code-line-31'><span style="color: #6e7781">#</span>
</div><div class='code-line code-line-32'><span style="color: #6e7781"># por cierto - esto funciona muy bien con active_record también...</span>
</div><div class='code-line code-line-33'><span style="color: #6e7781">#</span>
</div><div class='code-line code-line-34'>&nbsp;&nbsp;<span style="color: #cf222e">class</span>&nbsp;<span style="color: #953800">Modelo</span>
</div><div class='code-line code-line-35'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">def</span>&nbsp;<span style="color: #8250df">_descargar</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">*</span><span style="color: #24292f;background-color: #f6f8fa">args</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0550ae">&amp;</span><span style="color: #24292f;background-color: #f6f8fa">bloque</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
</div><div class='code-line code-line-36'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">Marshallar</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">descargar</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">atributos_crudos</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0550ae">*</span><span style="color: #24292f;background-color: #f6f8fa">args</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0550ae">&amp;</span><span style="color: #24292f;background-color: #f6f8fa">bloque</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
</div><div class='code-line code-line-37'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">fin</span>
</div><div class='code-line code-line-38'>
</div><div class='code-line code-line-39'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">def</span>&nbsp;<span style="color: #953800">Modelo</span><span style="color: #0550ae">.</span><span style="color: #8250df">_cargar</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">cadena</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0550ae">*</span><span style="color: #24292f;background-color: #f6f8fa">args</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0550ae">&amp;</span><span style="color: #24292f;background-color: #f6f8fa">bloque</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
</div><div class='code-line code-line-40'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">atributos_crudos</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #953800">Marshallar</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">cargar</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">cadena</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0550ae">*</span><span style="color: #24292f;background-color: #f6f8fa">args</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0550ae">&amp;</span><span style="color: #24292f;background-color: #f6f8fa">bloque</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
</div><div class='code-line code-line-41'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">instanciar</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">atributos_crudos</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
</div><div class='code-line code-line-42'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">fin</span>
</div><div class='code-line code-line-43'>&nbsp;&nbsp;<span style="color: #cf222e">fin</span>
</div><div class='code-line code-line-44'>
</div><div class='code-line code-line-45'><span style="color: #6e7781"># entonces ahora simplemente funciona (TM)</span>
</div><div class='code-line code-line-46'><span style="color: #6e7781">#</span>
</div><div class='code-line code-line-47'>&nbsp;&nbsp;<span style="color: #953800">p</span>&nbsp;<span style="color: #953800">Marshallar</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">cargar</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">Marshallar</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">descargar</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #953800">Modelo</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">crear</span><span style="color: #24292f;background-color: #f6f8fa">))</span>
</div><div class='code-line code-line-48'>
</div><div class='code-line code-line-49'>
</div><div class='code-line code-line-50'>
</div><div class='code-line code-line-51'>
</div><div class='code-line code-line-52'>
</div><div class='code-line code-line-53'><span style="color: #cf222e">COMENZAR</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-54'>&nbsp;&nbsp;<span style="color: #953800">requerir</span>&nbsp;<span style="color: #0a3069">'rubygems'</span>
</div><div class='code-line code-line-55'>&nbsp;&nbsp;<span style="color: #953800">requerir</span>&nbsp;<span style="color: #0a3069">'mongoid'</span>
</div><div class='code-line code-line-56'>
</div><div class='code-line code-line-57'>&nbsp;&nbsp;<span style="color: #953800">Mongoid</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">configurar</span><span style="color: #24292f;background-color: #f6f8fa">{</span><span style="color: #0550ae">|</span><span style="color: #24292f;background-color: #f6f8fa">configurar</span><span style="color: #0550ae">|</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">configurar</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">conectar_a</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'mongoid-marshallar'</span><span style="color: #24292f;background-color: #f6f8fa">)}</span>
</div><div class='code-line code-line-58'><span style="color: #24292f;background-color: #f6f8fa">}</span>
</div><div class='code-line code-line-59'>
</div><div class='code-line code-line-60'><span style="color: #6e7781">__FIN__</span>
</div><div class='code-line code-line-61'>
</div><div class='code-line code-line-62'><span style="color: #6e7781">los resultados:</span>
</div><div class='code-line code-line-63'>
</div><div class='code-line code-line-64'><span style="color: #6e7781">no se puede descargar la clase anónima #&lt;Clase:0x007fa89dc23768&gt; (TypeError)</span>
</div><div class='code-line code-line-65'>
</div><div class='code-line code-line-66'><span style="color: #6e7781">#&lt;Modelo _id: 5130edd0af481ccd3d000002, &gt;</span>
</div><div class='code-line code-line-67'><span style="color: #6e7781"> </span>
</div></code></div>

<p>ref: https://gist.github.com/ahoward/5066528</p>

</div>
    </main>

    <footer>
      <hr>
<a href="/ir" name="ir">&mdash;&gt; ir</a>
<blockquote>
<ul>
  <li>
    <a href="/sobre">sobre</a>
  </li>
  <li>
    <a href="mailto:odie-esto@drawohara.io?subject=/marshal-mongoid-object-like-butter">odie-esto</a>
  </li>
  <li>
    <a href="mailto:ame-esto@drawohara.io?subject=/marshal-mongoid-object-like-butter">ame-esto</a>
  </li>
  <li>
    <a href="/contacto">contacto</a>
  </li>
</ul>
</blockquote>
<a href="/">&lt;&mdash; salir</a>
    </footer>
  </body>
</html>