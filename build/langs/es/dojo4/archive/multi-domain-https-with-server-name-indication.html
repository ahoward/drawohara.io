<html color-mode="user" lang="es">
  <head>
    <base href='/langs/es' />
    <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DQVD9T27V4');
    </script>

    <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

    <!-- langs -->
    <!--
      https://developers.google.com/search/docs/specialty/international/localized-versions#html
    -->
    <link rel="alternate" hreflang="en" href="/" />
    <link rel="alternate" hreflang="uk" href="https://drawohara.io/langs/uk" />
    <link rel="alternate" hreflang="sv" href="https://drawohara.io/langs/sv" />
    <link rel="alternate" hreflang="fr" href="https://drawohara.io/langs/fr" />
    <link rel="alternate" hreflang="es" href="https://drawohara.io/langs/es" />
    <link rel="alternate" hreflang="it" href="https://drawohara.io/langs/it" />

    <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- meta -->
    <title>nada que ver aqu√≠.</title>

    <meta property="og:title" content="nada que ver aqu√≠."/>
    <meta property="og:description" content="siga adelante." />
    <meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

    <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"multi-domain-https-with-server-name-indication"}">
    <meta property="site:path_info" content=""/multi-domain-https-with-server-name-indication"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) { progressBar.remove(); }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a> &mdash;
      <a href="mailto:i-love-this@drawohara.io?subject=/multi-domain-https-with-server-name-indication">¬°me encanta esto!</a>
      <small>
        <small>
          <small>
            <span title='b√©belo'>&lt;&lt; haz clic aqu√≠ üêõ ü´ñ üßö</a>
          </small>
        </small>
      </small>
      <hr>
      <strong>/multi-domain-https-with-server-name-indication</strong>
    </header>

    <main>
      <em>publicado el: 2014-12-18</em>
      <br>
      <br>
      <div class="ro markdown">
        <p>(Esta es una versi√≥n condensada de <a href="http://www.stuff-things.net/2014/11/14/yes-virginia-you-can-use-sni/">S√≠, Virginia, puedes usar SNI</a> que apareci√≥ originalmente en el blog <a href="http://www.stuff-things.net/">Cosas... y cosas...</a> de Spike)</p>

        <p>Cuando te conectas a un servidor web de manera segura usando HTTPS, la seguridad se negocia utilizando <a href="http://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</a>. Dos cosas ocurren: se verifica la identidad del servidor y se cifra la conexi√≥n.</p>

        <p>La verificaci√≥n es importante; no importa si la conexi√≥n est√° cifrada si de alguna manera has sido redirigido a un servidor malintencionado. Sin embargo, esa verificaci√≥n puede ser problem√°tica si un servidor web est√° sirviendo m√°s de un nombre de host.</p>

        <p>Puedes leer los <a href="http://en.wikipedia.org/wiki/Transport_Layer_Security#TLS_handshake">detalles escabrosos</a>, pero la versi√≥n simplificada del proceso es que el servidor env√≠a un <a href="http://en.wikipedia.org/wiki/Public_key_certificate">certificado de clave p√∫blica firmado</a> que debe coincidir con el nombre de host en la URL. Si un cliente navega a dojo4.com, entonces el certificado debe ser para dojo4.com; si no lo es, el navegador muestra una gran advertencia de seguridad.</p>

        <p>T√©cnicamente, es posible tener m√∫ltiples nombres de host en un certificado; de hecho, es com√∫n tener, por ejemplo, tanto "dojo4.com" como "www.dojo4.com" por completitud. Sin embargo, es una tremenda molestia agregar y eliminar nombres de host de un certificado. Debes hacer que el emisor genere uno nuevo y revocar el anterior. Y, si est√°s trabajando con una Red de Entrega de Contenidos, es poco probable que agreguen tus nombres de host a su certificado.</p>

        <p>Originalmente, TLS soportaba un certificado por servidor web (o m√°s correctamente, por direcci√≥n IP adjunta al servidor web). Se agreg√≥ <a href="http://en.wikipedia.org/wiki/Server_Name_Indication">Indicaci√≥n de Nombre de Servidor (SNI)</a> a TLS para resolver este problema. Al inicio de la negociaci√≥n TLS, el cliente le dice al servidor el nombre del host al que intenta conectarse y el servidor puede entonces seleccionar y enviar el archivo de certificado correcto. ¬°Problema resuelto!</p>

        <p>Excepto... No todos los navegadores soportan SNI. Todos <em>saben</em> esto, y como resultado, tienden a saltarse SNI e ir directamente a IPs dedicadas por sitio o incluso m√∫ltiples servidores. Esta es una opci√≥n costosa, especialmente cuando se trabaja con CDNs como CloudFront. Cuando esto surgi√≥ para m√≠, decid√≠ ver qu√© significaba realmente "no todos los navegadores".</p>

        <p>Resulta que SNI es ampliamente soportado, con los grandes problemas siendo IE8 y versiones anteriores, y cualquier versi√≥n de IE ejecut√°ndose en Windows XP (porque la biblioteca subyacente del sistema operativo no soporta SNI). Tambi√©n hay algunas versiones antiguas de Android que carecen de soporte.</p>

        <p>Entonces, la mayor√≠a de los visitantes no tendr√°n problemas con SNI y el grupo que s√≠ los tiene es lo suficientemente peque√±o como para que podamos manejarlos como un caso especial.</p>

        <p>Para los navegadores sin soporte de SNI, la soluci√≥n alternativa es redirigirlos a un certificado que funcione o a una p√°gina sarc√°stica de "actualiza tu navegador". Si buscas en Google, encontrar√°s varias soluciones sobre la construcci√≥n de listas blancas de navegadores buenos y/o listas negras de malos y luego usar esas listas en reglas de redirecci√≥n del lado del servidor. Feo. Las listas deben ser mantenidas y, dependiendo del servidor, rompen el cach√©.</p>

        <p>Hay una manera m√°s inteligente. Mientras navegaba por un mar de configuraciones de redirecci√≥n de Apache, lo encontr√© en esta <a href="https://www.ebower.com/wiki/Detecting_SNI_with_Apache">publicaci√≥n</a>. La idea central de la publicaci√≥n se puede destilar en esto: si un navegador que no soporta SNI intenta cargar contenido SNI, obtendr√° un error. Si probamos esto en segundo plano y diferenciamos entre error y √©xito, entonces podemos redirigir al visitante en consecuencia. Y la forma m√°s sencilla de hacerlo es intentar agregar una imagen de un p√≠xel a la p√°gina.</p>

        <p>En c√≥digo se ve as√≠:</p>

        <div class="language-javascript highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #cf222e">function</span>&nbsp;<span style="color: #8250df">secure_redirect</span><span style="color: #24292f;background-color: #f6f8fa">()</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
        </div><div class='code-line code-line-2'>&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #0550ae">=</span><span style="color: #953800">document</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">createElement</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">img</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>&nbsp;<span style="color: #6e7781">// crear un elemento de imagen.</span>
        </div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Establecer el src a una URL SNI de una imagen de un p√≠xel</span>
        </div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">src</span><span style="color: #0550ae">=</span><span style="color: #0a3069">'</span><span style="color: #0a3069">https://www.example.org/pixel.gif</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
        </div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Esto se ejecuta si SNI funciona.</span>
        </div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">onload</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">()</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
        </div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Redirigir a la p√°gina segura.</span>
        </div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">href</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">https://example.org/</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
        </div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">};</span>
        </div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Esto se ejecuta si SNI no funciona.</span>
        </div><div class='code-line code-line-11'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">onerror</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #24292f;background-color: #f6f8fa">)</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
        </div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Redirigir a otro lugar</span>
        </div><div class='code-line code-line-13'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">href</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">http://example.org/snarky-old-browser-message</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
        </div><div class='code-line code-line-14'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">};</span>
        </div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// No mostrar realmente la imagen</span>
        </div><div class='code-line code-line-16'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">style</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">display</span><span style="color: #0550ae">=</span><span style="color: #0a3069">'</span><span style="color: #0a3069">none</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
        </div><div class='code-line code-line-17'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// pero adjuntarla a las p√°ginas para que se cargue.</span>
        </div><div class='code-line code-line-18'>&nbsp;&nbsp;&nbsp;<span style="color: #953800">document</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">body</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">appendChild</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
        </div><div class='code-line code-line-19'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
        </div></code></div>

        <p>Aqu√≠ estoy aprovechando dos callbacks de HTML en la etiqueta <em>img</em>, 'OnLoad', que se dispara cuando una imagen termina de cargarse, y 'OnError', que se dispara si la imagen no puede cargarse. Si un navegador no soporta SNI, la imagen fallar√° en cargarse debido a un error de certificado, disparando 'OnError'. Sin embargo, como estamos agregando la imagen a una p√°gina ya cargada, no generar√° un error en el navegador.</p>

        <p>Ahora podemos probar SNI y manejar la falta de soporte de manera elegante. ¬°La Navidad est√° salvada!</p>

        <p>Sin embargo, lo que realmente hemos llegado es a algo m√°s inteligente. Nota que el c√≥digo no est√° realmente probando SNI, solo la capacidad de cargar la imagen de manera segura. Si la URL HTTPS en cuesti√≥n no requiere realmente SNI, hay solo un certificado o el primer certificado coincide con el dominio solicitado, a√∫n funciona. El problema se ha reducido a "¬øPuede el navegador de este visitante mostrar el sitio seguro o no?" y al final del d√≠a, eso es todo lo que realmente nos importa.</p>

      </div>
    </main>

    <footer>
      <hr>
      <a href="/goto" name="goto">&mdash;&gt; goto</a>
      <blockquote>
      <ul>
        <li>
          <a href="mailto:i-hate-this@drawohara.io?subject=/multi-domain-https-with-server-name-indication">üò©, i üñ§ ^this!</a>
        </li>
        <li>
          <a href="/now">/now</a>
        </li>
        <li>
          <a href="/about">/about</a>
        </li>
        <li>
          <a href="/contact">/contact</a>
        </li>
      </ul>
      </blockquote>
      <a href="/">&lt;&mdash; eject</a>
    </footer>
  </body>
</html>