<html color-mode="user" lang="es">
  <head>
    <base href='/es' />
    <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DQVD9T27V4');
    </script>

    <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css">

    <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- meta -->
    <title>Detección de dispositivos móviles detrás de una CDN</title>

    <meta property="og:title" content="Detección de dispositivos móviles detrás de una CDN"/>
    <meta property="og:description" content="siga adelante." />
    <meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

    <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"mobile-detection-behind-a-cdn"}">
    <meta property="site:path_info" content=""/mobile-detection-behind-a-cdn"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) {
          progressBar.remove();
        }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a>
      <hr>
    </header>

    <main>
      <div class="ro markdown">
        <p>En un proyecto reciente, nos encargaron crear la versión móvil de un sitio web existente. El sitio web existente no era un buen candidato para un diseño adaptable, por lo que decidimos crear una versión completamente nueva del sitio para dispositivos móviles.</p>

        <p>![5547851770<em>3598506559_z.jpg](assets/b.jpeg)<br />
        _(foto de <a href="https://www.flickr.com/photos/johanl/5547851770/in/photolist-9sfc3J-63nmeT-3BAAy-dWUBhB-pAZUn-ccjB1w-st5Gc-7B2UEE-bbLNKX-8yTj9M-9e6jeJ-72jTj6-8RU8QS-5TNHyH-8FkSqy-5r7dgL-5A6ymJ-atHdpQ-7BbKMK-8P8X2-7bD7t6-2ViX1A-5E6qqL-6NDF76-9hBh7m-4bSRnn-sZomP-6VbEE-buapa2-5Kw5si-85KrwR-5kpSzg-bjEUUE-bV9J19-5GXRmg-6zbLPt-8yWpiA-akq64F-5n4ciA-9hmSj5-msHvhK-hZpPt-bFe25b-Bjwzo-mFYCVT-d3v8y-6wRQrs-f1p7uv-f8rrUJ-ebxiKS">Johan Larsson</a>)</em></p>

        <p>Al principio pensamos en usar el patrón m.example.com, donde los sitios son dominios completamente separados. Sin embargo, dado que no administramos la infraestructura de este sitio, queríamos optar por un enfoque que requiriera la menor cantidad posible de cambios en la infraestructura. Apoyar otro dominio en los mismos servidores no es muy difícil, pero es solo otra tarea que es fácil de estropear y no es necesaria en nuestro caso.</p>

        <p>También he publicado esta técnica para que cualquiera pueda usarla fácilmente en una aplicación de rails a través de un motor de rails:</p>

        <ul>
          <li>https://github.com/milesmatthias/cdddn</li>
          <li>http://rubygems.org/gems/cdddn</li>
        </ul>

        <h2 id="intro-a-cloudfront">Intro a CloudFront</h2>

        <p>Una gran ventaja de este sitio web en particular es que utiliza <a href="http://aws.amazon.com/cloudfront/">CloudFront</a>. CloudFront es una red de entrega de contenidos (CDN), donde las páginas web estáticas se alojan en <a href="http://aws.amazon.com/cloudfront/details/">52 centros de datos en todo el mundo</a>. Esto permite que la página se sirva al navegador lo más rápido posible porque, independientemente de dónde se encuentre en el mundo, no estará lejos de uno de los nodos de CloudFront, por lo que llevará menos tiempo entregar el sitio web a su dispositivo. CloudFront forma parte de la oferta de AWS de Amazon y, además de garantizar la velocidad, garantiza el tiempo de actividad. (A diferencia de <a href="http://aws.amazon.com/s3/">S3</a>, donde solo se garantiza el tiempo de actividad.)</p>

        <p>Cuando usa CloudFront, le indica dónde se encuentra su servidor web para que CloudFront pueda obtener la última versión de las páginas web que está sirviendo para usted. CloudFront también solo solicita a su servidor web nuevas versiones de sus páginas web cada pocos minutos, o el intervalo de tiempo que configure en el panel de CloudFront. Normalmente, es alrededor de 24 horas. Esto permite que CloudFront se centre en la disponibilidad y la velocidad, reduciendo considerablemente la carga en su servidor web. (También lleva tiempo que CloudFront tome una nueva versión de una página y actualice los 52 centros de datos.)</p>

        <p>Sin embargo, esto introduce el problema del seguimiento del estado. Por ejemplo, si su sitio es servido completamente por CloudFront, ¿cómo puede soportar que los usuarios inicien sesión en su sitio? Si soy un usuario llamado Bob y la página en <code>/my/account</code> dice “¡Hola Bob!”, CloudFront pensará que todos los que soliciten la página en <code>/my/account</code> deben ver la versión de la página que dice “¡Hola Bob!”. Los usuarios (excepto quizás las personas llamadas Bob...) estarán muy confundidos. No solo eso, sino ¿qué pasa si un usuario actualiza algún valor en su cuenta y espera que ese cambio se muestre al instante? CloudFront no obtiene una nueva versión de la página en cada solicitud (lo que en cierto modo derrotaría el propósito de CloudFront), espera cada pocos minutos para obtener una nueva versión. CloudFront ha abordado varias de estas preguntas con <a href="http://aws.amazon.com/cloudfront/dynamic-content/">nuevas funciones</a>, pero debe ser consciente de estas implicaciones al usar CloudFront.</p>

        <p>En nuestro caso, el sitio en el que estamos trabajando no tiene el concepto de "usuarios" y nadie puede iniciar sesión en el sistema. Sin embargo, aún queremos que CloudFront muestre diferentes versiones del sitio dependiendo del dispositivo desde el cual se solicita el sitio (móvil frente a escritorio).</p>

        <p>CloudFront puede realizar la detección de dispositivos para usted y luego enviar un encabezado especial a su servidor web para decir "Dame la versión de la página para un teléfono", sin embargo, queríamos controlar el método de detección de dispositivos (respondiendo la pregunta: ¿es esto un teléfono o un escritorio?) y queríamos la capacidad de que los usuarios finales y los desarrolladores anulen el dispositivo elegido para ellos. Por ejemplo, los usuarios finales en una tableta pueden querer ver la versión de escritorio, aunque inicialmente les mostremos la versión móvil. Nuestros desarrolladores también encontrarán que es una molestia cambiar su dispositivo cada vez que quieran cambiar entre las versiones al construir el sitio.</p>

        <h2 id="nuestra-solución">Nuestra Solución</h2>

        <p>Entonces, aquí está el método que ideamos para tener tanto una versión de escritorio como móvil de un sitio en el mismo dominio y servido por CloudFront. Una nota requerida es que CloudFront normalmente deshabilita todas las cookies para su dominio, pero puede configurarlo para permitir las cookies que nombre. En nuestro caso, le dijimos a CloudFront que permitiera una cookie llamada 'dispositivo'. Tenga en cuenta también que nos encontramos en el contexto de una aplicación de rails 4, pero esta arquitectura se puede replicar en cualquier pila. El punto principal aquí es que el cliente necesita averiguar en qué dispositivo está el usuario, permitirle anular eso y mantener al servidor consciente del tipo de dispositivo para que el servidor pueda servir las páginas correctas (esto se hace a través de cookies).</p>

        <h3 id="en-cada-página-necesitamos-hacer-algo-como-este-fragmento-de-appviewslayoutapplicationhtmlerb">En cada página necesitamos hacer algo como esto (fragmento de app/views/layout/application.html.erb)</h3>

        <pre><code class="language-html+erb">&lt;%= javascript_include_tag "detección_móvil" %&gt;

&lt;script&gt;

  if (!window.location.href.match(/get_device|set_device/)){
    console.log('registrando window.location.href = ' + window.location.href);
    localStorage.setItem('referrer_href', window.location.href);
  }

  var device_cookie  = cookie.get('device'),
      cookiesEnabled = cookie.enabled();

  if (cookiesEnabled &amp;&amp; device_cookie == undefined) {
    window.location = '/get_device.html'
  }

&lt;/script&gt;
</code></pre>

        <p>El código anterior simplemente recuerda qué página aterrizó (generalmente la página de inicio, pero queremos que el cliente pueda compartir enlaces y que funcione en móvil también), y luego lo redirige a la página <code>/get_device</code> para detectar su dispositivo si no lo hemos hecho ya. Tenga en cuenta el uso de <code>localStorage</code>, lo que significa que esto solo funcionará en IE8+ y no funcionará en Opera Mini.</p>

        <p>También tenga en cuenta que el fragmento anterior se coloca en el <code>&lt;head&gt;</code> del diseño para que se ejecute lo antes posible y antes de cualquier script que pueda tener la versión de escritorio. En este caso, la versión de escritorio utiliza mucho javascript para cargar mucho contenido, por lo que realmente no queríamos que todo eso sucediera en un teléfono antes de que el sitio reconociera que el usuario debería ver la versión móvil del sitio.</p>

        <h3 id="en-cada-página-móvil-necesitamos-hacer-esto-de-appviewslayoutapplicationmobileerb">En cada página móvil necesitamos hacer esto (de `app/views/layout/application.mobile.erb):</h3>

        <div class="language-js highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #24292f;background-color: #f6f8fa">script</span><span style="color: #0550ae">&gt;</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">device_cookie</span>&nbsp;&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">get</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">device</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">),</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookiesEnabled</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">enabled</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
</div><div class='code-line code-line-4'>&nbsp;
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">if </span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">cookiesEnabled</span>&nbsp;<span style="color: #0550ae">&amp;&amp;</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">device_cookie</span>&nbsp;<span style="color: #0550ae">==</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">desktop</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">)</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">reload</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">true</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #116329">/script</span><span style="color: #f6f8fa;background-color: #82071e">&gt;</span>
</div></code></div>

        <p>Esto se debe a que los dispositivos móviles almacenan en caché las páginas en gran medida (lo cual tiene sentido) por lo que si el usuario ha cambiado el dispositivo en el que se encuentra, debemos asegurarnos de enviar esa cookie actualizada al servidor, incluso si la URL no ha cambiado (y, por lo tanto, la caché piensa que es la misma página que debe servirse). El <code>true</code> en la llamada a la función <code>reload</code> le indica al navegador que ignore lo que hay en la caché.</p>

        <p>Tenga en cuenta que hacemos exactamente lo mismo en cada página de escritorio, excepto que verificamos si el usuario ha cambiado su dispositivo a <code>'móvil'</code>.</p>

        <h3 id="detección-de-dispositivos-en-get_device-appviewshomeget_devicehtml">Detección de dispositivos en <code>/get_device</code> (app/views/home/get_device.html)</h3>

        <div class="language-js highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #24292f;background-color: #f6f8fa">script</span><span style="color: #0550ae">&gt;</span>
</div><div class='code-line code-line-2'>&nbsp;
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">function</span>&nbsp;<span style="color: #8250df">isMobile</span><span style="color: #24292f;background-color: #f6f8fa">(){</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">MOBILE_USER_AGENTS</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">palm|blackberry|nokia|phone|midp|mobi|symbian|chtml|ericsson|minimo|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">audiovox|motorola|samsung|telit|upg1|windows ce|ucweb|astel|plucker|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">x320|x240|j2me|sgh|portable|sprint|docomo|kddi|softbank|android|mmp|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">pdxgw|netfront|xiino|vodafone|portalmmm|sagem|mot-|sie-|ipod|up</span><span style="color: #0a3069">\\</span><span style="color: #0a3069">.b|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">webos|amoi|novarra|cdm|alcatel|pocket|ipad|iphone|mobileexplorer|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">mobile|zune</span><span style="color: #0a3069">'