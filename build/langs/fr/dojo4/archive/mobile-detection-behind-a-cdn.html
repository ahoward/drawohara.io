<html color-mode="user" lang="fr">
  <head>
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DQVD9T27V4');
</script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- langs -->
  <!--
    https://developers.google.com/search/docs/specialty/international/localized-versions#html
  -->
   <link rel="alternate" hreflang="en" href="/" />
   <link rel="alternate" hreflang="uk" href="https://drawohara.io/langs/uk" />
   <link rel="alternate" hreflang="sv" href="https://drawohara.io/langs/sv" />
   <link rel="alternate" hreflang="fr" href="https://drawohara.io/langs/fr" />
   <link rel="alternate" hreflang="es" href="https://drawohara.io/langs/es" />
   <link rel="alternate" hreflang="it" href="https://drawohara.io/langs/it" />

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

  <!-- meta -->
    <title>Rien √† voir ici.</title>

<meta property="og:title" content="Rien √† voir ici."/>
<meta property="og:description" content="Passez votre chemin." />
<meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

<meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"mobile-detection-behind-a-cdn"}">
    <meta property="site:path_info" content=""/mobile-detection-behind-a-cdn"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) { progressBar.remove(); }
      });
    </script>
    <base href='/langs/fr' />
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a> &mdash;
<a href="mailto:i-love-this@drawohara.io?subject=/mobile-detection-behind-a-cdn">J' ‚ù§Ô∏è  √ßa !</a>
<small>
  <small>
    <small>
      <span title='bois-moi'>&lt;&lt; cliquez-moi üêõ ü´ñ üßö</a>
    </small>
  </small>
</small>
<hr>
<strong>/mobile-detection-behind-a-cdn</strong>
    </header>

    <main>
      <em>publi√© le : 2014-07-23</em>
<br>
<br>
<div class="ro markdown">
  <p>Dans un projet r√©cent, nous avons √©t√© charg√©s de cr√©er la version mobile d'un site web existant. Le site web existant n'√©tait pas vraiment un bon candidat pour un design r√©actif, nous avons donc d√©cid√© de cr√©er une version compl√®tement nouvelle du site pour les appareils mobiles.</p>

<p>![5547851770<em>3598506559_z.jpg](assets/b.jpeg)<br />
_(photo par <a href="https://www.flickr.com/photos/johanl/5547851770/in/photolist-9sfc3J-63nmeT-3BAAy-dWUBhB-pAZUn-ccjB1w-st5Gc-7B2UEE-bbLNKX-8yTj9M-9e6jeJ-72jTj6-8RU8QS-5TNHyH-8FkSqy-5r7dgL-5A6ymJ-atHdpQ-7BbKMK-8P8X2-7bD7t6-2ViX1A-5E6qqL-6NDF76-9hBh7m-4bSRnn-sZomP-6VbEE-buapa2-5Kw5si-85KrwR-5kpSzg-bjEUUE-bV9J19-5GXRmg-6zbLPt-8yWpiA-akq64F-5n4ciA-9hmSj5-msHvhK-hZpPt-bFe25b-Bjwzo-mFYCVT-d3v8y-6wRQrs-f1p7uv-f8rrUJ-ebxiKS">Johan Larsson</a>)</em></p>

<p>Au d√©part, nous pensions utiliser le mod√®le m.example.com, o√π les sites sont des domaines enti√®rement s√©par√©s. Cependant, puisque nous ne g√©rons pas l'infrastructure pour ce site, nous voulions opter pour une approche n√©cessitant le moins de changements d'infrastructure possible. Prendre en charge un autre domaine sur les m√™mes serveurs n'est pas tr√®s difficile, mais c'est une autre t√¢che qui est facile √† manquer et qui n'est pas n√©cessaire dans notre cas.</p>

<p>J'ai √©galement publi√© cette technique pour que tout le monde puisse l'utiliser facilement dans une application rails via un moteur rails :</p>

<ul>
  <li>https://github.com/milesmatthias/cdddn</li>
  <li>http://rubygems.org/gems/cdddn</li>
</ul>

<h2 id="intro-√†-cloudfront">Introduction √† CloudFront</h2>

<p>Un √©norme avantage de ce site web particulier est qu'il utilise <a href="http://aws.amazon.com/cloudfront/">CloudFront</a>. CloudFront est un r√©seau de distribution de contenu (ou CDN), o√π les pages web statiques sont h√©berg√©es dans <a href="http://aws.amazon.com/cloudfront/details/">52 centres de donn√©es √† travers le monde</a>. Cela permet √† la page d'√™tre servie au navigateur le plus rapidement possible, car peu importe o√π vous vous trouvez dans le monde, vous ne serez pas loin de l'un des n≈ìuds de CloudFront, ce qui prendra moins de temps pour que le site web soit d√©livr√© √† votre appareil. CloudFront fait partie de l'offre AWS d'Amazon et, en plus de garantir la vitesse, ils garantissent la disponibilit√©. (Contrairement √† <a href="http://aws.amazon.com/s3/">S3</a>, o√π seule la disponibilit√© est garantie.)</p>

<p>Lorsque vous utilisez CloudFront, vous lui indiquez o√π se trouve votre serveur web afin que CloudFront puisse obtenir la derni√®re version des pages web qu'il sert pour vous. CloudFront demande √©galement √† votre serveur web de nouvelles versions de vos pages web tous les quelques minutes, ou √† l'intervalle de temps que vous configurez dans votre tableau de bord CloudFront. Normalement, c'est quelque part autour de 24 heures. Cela permet √† CloudFront de se concentrer sur la disponibilit√© et la vitesse, tout en r√©duisant consid√©rablement la charge sur votre serveur web. (Il faut √©galement du temps √† CloudFront pour prendre une nouvelle version d'une page et mettre √† jour les 52 centres de donn√©es.)</p>

<p>Cependant, cela introduit le probl√®me du suivi de l'√©tat. Par exemple, si votre site est enti√®rement servi par CloudFront, comment g√©rez-vous la connexion des utilisateurs √† votre site ? Si je suis un utilisateur nomm√© Bob et que la page √† <code>/my/account</code> dit "Bonjour Bob !", CloudFront pensera que tout le monde qui demande la page √† <code>/my/account</code> devrait voir la version de la page qui dit "Bonjour Bob !". Les utilisateurs (sauf peut-√™tre ceux qui s'appellent Bob...) seront tr√®s confus. Non seulement cela, mais que se passe-t-il si un utilisateur met √† jour une valeur dans son compte et s'attend √† ce que ce changement s'affiche instantan√©ment ? CloudFront n'obtient pas une nouvelle version de la page √† chaque demande (ce qui d√©ferait en quelque sorte le but de CloudFront), il attend quelques minutes pour obtenir une nouvelle version. CloudFront a r√©pondu √† plusieurs de ces questions avec <a href="http://aws.amazon.com/cloudfront/dynamic-content/">de nouvelles fonctionnalit√©s</a>, mais vous devez √™tre conscient de ces implications lors de l'utilisation de CloudFront.</p>

<p>Dans notre cas, le site sur lequel nous travaillons n'a pas le concept d'"utilisateurs" et personne ne peut se connecter au syst√®me. Cependant, nous voulons toujours que CloudFront montre diff√©rentes versions du site en fonction de l'appareil √† partir duquel vous demandez le site (mobile vs bureau).</p>

<p>CloudFront peut effectuer une d√©tection de l'appareil pour vous et envoyer ensuite un en-t√™te sp√©cial √† votre serveur web pour dire "Donnez-moi la version de la page pour un t√©l√©phone", cependant, nous voulions contr√¥ler la m√©thode de d√©tection de l'appareil (en r√©pondant √† la question - est-ce un t√©l√©phone ou un bureau ?) et nous voulions la possibilit√© pour les utilisateurs finaux et les d√©veloppeurs de remplacer l'appareil choisi pour eux. Par exemple, les utilisateurs finaux sur une tablette peuvent simplement vouloir voir la version bureau m√™me si nous leur montrons initialement la version mobile. Nos d√©veloppeurs trouveront √©galement cela ennuyeux de changer leur appareil chaque fois qu'ils veulent passer entre les versions lors de la construction du site.</p>

<h2 id="notre-solution">Notre Solution</h2>

<p>Voici donc la m√©thode que nous avons trouv√©e pour avoir √† la fois une version bureau et mobile d'un site sur le m√™me domaine et servie par CloudFront. Une note requise est que CloudFront d√©sactive normalement tous les cookies pour votre domaine, mais vous pouvez le configurer pour autoriser les cookies que vous nommez. Dans notre cas, nous avons dit √† CloudFront d'autoriser un cookie appel√© 'device'. Notez √©galement que nous sommes dans le contexte d'une application rails 4, mais cette architecture peut √™tre reproduite dans n'importe quelle pile. Le point principal ici est que le client doit d√©terminer quel appareil l'utilisateur utilise, lui permettre de le remplacer et garder le serveur inform√© du type d'appareil afin que le serveur puisse servir les bonnes pages (cela est fait via des cookies).</p>

<h3 id="sur-chaque-page-nous-devons-faire-quelque-chose-comme-ceci-extrait-de-appviewslayoutapplicationhtmlerb">Sur chaque page, nous devons faire quelque chose comme ceci (extrait de app/views/layout/application.html.erb)</h3>

<pre><code class="language-html+erb">&lt;%= javascript_include_tag "mobile_detection" %&gt;

&lt;script&gt;

  if (!window.location.href.match(/get_device|set_device/)){
    console.log('logging the window.location.href = ' + window.location.href);
    localStorage.setItem('referrer_href', window.location.href);
  }

  var device_cookie  = cookie.get('device'),
      cookiesEnabled = cookie.enabled();

  if (cookiesEnabled &amp;&amp; device_cookie == undefined) {
    window.location = '/get_device.html'
  }

&lt;/script&gt;
</code></pre>

<p>Le code ci-dessus se souvient simplement de la page sur laquelle vous avez atterri (g√©n√©ralement la page d'accueil, mais nous voulons que le client puisse partager des liens et que cela fonctionne √©galement sur mobile), puis vous redirige vers la page <code>/get_device</code> pour d√©tecter votre appareil si nous n'avons pas encore fait cela. Notez l'utilisation de <code>localStorage</code>, ce qui signifie que cela ne fonctionnera que sur IE8+ et ne fonctionnera pas sur Opera Mini.</p>

<p>Notez √©galement que l'extrait ci-dessus est plac√© dans le <code>&lt;head&gt;</code> du layout afin qu'il soit ex√©cut√© d√®s que possible et avant tout script que la version bureau pourrait avoir. Dans ce cas, la version bureau utilise beaucoup de javascript pour charger beaucoup de contenu, nous ne voulions donc vraiment pas que tout cela se produise sur un t√©l√©phone avant que le site ne reconnaisse que l'utilisateur devrait voir la version mobile du site.</p>

<h3 id="sur-chaque-page-mobile-nous-devons-faire-cela-√†-partir-de-appviewslayoutapplicationmobileerb">Sur chaque page mobile, nous devons faire ceci (√† partir de `app/views/layout/application.mobile.erb):</h3>

<div class="language-js highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #24292f;background-color: #f6f8fa">script</span><span style="color: #0550ae">&gt;</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">device_cookie</span>&nbsp;&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">get</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">device</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">),</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookiesEnabled</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">enabled</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
</div><div class='code-line code-line-4'>&nbsp;
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">if </span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">cookiesEnabled</span>&nbsp;<span style="color: #0550ae">&amp;&amp;</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">device_cookie</span>&nbsp;<span style="color: #0550ae">==</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">desktop</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">)</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">reload</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">true</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #116329">/script</span><span style="color: #f6f8fa;background-color: #82071e">&gt;</span>
</div></code></div>

<p>Ceci est d√ª au fait que les appareils mobiles mettent en cache les pages de mani√®re intensive (ce qui est logique) donc si l'utilisateur a chang√© d'appareil, nous devons nous assurer d'envoyer ce cookie mis √† jour au serveur m√™me si l'URL n'a pas chang√© (et donc le cache pense qu'il s'agit de la m√™me page √† servir). Le <code>true</code> dans l'appel de fonction <code>reload</code> indique au navigateur d'ignorer ce qui se trouve dans le cache.</p>

<p>Notez que nous faisons exactement la m√™me chose sur chaque page bureau, sauf pour v√©rifier si l'utilisateur a chang√© son appareil en <code>'mobile'</code>.</p>

<h3 id="d√©tection-de-lappareil-√†-get_device-appviewshomeget_devicehtml">D√©tection de l'appareil √† <code>/get_device</code> (app/views/home/get_device.html)</h3>

<div class="language-js highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #24292f;background-color: #f6f8fa">script</span><span style="color: #0550ae">&gt;</span>
</div><div class='code-line code-line-2'>&nbsp;
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">function</span>&nbsp;<span style="color: #8250df">isMobile</span><span style="color: #24292f;background-color: #f6f8fa">(){</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">MOBILE_USER_AGENTS</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">palm|blackberry|nokia|phone|midp|mobi|symbian|chtml|ericsson|minimo|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">audiovox|motorola|samsung|telit|upg1|windows ce|ucweb|astel|plucker|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">x320|x240|j2me|sgh|portable|sprint|docomo|kddi|softbank|android|mmp|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">pdxgw|netfront|xiino|vodafone|portalmmm|sagem|mot-|sie-|ipod|up</span><span style="color: #0a3069">\\</span><span style="color: #0a3069">.b|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">webos|amoi|novarra|cdm|alcatel|pocket|ipad|iphone|mobileexplorer|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">mobile|zune</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">mobile_regex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">new</span>&nbsp;<span style="color: #953800">RegExp</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">MOBILE_USER_AGENTS</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">i</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6