<html color-mode="user" lang="fr">
  <head>
    <base href='/langs/fr' />
    <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DQVD9T27V4');
    </script>

    <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

    <!-- langs -->
    <!--
      https://developers.google.com/search/docs/specialty/international/localized-versions#html
    -->
    <link rel="alternate" hreflang="en" href="/" />
    <link rel="alternate" hreflang="uk" href="https://drawohara.io/langs/uk" />
    <link rel="alternate" hreflang="sv" href="https://drawohara.io/langs/sv" />
    <link rel="alternate" hreflang="fr" href="https://drawohara.io/langs/fr" />
    <link rel="alternate" hreflang="es" href="https://drawohara.io/langs/es" />
    <link rel="alternate" hreflang="it" href="https://drawohara.io/langs/it" />

    <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- meta -->
    <title>rien √† voir ici.</title>

    <meta property="og:title" content="rien √† voir ici."/>
    <meta property="og:description" content="circulez." />
    <meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

    <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content="/dojo4/archive/:id">
    <meta property="site:params" content="{'ext':null,'id':'multi-domain-https-with-server-name-indication'}">
    <meta property="site:path_info" content="/multi-domain-https-with-server-name-indication">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) { progressBar.remove(); }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a> &mdash;
      <a href="mailto:i-love-this@drawohara.io?subject=/multi-domain-https-with-server-name-indication">j' ‚ù§Ô∏è  √ßa !</a>
      <small>
        <small>
          <small>
            <span title='bois-moi'>&lt;&lt; cliquez-moi üêõ ü´ñ üßö</span>
          </small>
        </small>
      </small>
      <hr>
      <strong>/multi-domain-https-with-server-name-indication</strong>
    </header>

    <main>
      <em>publi√© le: 2014-12-18</em>
      <br>
      <br>
      <div class="ro markdown">
        <p>(Il s'agit d'une version condens√©e de <a href="http://www.stuff-things.net/2014/11/14/yes-virginia-you-can-use-sni/">Oui, Virginie, vous pouvez utiliser SNI</a> qui est apparu √† l'origine sur le blog <a href="http://www.stuff-things.net/">Stuff‚Ä¶ And Things‚Ä¶ de Spike</a>)</p>

        <p>Lorsque vous vous connectez √† un serveur web de mani√®re s√©curis√©e en utilisant HTTPS, la s√©curit√© est n√©goci√©e en utilisant <a href="http://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</a>. Deux choses se produisent : l'identit√© du serveur est v√©rifi√©e et la connexion est chiffr√©e.</p>

        <p>La v√©rification est importante, peu importe si la connexion est chiffr√©e si vous avez √©t√© redirig√© vers le serveur d'un m√©chant. Cependant, cette v√©rification peut poser probl√®me si un serveur web dessert plusieurs noms d'h√¥te.</p>

        <p>Vous pouvez lire les <a href="http://en.wikipedia.org/wiki/Transport_Layer_Security#TLS_handshake">d√©tails sordides</a>, mais la version simplifi√©e du processus est que le serveur envoie un certificat de cl√© publique sign√© qui doit correspondre au nom d'h√¥te dans l'URL. Si un client navigue vers dojo4.com, le certificat doit √™tre pour dojo4.com, sinon le navigateur affiche un grand avertissement effrayant.</p>

        <p>Techniquement, il est possible d'avoir plusieurs noms d'h√¥te sur un certificat, en fait, il est courant d'avoir, par exemple, √† la fois "dojo4.com" et "www.dojo.com", pour l'exhaustivit√©. Cependant, il est tr√®s p√©nible d'ajouter et de supprimer des noms d'h√¥te d'un certificat. Vous devez demander √† l'√©metteur d'en g√©n√©rer un nouveau et de r√©voquer l'ancien. Et, si vous travaillez avec un r√©seau de distribution de contenu, il est peu probable qu'ils ajoutent vos noms d'h√¥te √† leur certificat.</p>

        <p>√Ä l'origine, TLS ne supportait qu'un certificat par serveur web (ou plus correctement, par adresse IP attach√©e au serveur web) <a href="http://en.wikipedia.org/wiki/Server_Name_Indication">Server Name Indication (SNI)</a> a √©t√© ajout√© √† TLS pour r√©soudre ce probl√®me. Au d√©but de la n√©gociation TLS, le client informe le serveur du nom de l'h√¥te auquel il essaie de se connecter et le serveur peut alors s√©lectionner et envoyer le bon fichier de certificat. Probl√®me r√©solu !</p>

        <p>Sauf‚Ä¶ Tous les navigateurs ne supportent pas SNI. Tout le monde <em>sait</em> cela, et par cons√©quent, tend √† sauter SNI et √† passer directement aux IP d√©di√©es par site ou m√™me √† plusieurs serveurs. C'est une option co√ªteuse, surtout lorsque l'on travaille avec des CDN comme CloudFront. Lorsque cela s'est produit pour moi, j'ai d√©cid√© de voir ce que "pas tous les navigateurs" signifiait vraiment.</p>

        <p>Il s'av√®re que SNI est largement support√©, les principaux probl√®mes √©tant IE8 et versions ant√©rieures et toute version de IE fonctionnant sous Windows XP (parce que la biblioth√®que sous-jacente du syst√®me d'exploitation ne supporte pas SNI). Il existe √©galement certaines anciennes versions d'Android qui manquent de support.</p>

        <p>Donc, la plupart des visiteurs n'auront aucun probl√®me avec SNI et le groupe qui en a est suffisamment petit pour que nous puissions le g√©rer comme un cas sp√©cial.</p>

        <p>Pour les navigateurs sans support SNI, la solution de contournement consiste √† les rediriger vers un certificat qui fonctionnera ou une page sarcastique "mettez √† jour votre navigateur". Si vous faites une recherche Google, vous trouverez un tas de solutions autour de la cr√©ation de listes blanches de bons navigateurs et/ou de listes noires de mauvais navigateurs, puis de l'utilisation de ces listes dans les r√®gles de redirection c√¥t√© serveur. Moche. Les listes doivent √™tre maintenues et, selon le serveur, cela casse le cache.</p>

        <p>Il existe une m√©thode plus intelligente. En naviguant √† travers une mer de configurations de redirection Apache, je l'ai trouv√©e dans ce <a href="https://www.ebower.com/wiki/Detecting_SNI_with_Apache">poste</a>. L'id√©e principale de ce poste peut √™tre distill√©e en ceci : si un navigateur qui ne supporte pas SNI essaie de charger du contenu SNI, il obtiendra une erreur. Si nous testons cela en arri√®re-plan et faisons la diff√©rence entre l'erreur et le succ√®s, nous pouvons alors rediriger le visiteur en cons√©quence. Et la mani√®re la plus simple de le faire est d'essayer d'ajouter une image d'un pixel √† la page.</p>

        <p>En code, cela ressemble √† :</p>

        <div class="language-javascript highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #cf222e">function</span>&nbsp;<span style="color: #8250df">secure_redirect</span><span style="color: #24292f;background-color: #f6f8fa">()</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #0550ae">=</span><span style="color: #953800">document</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">createElement</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">img</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>&nbsp;<span style="color: #6e7781">// cr√©ez un √©l√©ment img.</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// D√©finissez la source sur une URL SNI d'une image d'un pixel</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">src</span><span style="color: #0550ae">=</span><span style="color: #0a3069">'</span><span style="color: #0a3069">https://www.example.org/pixel.gif</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Cela s'ex√©cute si SNI fonctionne.</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">onload</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">()</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Redirigez vers la page s√©curis√©e.</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">href</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">https://example.org/</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">};</span>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Cela s'ex√©cute si SNI ne fonctionne pas.</span>
</div><div class='code-line code-line-11'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">onerror</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #24292f;background-color: #f6f8fa">)</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Redirigez ailleurs</span>
</div><div class='code-line code-line-13'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">href</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">http://example.org/snarky-old-browser-message</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-14'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">};</span>
</div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// N'affichez pas r√©ellement l'image</span>
</div><div class='code-line code-line-16'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">style</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">display</span><span style="color: #0550ae">=</span><span style="color: #0a3069">'</span><span style="color: #0a3069">none</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-17'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// mais ajoutez-la aux pages pour qu'elle soit charg√©e.</span>
</div><div class='code-line code-line-18'>&nbsp;&nbsp;&nbsp;<span style="color: #953800">document</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">body</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">appendChild</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-19'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
</div></code></div>

        <p>Ici, j'utilise deux rappels HTML sur la balise <em>img</em>, 'OnLoad' qui se d√©clenche lorsqu'une image finit de se charger, et 'OnError' qui se d√©clenche si l'image ne peut pas √™tre charg√©e. Si un navigateur ne supporte pas SNI, l'image √©chouera √† se charger en raison d'une erreur de certificat, d√©clenchant 'OnError'. Cependant, comme nous ajoutons l'image √† une page d√©j√† charg√©e, cela ne provoquera pas d'erreur dans le navigateur.</p>

        <p>Maintenant, nous pouvons tester SNI et g√©rer le manque de support de mani√®re √©l√©gante. No√´l est sauv√© !</p>

        <p>Cependant, ce que nous avons vraiment trouv√© est quelque chose de plus intelligent. Remarquez que le code ne teste pas r√©ellement SNI, mais simplement la capacit√© √† charger l'image de mani√®re s√©curis√©e. Si l'URL HTTPS en question ne n√©cessite pas r√©ellement SNI, il n'y a qu'un seul certificat ou le premier certificat correspond au domaine demand√©, cela fonctionne toujours. Le probl√®me a √©t√© r√©duit √† "Ce visiteur peut-il afficher le site s√©curis√© ou non ?" et √† la fin de la journ√©e, c'est tout ce qui nous importe vraiment.</p>

      </div>
    </main>

    <footer>
      <hr>
      <a href="/goto" name="goto">&mdash;&gt; goto</a>
      <blockquote>
        <ul>
          <li>
            <a href="mailto:i-hate-this@drawohara.io?subject=/multi-domain-https-with-server-name-indication">üò©, j' üñ§ ^√ßa !</a>
          </li>
          <li>
            <a href="/now">/now</a>
          </li>
          <li>
            <a href="/about">/about</a>
          </li>
          <li>
            <a href="/contact">/contact</a>
          </li>
        </ul>
      </blockquote>
      <a href="/">&lt;&mdash; eject</a>
    </footer>
  </body>
</html>