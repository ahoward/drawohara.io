<html color-mode="user" lang="fr">
  <head>
    <base href='/fr' />
    <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DQVD9T27V4');
    </script>

    <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

    <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- meta -->
    <title>surmonter le problème épineux des limites d'API avec une armée de workers JavaScript</title>

    <meta property="og:title" content="surmonter le problème épineux des limites d'API avec une armée de workers JavaScript"/>
    <meta property="og:description" content="circulez." />
    <meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

    <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content="/fr/dojo4/archive/:id">
    <meta property="site:params" content='{"ext":null,"id":"surmonter-le-probleme-epineux-des-limites-d-api-avec-une-armee-de-workers-javascript"}'>
    <meta property="site:path_info" content="/fr/surmonter-le-probleme-epineux-des-limites-d-api-avec-une-armee-de-workers-javascript">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) {
          progressBar.remove();
        }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/fr/accueil">@drawohara</a>
      <hr>
    </header>

    <main>
      <div class="ro markdown">
        <h2 id="tldr">TL;DR</h2>

        <p>quand vous avez <em>vraiment</em> trop de travail à faire sur le serveur en ce qui concerne les limites d'API</p>

        <p>confiez une partie du travail aux navigateurs de vos clients pour l'exécuter - en envoyant les résultats à votre base de données</p>

        <h2 id="le-problème">le problème</h2>
        <p>la semaine dernière, je devais gérer les limites de l'API (fournisseur G) et trop de demandes de géolocalisation provenant d'un serveur(s). J'ai travaillé un peu sur ce problème, en faisant des choses en arrière-plan, avec des réessais périodiques - vous savez : les choses standards...</p>

        <p>l'API en question est limitée par IP, et la documentation recommande de tirer parti de cela en effectuant la plupart des appels d'API côté client - en js.</p>

        <p>maintenant, dans ce cas particulier, je <em>devais absolument</em> que les résultats des appels d'API résident côté serveur, alors j'ai trouvé cette solution de compromis (de plus d'une façon)</p>

        <h2 id="la-solution">la solution</h2>
        <p>supposez que certains clients sont prêts à utiliser leur CPU pour remplir les données qui les intéressent. En termes simples, faites exécuter certains de vos clients des tâches à partir d'une file d'attente de travail JavaScript pour amorcer la pompe qui les intéresse.</p>

        <p>dans mon cas, j'ai certaines interfaces sélectionnées (celles intéressées par la sortie desdites tâches) exécutant un petit iframe</p>

        <div class="language-html highlighter-rouge">
          <code class='code' style='white-space:pre;'>
            <div class='code-line code-line-1'></div>
            <div class='code-line code-line-2'><span style="color: #6e7781">&lt;!-- déposer un exécuteur de file d'attente de tâches sur certaines pages/vues/dispositions --&gt;</span></div>
            <div class='code-line code-line-3'></div>
            <div class='code-line code-line-4'><span style="color: #116329">&lt;iframe</span> <span style="color: #116329">height=</span><span style="color: #0a3069">"0"</span> <span style="color: #116329">width=</span><span style="color: #0a3069">"0"</span> <span style="color: #116329">style=</span><span style="color: #0a3069">"display:none;"</span> <span style="color: #116329">src=</span><span style="color: #0a3069">"/travaux_javascript/exécuteur"</span><span style="color: #116329">&gt;&lt;/iframe&gt;</span></div>
            <div class='code-line code-line-5'></div>
            <div class='code-line code-line-6'></div>
          </code>
        </div>

        <div class="language-erb highlighter-rouge">
          <code class='code' style='white-space:pre;'>
            <div class='code-line code-line-1'></div>
            <div class='code-line code-line-2'><span style="color: #6e7781">&lt;!-- l'exécuteur de tâches --&gt;</span></div>
            <div class='code-line code-line-3'></div>
            <div class='code-line code-line-4'><span style="color: #6e7781">&lt;%=</span> <span style="color: #24292f;background-color: #f6f8fa">javascript_include_tag</span> <span style="color: #0a3069">:jquery</span> <span style="color: #6e7781">%&gt;</span></div>
            <div class='code-line code-line-5'><span style="color: #6e7781">&lt;%=</span> <span style="color: #24292f;background-color: #f6f8fa">javascript_include_tag</span> <span style="color: #0a3069">:travaux</span> <span style="color: #6e7781">%&gt;</span></div>
            <div class='code-line code-line-6'></div>
            <div class='code-line code-line-7'><span style="color: #116329">&lt;script&gt;</span></div>
            <div class='code-line code-line-8'>  <span style="color: #8250df">jQuery</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(){</span></div>
            <div class='code-line code-line-9'>    <span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">complete</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">tâche</span><span style="color: #24292f;background-color: #f6f8fa">){</span></div>
            <div class='code-line code-line-10'>      <span style="color: #953800">document</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">write</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">tâche complétée </span><span style="color: #0a3069">'</span> <span style="color: #0550ae">+</span> <span style="color: #24292f;background-color: #f6f8fa">tâche</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">id</span><span style="color: #24292f;background-color: #f6f8fa">);</span></div>
            <div class='code-line code-line-11'>      <span style="color: #953800">document</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">write</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">&lt;br&gt;</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">);</span></div>
            <div class='code-line code-line-12'>    <span style="color: #24292f;background-color: #f6f8fa">};</span></div>
            <div class='code-line code-line-13'></div>
            <div class='code-line code-line-14'>    <span style="color: #8250df">setTimeout</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(){</span> <span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">start</span><span style="color: #24292f;background-color: #f6f8fa">();</span> <span style="color: #24292f;background-color: #f6f8fa">},</span> <span style="color: #0550ae">1000</span><span style="color: #24292f;background-color: #f6f8fa">);</span></div>
            <div class='code-line code-line-15'>  <span style="color: #24292f;background-color: #f6f8fa">});</span></div>
            <div class='code-line code-line-16'><span style="color: #116329">&lt;/script&gt;</span></div>
            <div class='code-line code-line-17'></div>
            <div class='code-line code-line-18'></div>
          </code>
        </div>

        <p>le js nécessaire pour interagir avec la file d'attente de tâches est court et simple</p>

        <p>tout ce qu'il fait est d'obtenir une tâche, de l'exécuter et de l'envoyer au serveur - en respectant à la fois le débit et le nombre maximum de tâches à exécuter.</p>

        <div class="language-javascript highlighter-rouge">
          <code class='code' style='white-space:pre;'>
            <div class='code-line code-line-1'></div>
            <div class='code-line code-line-2'><span style="color: #cf222e">if</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">!</span><span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">){</span></div>
            <div class='code-line code-line-3'><span style="color: #6e7781">//</span></div>
            <div class='code-line code-line-4'>  <span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">travaux</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">{};</span></div>
            <div class='code-line code-line-5'>  <span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">count</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">;</span></div>
            <div class='code-line code-line-6'>  <span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">max</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">256</span><span style="color: #24292f;background-color: #f6f8fa">;</span></div>
            <div class='code-line code-line-7'>  <span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">throttle</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">1000</span><span style="color: #24292f;background-color: #f6f8fa">;</span></div>
            <div class='code-line code-line-8'>  <span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">complete</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(){};</span></div>
            <div class='code-line code-line-9'></div>
            <div class='code-line code-line-10'><span style="color: #6e7781">//</span></div>
            <div class='code-line code-line-11'>  <span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">get_next_job</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(){</span></div>
            <div class='code-line code-line-12'>    <span style="color: #cf222e">var</span> <span style="color: #24292f;background-color: #f6f8fa">success</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">response</span><span style="color: #24292f;background-color: #f6f8fa">){</span></div>
            <div class='code-line code-line-13'>      <span style="color: #24292f;background-color: #f6f8fa">tâche</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">response</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">'</span><span style="color: #0a3069">data</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">][</span><span style="color: #0a3069">'</span><span style="color: #0a3069">tâche</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">];</span></div>
            <div class='code-line code-line-14'></div>
            <div class='code-line code-line-15'>      <span style="color: #cf222e">if</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">tâche</span><span style="color: #24292f;background-color: #f6f8fa">){</span></div>
            <div class='code-line code-line-16'>        <span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">count</span><span style="color: #0550ae">++</span><span style="color: #24292f;background-color: #f6f8fa">;</span></div>
            <div class='code-line code-line-17'></div>
            <div class='code-line code-line-18'>        <span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">run</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">tâche</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">tâche</span><span style="color: #24292f;background-color: #f6f8fa">){</span></div>
            <div class='code-line code-line-19'>          <span style="color: #cf222e">if</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">count</span> <span style="color: #0550ae">&lt;</span> <span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">max</span><span style="color: #24292f;background-color: #f6f8fa">){</span></div>
            <div class='code-line code-line-20'>            <span style="color: #8250df">setTimeout</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">get_next_job</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">throttle</span><span style="color: #24292f;background-color: #f6f8fa">);</span></div>
            <div class='code-line code-line-21'>          <span style="color: #24292f;background-color: #f6f8fa">}</span></div>
            <div class='code-line code-line-22'>        <span style="color: #24292f;background-color: #f6f8fa">});</span></div>
            <div class='code-line code-line-23'>      <span style="color: #24292f;background-color: #f6f8fa">}</span></div>
            <div class='code-line code-line-24'>    <span style="color: #24292f;background-color: #f6f8fa">};</span></div>
            <div class='code-line code-line-25'></div>
            <div class='code-line code-line-26'>    <span style="color: #24292f;background-color: #f6f8fa">jQuery</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">ajax</span><span style="color: #24292f;background-color: #f6f8fa">({</span></div>
            <div class='code-line code-line-27'>      <span style="color: #0a3069">'</span><span style="color: #0a3069">url</span><span style="color: #0a3069">'</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #0a3069">'</span><span style="color: #0a3069">/api/travaux/next</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span></div>
            <div class='code-line code-line-28'>      <span style="color: #0a3069">'</span><span style="color: #0a3069">type</span><span style="color: #0a3069">'</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #0a3069">'</span><span style="color: #0a3069">GET</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span></div>
            <div class='code-line code-line-29'>      <span style="color: #0a3069">'</span><span style="color: #0a3069">cache</span><span style="color: #0a3069">'</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #0550ae">false</span><span style="color: #24292f;background-color: #f6f8fa">,</span></div>
            <div class='code-line code-line-30'>      <span style="color: #0a3069">'</span><span style="color: #0a3069">success</span><span style="color: #0a3069">'</span> <span style="color: #24292f;background-color: #f6f8fa">:</span> <span style="color: #24292f;background-color: #f6f8fa">success</span></div>
            <div class='code-line code-line-31'>    <span style="color: #24292f;background-color: #f6f8fa">});</span></div>
            <div class='code-line code-line-32'>  <span style="color: #24292f;background-color: #f6f8fa">};</span></div>
            <div class='code-line code-line-33'></div>
            <div class='code-line code-line-34'><span style="color: #6e7781">//</span></div>
            <div class='code-line code-line-35'>  <span style="color: #24292f;background-color: #f6f8fa">travaux</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">run</span> <span style="color: #0550ae">=</span> <span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">tâche</span><span style="color: #24292f;background-color: #f6f8fa">,</span> <span style="color: #24292f;background-color: #f6f8fa">callback</span><span style="color: #24292f;background-color: #f6f8fa">){</span></div>
            <div class='code-line code-line-36'>    <span style="color: #cf222e">var</span> <span style="color: #24292f;background-color: #f6f8fa">code</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">tâche</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">'</span><span style="color: #0a3069">code</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">];</span></div>
            <div class='code-line code-line-37'>    <span style="color: #cf222e">var</span> <span style="color: #24292f;background-color: #f6f8fa">result</span> <span style="color: #0550ae">=</span> <span style="color: #0550ae">undefined</span><span style="color: #24292f;background-color: #f6f8fa">;</span></div>
            <div class='code-line code-line-38'></div>
            <div class='code-line code-line-39'>    <span style="color: #24292f;background-color: #f6f8fa">callback</span> <span style="color: #0550ae">=</span> <span style="color: #24292f;background-color: #f6f8fa">callback</span> <span style="color: #0550ae">||</span> <span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(){};</span></div>
            <div class='code-line code-line-40'></div>
            <div class='code-line code-line-41'>    <span style="color: #cf222e">if</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">code</span><span style="color: #24292f;background-color: #f6f8fa">){</span></div>
            <div class='code-line code-line-42'>      <span style="color: #cf222e">try</span><span style="color: #24292f;background-color: #f6f8fa">{</span></div>
            <div class='code-line code-line-43'>        <span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(){