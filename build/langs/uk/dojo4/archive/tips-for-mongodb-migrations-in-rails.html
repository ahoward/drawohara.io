<html color-mode="user" lang="uk">
  <head>
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DQVD9T27V4');
</script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- langs -->
  <!--
    https://developers.google.com/search/docs/specialty/international/localized-versions#html
  -->
   <link rel="alternate" hreflang="en" href="/" />
   <link rel="alternate" hreflang="uk" href="https://drawohara.io/langs/uk" />
   <link rel="alternate" hreflang="sv" href="https://drawohara.io/langs/sv" />
   <link rel="alternate" hreflang="fr" href="https://drawohara.io/langs/fr" />
   <link rel="alternate" hreflang="es" href="https://drawohara.io/langs/es" />
   <link rel="alternate" hreflang="it" href="https://drawohara.io/langs/it" />

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

  <!-- meta -->
    <title>—Ç—É—Ç –Ω—ñ—á–æ–≥–æ –Ω–µ–º–∞—î.</title>

<meta property="og:title" content="—Ç—É—Ç –Ω—ñ—á–æ–≥–æ –Ω–µ–º–∞—î."/>
<meta property="og:description" content="–ø—Ä–æ–¥–æ–≤–∂—É–π—Ç–µ —Ä—É—Ö." />
<meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

  <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"tips-for-mongodb-migrations-in-rails"}">
    <meta property="site:path_info" content=""/tips-for-mongodb-migrations-in-rails"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) { progressBar.remove(); }
      });
    </script>

    <base href='/langs/uk' />
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a> &mdash;
<a href="mailto:i-love-this@drawohara.io?subject=/tips-for-mongodb-migrations-in-rails">—è ‚ù§Ô∏è —Ü–µ!</a>
<small>
  <small>
    <small>
      <span title='–≤–∏–ø–∏–π –º–µ–Ω–µ'>&lt;&lt; –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –º–µ–Ω–µ üêõ ü´ñ üßö</a>
    </small>
  </small>
</small>
<hr>
<strong>/tips-for-mongodb-migrations-in-rails</strong>
    </header>

    <main>
      <em>–æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ: 2011-12-27</em>
<br>
<br>
<p>–Ø —Ö–æ—á—É –ø–æ–¥—ñ–ª–∏—Ç–∏—Å—è —à–≤–∏–¥–∫–∏–º —ñ –ª–µ–≥–∫–∏–º –º–µ—Ç–æ–¥–æ–º –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ–π Rails –ø—Ä–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—ñ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö MongoDB. –ì–Ω—É—á–∫—ñ—Å—Ç—å –º–æ–Ω–≥–æ —ñ —Ä—É–±—ñ —Ä–æ–±–∏—Ç—å —Ü–µ –¥–æ—Å–∏—Ç—å –ø—Ä–æ—Å—Ç–∏–º. –£ —Ü—å–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ –º–∏ –±—É–¥–µ–º–æ –ø–µ—Ä–µ–π–º–µ–Ω–æ–≤—É–≤–∞—Ç–∏ –ø–æ–ª–µ –≤ –Ω–∞—à—ñ–π –ø—Ä–∏–∫–ª–∞–¥–Ω—ñ–π –∫–æ–ª–µ–∫—Ü—ñ—ó "books" –∑ "isbn" –Ω–∞ "book_number". –¶–µ –¥–æ—Å–∏—Ç—å –ø–æ—à–∏—Ä–µ–Ω–∏–π —Ç–∏–ø –º—ñ–≥—Ä–∞—Ü—ñ—ó, —ñ –∫–æ–ª–∏ –≤–∏ –æ—Å–≤–æ—ó—Ç–µ —Ü–µ–π –ø—Ä–æ—Å—Ç–∏–π –≤–∏–ø–∞–¥–æ–∫, –±—ñ–ª—å—à —Å–∫–ª–∞–¥–Ω—ñ –º—ñ–≥—Ä–∞—Ü—ñ—ó —Å–ª—ñ–¥—É—é—Ç—å —Ç–æ–º—É –∂ —à–∞–±–ª–æ–Ω—É. –°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä–∏–º–æ –Ω–∞—à —à–∞–±–ª–æ–Ω —Å–∫—Ä–∏–ø—Ç—É –º—ñ–≥—Ä–∞—Ü—ñ—ó –∑ —Ç–∞–π–º—à—Ç–∞–º–ø–æ–º.</p>
<pre><code>rails generate migration rename_isbn_to_book_number
</code>
</pre>
<p>–ü–æ—Ç—ñ–º –º–∏ –≤—ñ–¥—Ä–µ–¥–∞–≥—É—î–º–æ —Ñ–∞–π–ª, —è–∫–∏–π –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ –ø—ñ–¥ <code>db/migrate</code>. –ú–∏ —Ä–æ–∑–¥—ñ–ª–∏–º–æ –Ω–∞—à –∫–æ–¥ –Ω–∞ –∫—ñ–ª—å–∫–∞ —Ä–æ–∑–¥—ñ–ª—ñ–≤ –Ω–∞—Å—Ç—É–ø–Ω–∏–º —á–∏–Ω–æ–º.</p>
<ol>
<li>–î–µ—è–∫—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ –∫–ª–∞—Å—É, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –≤—Å—ñ–º–∞ –º–µ—Ç–æ–¥–∞–º–∏</li>
<li>–ú–µ—Ç–æ–¥ <code>self.up</code>, —è–∫–∏–π –≤–∏–∫–æ–Ω—É—î –ø—Ä—è–º—É –º—ñ–≥—Ä–∞—Ü—ñ—é</li>
<li>–î–æ–ø–æ–º—ñ–∂–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ø—Ä—è–º–æ—ó –º—ñ–≥—Ä–∞—Ü—ñ—ó</li>
<li>–ú–µ—Ç–æ–¥ <code>self.down</code>, —è–∫–∏–π –≤–∏–∫–æ–Ω—É—î –≤—ñ–¥–∫–∞—Ç</li>
<li>–î–æ–ø–æ–º—ñ–∂–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ) –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤—ñ–¥–∫–∞—Ç—É</li>
</ol>
<p>–°–ø–æ—á–∞—Ç–∫—É –≤–∏–∑–Ω–∞—á–∏–º–æ –¥–µ—è–∫—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏–º—É—Ç—å –Ω–∞—à—ñ –º–µ—Ç–æ–¥–∏. –ú–∏ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —Ö–µ—à –æ–ø—Ü—ñ–π –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –º–æ–Ω–≥–æ <code>MultiUpdate</code> –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ, –æ—Å–∫—ñ–ª—å–∫–∏ –±—ñ–ª—å—à—ñ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü—ñ–π –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –º—ñ–≥—Ä–∞—Ü—ñ—ó —Ö–æ—á—É—Ç—å upsert false (–Ω–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –Ω–æ–≤—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏), multi true (–æ–Ω–æ–≤–∏—Ç–∏ –≤—Å—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏) —ñ safe true.</p>
<p>–ü–æ—Ç—ñ–º –º–∏ —Ç–∞–∫–æ–∂ –≤–∏–∑–Ω–∞—á–∞—î–º–æ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –¥–ª—è —ñ–º–µ–Ω—ñ –∫–æ–ª–µ–∫—Ü—ñ—ó. –î–ª—è —Ä–µ–∞–ª—å–Ω–æ—ó –º—ñ–≥—Ä–∞—Ü—ñ—ó –∫–æ–ª–µ–∫—Ü—ñ—è - "books", –∞–ª–µ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –º–∏ —Å—Ç–≤–æ—Ä–∏–º–æ –Ω–æ–≤—É –∫–æ–ª–µ–∫—Ü—ñ—é –ø—ñ–¥ –Ω–∞–∑–≤–æ—é "test_books_migration", —Ä–æ–∑—Ä–æ–±–ª—è—é—á–∏ –Ω–∞—à –∫–æ–¥.</p>
<pre><code>class RenameIsbnToBookNumber &lt; Mongoid::Migration
  MultiUpdate = {:upsert =&gt; false, :multi =&gt; true, :safe=&gt;true}
  Collection = db.collection("books") #–§—ñ–Ω–∞–ª—å–Ω–∏–π –ø—Ä–æ–¥–∞–∫—à–Ω –∫–æ–¥
  Collection = db.collection("test_books_migration") #–¢—ñ–ª—å–∫–∏ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤ –∫–æ–Ω—Å–æ–ª—ñ
  def up
  end

  def down
  end
end
</code>
</pre>
<p>–û–ö, —Ü–µ –Ω–∞—à –ø–æ—á–∞—Ç–∫–æ–≤–∏–π —à–∞–±–ª–æ–Ω. –ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫ - –∑—Ä–æ–±–∏—Ç–∏ —Ä–µ–∑–µ—Ä–≤–Ω—É –∫–æ–ø—ñ—é –Ω–∞—à–æ—ó —Ä–æ–∑—Ä–æ–±–Ω–∏—Ü—å–∫–æ—ó –±–∞–∑–∏ –¥–∞–Ω–∏—Ö, —è–∫—â–æ —Ç–∞–º —î –¥–∞–Ω—ñ, —è–∫—ñ –º–∏ –Ω–µ —Ö–æ—á–µ–º–æ –≤–∏–ø–∞–¥–∫–æ–≤–æ –∑—ñ–ø—Å—É–≤–∞—Ç–∏. –ü–æ—Ç—ñ–º –º–∏ –ø–æ—á–Ω–µ–º–æ –ø–∏—Å–∞—Ç–∏ –Ω–µ–≤–µ–ª–∏–∫–∏–π –¥–æ–ø–æ–º—ñ–∂–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –Ω–∞—à–æ—ó —Ç–µ—Å—Ç–æ–≤–æ—ó –∫–æ–ª–µ–∫—Ü—ñ—ó —Ñ–µ–π–∫–æ–≤–∏–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏, —è–∫—ñ –Ω–∞–≥–∞–¥—É—é—Ç—å —Ç–µ, —â–æ –º–∏ –æ—á—ñ–∫—É—î–º–æ –ø–æ–±–∞—á–∏—Ç–∏ —É –≤–∏—Ä–æ–±–Ω–∏—Ü—Ç–≤—ñ, –∞–ª–µ –∑–æ—Å–µ—Ä–µ–¥–∂—É—é—á–∏—Å—å –Ω–∞ –ø–æ–ª—è—Ö, —è–∫—ñ —î —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–∏–º–∏ –¥–ª—è –º—ñ–≥—Ä–∞—Ü—ñ—ó. –î–æ–¥–∞–π—Ç–µ —Ü–µ–π –º–µ—Ç–æ–¥ –¥–æ –≤–∞—à–æ–≥–æ –∫–ª–∞—Å—É –º—ñ–≥—Ä–∞—Ü—ñ—ó.</p>
<pre><code>def mock_data_for_testing_up
  3.times {|number| Collection.insert({"isbn" =&gt; "#{number}"})}
end

def show_collection
  Collection.find({}).each {|_| puts _}
end
</code>
</pre>
<p>–¶–µ —Å—Ç–≤–æ—Ä–∏—Ç—å 3 —Ñ—ñ–∫—Ç–∏–≤–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏, —è–∫—ñ –º–∏ –∑–º–æ–∂–µ–º–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è. –ú–∏ —Ä–æ–∑–º—ñ—â—É—î–º–æ —Ü–µ–π –∫–æ–¥ —É –º–µ—Ç–æ–¥—ñ, —â–æ–± –π–æ–≥–æ –±—É–ª–æ –ª–µ–≥–∫–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏, –∫–æ–ª–∏ –º–∏ –Ω–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ —ñ —Ç–µ—Å—Ç—É—î–º–æ –Ω–∞—à –∫–æ–¥ –º—ñ–≥—Ä–∞—Ü—ñ—ó. –î–ª—è —Å–∫–ª–∞–¥–Ω–∏—Ö –º—ñ–≥—Ä–∞—Ü—ñ–π –º–æ–∂–µ –∑–Ω–∞–¥–æ–±–∏—Ç–∏—Å—è –±–∞–≥–∞—Ç–æ —Ä–∞—É–Ω–¥—ñ–≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è, —â–æ–± –≤—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—Å—ñ –≥—Ä–∞–Ω–∏—á–Ω—ñ –≤–∏–ø–∞–¥–∫–∏.</p>
<p>–¢–µ–ø–µ—Ä –º–∏ –º–æ–∂–µ–º–æ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –∫–æ–Ω—Å–æ–ª—å rails —ñ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Ü–µ–π –∫–æ–¥, —Å–∫–æ–ø—ñ—é–≤–∞–≤—à–∏ —Ç–∞ –≤—Å—Ç–∞–≤–∏–≤—à–∏ 2 –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏ –∫–ª–∞—Å—É —Ç–∞ –º–µ—Ç–æ–¥ mock_data_for_testing_up —É –∫–æ–Ω—Å–æ–ª—å, –∞ –ø–æ—Ç—ñ–º –∑–∞–ø—É—Å—Ç–∏–≤—à–∏ mock_data_for_testing_up</p>
<pre><code>$ bundle exec rails console
Loading development environment (Rails 3.1.1)
irb(main):001:0&gt; #–í—Å—Ç–∞–≤—Ç–µ –Ω–∞—Å—Ç—É–ø–Ω–µ –¥–æ –∫–æ–Ω—Å–æ–ª—ñ
MultiUpdate = {:upsert =&gt; false, :multi =&gt; true, :safe=&gt;true}
Collection = db.collection("test_books_migration") #–¢—ñ–ª—å–∫–∏ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤ –∫–æ–Ω—Å–æ–ª—ñ
def mock_data_for_testing_up
  3.times {|number| Collection.insert({"isbn" =&gt; "#{number}"})}
  Collection.find({}).each {|_| puts _}
end
def show_collection
  Collection.find({}).each {|_| puts _}
end
irb(main):008:0&gt; mock_data_for_testing_up
mock_data_for_testing_up
MONGODB app_development['test_books_migration'].insert([{"isbn"=&gt;"0", :_id=&gt;BSON::ObjectId('4ef5f43b2a4397a5d7000001')}])
MONGODB app_development['test_books_migration'].insert([{"isbn"=&gt;"1", :_id=&gt;BSON::ObjectId('4ef5f43b2a4397a5d7000002')}])
MONGODB app_development['test_books_migration'].insert([{"isbn"=&gt;"2", :_id=&gt;BSON::ObjectId('4ef5f43b2a4397a5d7000003')}])
irb(main):009:0&gt; show_collection
MONGODB app_development['test_books_migration'].find({})
{"_id"=&gt;BSON::ObjectId('4ef5f3812a4397a5bd000001'), "isbn"=&gt;"0"}
{"_id"=&gt;BSON::ObjectId('4ef5f3812a4397a5bd000002'), "isbn"=&gt;"1"}
{"_id"=&gt;BSON::ObjectId('4ef5f3812a4397a5bd000003'), "isbn"=&gt;"2"}
=&gt; nil
</code>
</pre>
<p>–¢–µ–ø–µ—Ä —É –Ω–∞—Å —î –æ–∫—Ä–µ–º–∞, –¥–æ–±—Ä–µ –∑—Ä–æ–∑—É–º—ñ–ª–∞ —Ç–µ—Å—Ç–æ–≤–∞ –∫–æ–ª–µ–∫—Ü—ñ—è, –≥–æ—Ç–æ–≤–∞ –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –Ω–∞—à–æ—ó –ø—Ä–æ—Å—Ç–æ—ó –º—ñ–≥—Ä–∞—Ü—ñ—ó. –î–∞–≤–∞–π—Ç–µ –Ω–∞–ø–∏—à–µ–º–æ –Ω–∞—à <code>up</code> –º–µ—Ç–æ–¥. –©–æ–± –∑—Ä–æ–±–∏—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—é.</p>
<pre><code>def up
  #–ú–∏ —Ö–æ—á–µ–º–æ –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏ –ø–æ–ª–µ book.isbn –Ω–∞ book.book_number
  Collection.find({"isbn" =&gt; {"$exists" =&gt; 1}}).each do |book|
    update_op = {
      "$unset" =&gt; {"isbn" =&gt; 1},
      "$set" =&gt; {"book_number" =&gt; book["isbn"]}
    }
  Collection.update({"_id" =&gt; book["_id"]}, update_op, MultiUpdate)
end
</code>
</pre>
<p>–ú–∏ –º–æ–∂–µ–º–æ –≤—Å—Ç–∞–≤–∏—Ç–∏ —Ü–µ –≤ –∫–æ–Ω—Å–æ–ª—å —ñ –∑–∞–ø—É—Å—Ç–∏—Ç–∏, —â–æ–± –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –Ω–∞—à—É –º—ñ–≥—Ä–∞—Ü—ñ—é. –ú–∏ –º–æ–∂–µ–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é <code>show_colletion</code>. –Ø–∫—â–æ –º–∏ —Ö–æ—á–µ–º–æ –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ —ñ–Ω—à—ñ –∑–∞–ø–∏—Å–∏ –¥–ª—è –≤—ñ–¥–∫–∞—Ç—É, –º–∏ –º–æ–∂–µ–º–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –º–µ—Ç–æ–¥ <code>mock_data_for_testing_down</code>.</p>
<p>–¶–µ –º–∞—î –¥–∞—Ç–∏ –≤–∞–º –¥—É–∂–µ —à–≤–∏–¥–∫–∏–π —Å–ø–æ—Å—ñ–± –µ–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—É–≤–∞—Ç–∏ —Ç–∞ –∑—Ä–æ–±–∏—Ç–∏ –≤–∞—à –∫–æ–¥ –º—ñ–≥—Ä–∞—Ü—ñ—ó –ø—Ä–∞—Ü–µ–∑–¥–∞—Ç–Ω–∏–º. –ú–æ–Ω–≥–æ –º–∞—î –¥–µ—è–∫—ñ –ø–æ—Ç—É–∂–Ω—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –∑–∞–ø–∏—Ç—ñ–≤ —ñ –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ–π, —è–∫—ñ –º–æ–∂—É—Ç—å —Ä–æ–±–∏—Ç–∏ –¥–∏–≤–æ–≤–∏–∂–Ω—ñ —Ä–µ—á—ñ, —ñ –ª–µ–≥–∫–∏–π —Å–ø–æ—Å—ñ–± —Ä–æ–±–∏—Ç–∏ –¥–µ—è–∫—ñ –ø—Ä–æ–±–∏ —ñ –ø–æ–º–∏–ª–∫–∏ —î –∫–æ—Ä–∏—Å–Ω–∏–º. –Ø–∫—â–æ –≤–∏ –∑–∞–±—Ä—É–¥–Ω–∏—Ç–µ —Å–≤–æ—ó —Ç–µ—Å—Ç–æ–≤—ñ –¥–∞–Ω—ñ, –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ <code>Collection.drop</code>, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —á–∏—Å—Ç–∏–π –∞—Ä–∫—É—à. –û—Å—å —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –∫–æ–¥ –º—ñ–≥—Ä–∞—Ü—ñ—ó –¥–ª—è –¥–æ–≤—ñ–¥–∫–∏. <strong>–ù–µ –∑–∞–±—É–¥—å—Ç–µ</strong> –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É —Ç–µ—Å—Ç–æ–≤–æ—ó –∫–æ–ª–µ–∫—Ü—ñ—ó —Ç–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ—Å—Ç–æ–≤—É –∫–æ–ª–µ–∫—Ü—ñ—é –∑ –≤–∞—à–æ—ó –±–∞–∑–∏ –¥–∞–Ω–∏—Ö, –∫–æ–ª–∏ –≤–∏ –≥–æ—Ç–æ–≤—ñ –ø–æ—á–∞—Ç–∏ –∑–∞–ø—É—Å–∫–∞—Ç–∏ —Å–≤—ñ–π –∫–æ–¥ —É —Ä–µ–∞–ª—å–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ –∑ <code>rake db:migrate</code>.</p>
<pre><code>class RenameIsbnToBookNumber &lt; Mongoid::Migration
  MultiUpdate = {:upsert =&gt; false, :multi =&gt; true, :safe=&gt;true}
  Collection = db.collection("books") #–§—ñ–Ω–∞–ª—å–Ω–∏–π –ø—Ä–æ–¥–∞–∫—à–Ω –∫–æ–¥

  def up
    #–ú–∏ —Ö–æ—á–µ–º–æ –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏ –ø–æ–ª–µ book.isbn –Ω–∞ book.book_number
    Collection.find({"isbn" =&gt; {"$exists" =&gt; 1}}).each do |book|
      update_op = {
        "$unset" =&gt; {"isbn" =&gt; 1},
        "$set" =&gt; {"book_number" =&gt; book["isbn"]}
      }
      Collection.update({"_id" =&gt; book["_id"]}, update_op, MultiUpdate)
    end
  end

  def down
    #–ú–∏ —Ö–æ—á–µ–º–æ –ø–µ—Ä–µ–π–º–µ–Ω—É–≤–∞—Ç–∏ –ø–æ–ª–µ book.book_number –Ω–∞ book.isbn
    Collection.find({"book_number" =&gt; {"$exists" =&gt; 1}}).each do |book|
      update_op = {
        "$unset" =&gt; {"book_number" =&gt; 1},
        "$set" =&gt; {"isbn" =&gt; book["book_number"]}
      }
      Collection.update({"_id" =&gt; book["_id"]}, update_op, MultiUpdate)
    end
  end

  #–¶—ñ –º–µ—Ç–æ–¥–∏ –Ω–µ –≤–∏–∫–ª–∏–∫–∞—é—Ç—å—Å—è –º—ñ–≥—Ä–∞—Ü—ñ—î—é. –õ–∏—à–µ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
  #—à–ª—è—Ö–æ–º –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è/–≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –≤ –∫–æ–Ω—Å–æ–ª—å
  #–©–æ–± –ø—Ä–æ—Ç–µ—Å—Ç—É–≤–∞—Ç–∏ (—à–ª—è—Ö–æ–º –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è/–≤—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –∑–≤—ñ–¥—Å–∏ –≤ –∫–æ–Ω—Å–æ–ª—å)
  #1. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É MultiUpdate. –ù–∞–ª–∞—à—Ç—É–π—Ç–µ "Collection", —â–æ–± —Ü–µ –±—É–ª–∞ —Ç–µ—Å—Ç–æ–≤–∞ –∫–æ–ª–µ–∫—Ü—ñ—è
  #2. –°–∫–æ–ø—ñ—é–π—Ç–µ/–≤—Å—Ç–∞–≤—Ç–µ 2 –º–µ—Ç–æ–¥–∏ –Ω–∏–∂—á–µ
  #2. –ó–∞–ø—É—Å—Ç—ñ—Ç—å mock_data_for_testing_up
  #3. –ó–∞–ø—É—Å—Ç—ñ—Ç—å —Ç—ñ–ª–æ self.up
  #3b. –û–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ –∑–∞–ø—É—Å—Ç—ñ—Ç—å —Ç—ñ–ª–æ self.up –∑–Ω–æ–≤—É, —â–æ–± –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è, —â–æ –≤–æ–Ω–æ —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–µ
  def mock_data_for_testing_up
    3.times {|number| Collection.insert({"isbn" =&gt; "#{number}"})}
  end

  def show_collection
    Collection.find({}).each {|_| puts _}
  end
end
</code>
</pre>
    </main>

    <footer>
      <hr>
<a href="/goto" name="goto">&mdash;&gt; goto</a>
<blockquote>
<ul>
  <li>
    <a href="mailto:i-hate-this@drawohara.io?subject=/tips-for-mongodb-migrations-in-rails">üò©, —è üñ§ ^—Ü–µ!<a>
  </li>
  <li>
    <a href="/now">/now<a>
  </li>
  <li>
    <a href="/about">/about<a>
  </li>
  <li>
    <a href="/contact">/contact<a>
  </li>
</ul>
</blockquote>
<a href="/">&lt;&mdash; eject</a>
    </footer>
  </body>
</html>