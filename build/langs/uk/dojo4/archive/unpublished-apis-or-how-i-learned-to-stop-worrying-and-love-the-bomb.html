<html color-mode="user" lang="uk">
  <head>
  <base href='/langs/uk' />
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DQVD9T27V4');
</script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- langs -->
  <!--
    https://developers.google.com/search/docs/specialty/international/localized-versions#html
  -->
   <link rel="alternate" hreflang="en" href="/" />
   <link rel="alternate" hreflang="uk" href="https://drawohara.io/langs/uk" />
   <link rel="alternate" hreflang="sv" href="https://drawohara.io/langs/sv" />
   <link rel="alternate" hreflang="fr" href="https://drawohara.io/langs/fr" />
   <link rel="alternate" hreflang="es" href="https://drawohara.io/langs/es" />
   <link rel="alternate" hreflang="it" href="https://drawohara.io/langs/it" />

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

  <!-- meta -->
    <title>–¢—É—Ç –Ω—ñ—á–æ–≥–æ –Ω–µ–º–∞—î.</title>

<meta property="og:title" content="–¢—É—Ç –Ω—ñ—á–æ–≥–æ –Ω–µ–º–∞—î."/>
<meta property="og:description" content="–†—É—Ö–∞–π—Ç–µ—Å—è –¥–∞–ª—ñ." />
<meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

  <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"unpublished-apis-or-how-i-learned-to-stop-worrying-and-love-the-bomb"}">
    <meta property="site:path_info" content=""/unpublished-apis-or-how-i-learned-to-stop-worrying-and-love-the-bomb"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) { progressBar.remove(); }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a> &mdash;
<a href="mailto:i-love-this@drawohara.io?subject=/unpublished-apis-or-how-i-learned-to-stop-worrying-and-love-the-bomb">—è ‚ù§Ô∏è —Ü–µ!</a>
<small>
  <small>
    <small>
      <span title='–≤–∏–ø–∏–π —Ü–µ'>&lt;&lt; –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –º–µ–Ω–µ üêõ ü´ñ üßö</a>
    </small>
  </small>
</small>
<hr>
<strong>/unpublished-apis-or-how-i-learned-to-stop-worrying-and-love-the-bomb</strong>
    </header>

    <main>
      <em>–æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ: 2014-04-16</em>
<br>
<br>
<div class="ro markdown">
  <p>–Ü–Ω–æ–¥—ñ —É –≤–∞—Å —î –Ω—É–¥–Ω–µ –ø–æ–≤—Ç–æ—Ä—é–≤–∞–Ω–µ –æ–Ω–ª–∞–π–Ω-–∑–∞–≤–¥–∞–Ω–Ω—è –∞–±–æ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏ —á–∞—Å—Ç–∏–Ω—É –∞–±–æ –≤–µ—Å—å —Ä–æ–±–æ—á–∏–π –ø—Ä–æ—Ü–µ—Å –Ω–∞ –≤–µ–±-—Å–∞–π—Ç—ñ. –°–∫—Ä–∏–ø—Ç—É–≤–∞–Ω–Ω—è —Ü–∏—Ö –≤–∑–∞—î–º–æ–¥—ñ–π –º–æ–∂–µ –∑–∞–ø–æ–±—ñ–≥—Ç–∏ —Ç–æ–º—É, —â–æ –º–∏ –≤–∏—Ç—Ä–∞—á–∞—î–º–æ —Ç–æ–Ω–Ω–∏ –ª—é–¥—Å—å–∫–∏—Ö –≥–æ–¥–∏–Ω –Ω–∞ –º–æ–Ω–æ—Ç–æ–Ω–Ω–µ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –Ω–∞ —Ç—ñ —Å–∞–º—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –Ω–∞ —Å–∞–π—Ç—ñ.</p>

<p>–ë–∞–≥–∞—Ç–æ –∑ –Ω–∞—Å –æ–¥—Ä–∞–∑—É –∂ —Å—è–≥–Ω—É—Ç—å –∑–∞ <a href="http://mechanize.rubyforge.org/">Mechanize</a>. –ü–æ—Ç—ñ–º –≤–∏ –¥—ñ–∑–Ω–∞—î—Ç–µ—Å—è, —â–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–∞–π—Ç—É, —è–∫–∏–π –≤–∏ –Ω–∞–º–∞–≥–∞—î—Ç–µ—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è, –Ω–∞–ø–æ–≤–Ω–µ–Ω–∏–π JavaScript –∞–±–æ AJAX. –©–æ —Ç–µ–ø–µ—Ä –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏?</p>

<p><a href="http://http://phantomjs.org/">Phantomjs</a> –Ω–∞ –¥–æ–ø–æ–º–æ–≥—É. Phantomjs ‚Äî —Ü–µ —à–≤–∏–¥–∫–∏–π, –ª–µ–≥–∫–æ —Å–∫—Ä–∏–ø—Ç—É–≤–∞—Ç–∏ –±–µ–∑–≥–æ–ª–æ–≤–∏–π –±—Ä–∞—É–∑–µ—Ä WebKit. –ö–æ–ª–∏ —Ä–æ–±–æ—Ç–∞ –ø—Ä–æ–≤–∞–ª—é—î—Ç—å—Å—è –∑ —è–∫–æ—ó—Å—å –ø—Ä–∏—á–∏–Ω–∏, –≤–∏ –º–æ–∂–µ—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ —Å–∫—Ä—ñ–Ω—à–æ—Ç –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É. –î–ª—è –Ω–∞—Å —Ü–µ –æ–∑–Ω–∞—á–∞–ª–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –π–æ–≥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—É, –æ—Å–∫—ñ–ª—å–∫–∏ —Ä–æ–±–æ—Ç–∏ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞—Ö, –∞ –Ω–µ –ª–æ–∫–∞–ª—å–Ω–æ. –ú–∏ —Ç–∞–∫–æ–∂ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ <a href="https://github.com/westoque/phantomjs.rb">Phantomjs.rb</a>, —â–æ–± –æ–±—Ä–æ–±–ª—è—Ç–∏ —à–ª—è—Ö —ñ –≤–∏—Ö—ñ–¥ –∑ Phantomjs.</p>

<p>–û—Å—å —Ç—Ä–æ—Ö–∏ –∫–æ–¥—É –∑ —Ç–æ–≥–æ, —â–æ –º–∏ —Ä–æ–±–∏–º–æ.</p>

<pre><code>class InvitationAcceptor
  attr_accessor :invitation, :tmpdir

  def initialize(invitation)
    self.invitation = invitation
  end

  def accept!
    fail_image_path = false

    Dir.mktmpdir(invitation.id.to_s) do |tmpdir|
      self.tmpdir = tmpdir

      Phantomjs.inline(js) do |line|
        puts line
        fail_image_path = line.gsub('FAIL:', '').chomp if line.starts_with?('FAIL')
      end

      if fail_image_path
        Mailer.invitaion_failed(invitation, fail_image_path).deliver
      else
        invitation.invitation_accepted!
      end
    end
  end

  private

    def js
      fail_image = "#{tmpdir}/failed.png"

      &lt;&lt;-JS
        // https://github.com/ariya/phantomjs/blob/master/examples/waitfor.js
        function waitFor(testFx, onReady, timeOutMillis) {
          var maxtimeOutMillis = timeOutMillis ? timeOutMillis : 10000,
            start = new Date().getTime(),
            condition = false
          var interval = setInterval(function() {
            if ((new Date().getTime() - start &lt; maxtimeOutMillis) &amp;&amp; !condition) {
              condition = (typeof(testFx) === "string" ? eval(testFx) : testFx());
            } else {
              if (! condition) {
                fail()
              } else {
                console.log("'waitFor()' waited " + (new Date().getTime() - start) + "ms.");
                typeof(onReady) === "string" ? eval(onReady) : onReady();
                clearInterval(interval);
              }
            }
          }, 250);
        };

        var page = require('webpage').create(),
          testindex = 0,
          loadInProgress = false,
          tries = 0;

        // this is important for our app because the site we're automating tries to block automation.
        page.settings.userAgent = 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.116 Safari/537.36'

        var fail = function() {
          // send the fail message and image path to the Ruby script
          console.log("FAIL:#{fail_image}");
          // save the screenshot to the file system so it can be emailed
          page.render("#{fail_image}");
          phantom.exit()
        }

        page.onConsoleMessage = function(msg) {
          console.log(msg);
        };

        page.onLoadStarted = function() {
          loadInProgress = true;
          console.log("load started");
        };

        page.onLoadFinished = function(status) {
          loadInProgress = false;
          console.log("load finished");
        };

        var steps = [
          function() {
            console.log("Load Login Page");

            page.open("#{invitation.invitation_received.subject}")
          },
          function() {
            console.log("Verify the invitation is still valid");

            success = page.evaluate(function() {
              if (null == document.getElementById('hasSomeElement')) {
                return false;
              }

              return true;
            })

            if (! success) {
              fail();
            }

          },
          function() {
            console.log("Enter Credentials");

            page.evaluate(function() {
              document.getElementById('hasSomeElement').checked;
              document.getElementById('hasSomeElement').checked;
              document.getElementById('email').value = '#{invitation.email}';
              document.getElementById('password').value = '#{invitation.password}';
              document.getElementById('login').click();
            });
          },
          function() {
            console.log("Accepting the terms");

            page.evaluate(function() {
              document.getElementById('accept').click()
            });
          },
          function() {
            console.log("Waiting for the JS craziness to complete");

            waitFor(function() {
              return page.evaluate(function() {
                return document.getElementsByClassName('someExpectedContent').length != 0
              });
            }, function() {
              phantom.exit();
            });
          }
        ]

        interval = setInterval(function() {
          if (!loadInProgress &amp;&amp; typeof steps[testindex] == "function") {
            steps[testindex]();
            // useful for debugging
            page.render("#{tmpdir}/step" + (testindex + 1) + ".png");
            testindex++;
          }
        }, 250);
      JS
    end

end
</code></pre>

<p>–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤—Å—Ç–∞–≤–ª—è—Ç–∏ —Å–∫—Ä–∏–ø—Ç–∏ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é <a href="http://phantomjs.org/api/webpage/method/inject-js.html">injectJs</a> –∞–±–æ <a href="http://phantomjs.org/api/webpage/method/include-js.html">includeJs</a>, –∞–ª–µ —è –≤—ñ–¥–¥–∞—é –ø–µ—Ä–µ–≤–∞–≥—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ç–µ, —â–æ –≤–∂–µ —î –∞–±–æ –ø—Ä–æ—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±–∞–∑–æ–≤—ñ –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –±—É–¥—å-—è–∫–∏—Ö –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ –∑ —Ç–∏–º, —â–æ –º–æ–∂–µ –±—É—Ç–∏ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ.</p>

</div>
    </main>

    <footer>
      <hr>
<a href="/goto" name="goto">&mdash;&gt; goto</a>
<blockquote>
<ul>
  <li>
    <a href="mailto:i-hate-this@drawohara.io?subject=/unpublished-apis-or-how-i-learned-to-stop-worrying-and-love-the-bomb">üò©, —è üñ§ ^—Ü–µ!<a>
  </li>
  <li>
    <a href="/now">/now<a>
  </li>
  <li>
    <a href="/about">/about<a>
  </li>
  <li>
    <a href="/contact">/contact<a>
  </li>
</ul>
</blockquote>
<a href="/">&lt;&mdash; eject</a>
    </footer>
  </body>
</html>