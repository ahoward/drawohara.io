```html
<html color-mode="user" lang="uk">
  <head>
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DQVD9T27V4');
</script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

  <!-- meta -->
    <title>Виявлення мобільних пристроїв за CDN</title>

<meta property="og:title" content="Виявлення мобільних пристроїв за CDN"/>
<meta property="og:description" content="Продовжуйте рух." />
<meta property="og:image" content="https://drawohara.io/media/mick.jpg" />


  <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"mobile-detection-behind-a-cdn"}">
    <meta property="site:path_info" content=""/mobile-detection-behind-a-cdn"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) {
          progressBar.remove();
        }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a>
<hr>
    </header>

    <main>
      <div class="ro markdown">
  <p>У недавньому проєкті ми отримали завдання створити мобільну версію існуючого веб-сайту. Існуючий веб-сайт не був хорошим кандидатом для адаптивного дизайну, тому ми вирішили створити абсолютно нову версію сайту для мобільних пристроїв.</p>

<p>![5547851770<em>3598506559_z.jpg](assets/b.jpeg)<br />
_(фото від <a href="https://www.flickr.com/photos/johanl/5547851770/in/photolist-9sfc3J-63nmeT-3BAAy-dWUBhB-pAZUn-ccjB1w-st5Gc-7B2UEE-bbLNKX-8yTj9M-9e6jeJ-72jTj6-8RU8QS-5TNHyH-8FkSqy-5r7dgL-5A6ymJ-atHdpQ-7BbKMK-8P8X2-7bD7t6-2ViX1A-5E6qqL-6NDF76-9hBh7m-4bSRnn-sZomP-6VbEE-buapa2-5Kw5si-85KrwR-5kpSzg-bjEUUE-bV9J19-5GXRmg-6zbLPt-8yWpiA-akq64F-5n4ciA-9hmSj5-msHvhK-hZpPt-bFe25b-Bjwzo-mFYCVT-d3v8y-6wRQrs-f1p7uv-f8rrUJ-ebxiKS">Johan Larsson</a>)</em></p>

<p>Спочатку ми розглядали використання шаблону m.example.com, де сайти є абсолютно окремими доменами. Однак, оскільки ми не керуємо інфраструктурою для цього сайту, ми хотіли вибрати підхід, який вимагав би якнайменше змін інфраструктури. Підтримка іншого домену на тих самих серверах не дуже складна, але це просто ще одне завдання, яке легко зробити погано і необов'язкове в нашому випадку.</p>

<p>Я також випустив цю техніку для будь-кого, щоб легко використовувати її в додатку Rails через двигун Rails:</p>

<ul>
  <li>https://github.com/milesmatthias/cdddn</li>
  <li>http://rubygems.org/gems/cdddn</li>
</ul>

<h2 id="intro-to-cloudfront">Вступ до CloudFront</h2>

<p>Однією з великих переваг цього конкретного веб-сайту є те, що він використовує <a href="http://aws.amazon.com/cloudfront/">CloudFront</a>. CloudFront — це мережа доставки контенту (CDN), де статичні веб-сторінки розміщуються на <a href="http://aws.amazon.com/cloudfront/details/">52 дата-центрах по всьому світу</a>. Це дозволяє сторінці надсилатися до браузера якнайшвидше, тому що незалежно від того, де ви знаходитесь у світі, ви не будете далеко від одного із вузлів CloudFront, тому це займе менше часу для доставки веб-сайту на ваш пристрій. CloudFront є частиною пропозиції Amazon AWS і, крім гарантії швидкості, вони гарантують час роботи. (На відміну від <a href="http://aws.amazon.com/s3/">S3</a>, де гарантується лише час роботи.)</p>

<p>Коли ви використовуєте CloudFront, ви повідомляєте йому, де знаходиться ваш веб-сервер, щоб CloudFront міг отримати останню версію веб-сторінок, які він обслуговує для вас. CloudFront також запитує оновлені версії ваших веб-сторінок у вашого веб-сервера раз на кілька хвилин або в будь-який інтервал часу, який ви налаштовуєте на панелі CloudFront. Зазвичай це близько 24 годин. Це дозволяє CloudFront зосередитися на доступності та швидкості, значно зменшуючи навантаження на ваш веб-сервер. (Це також займає час, щоб CloudFront взяв нову версію сторінки та оновив усі 52 дата-центри.)</p>

<p>Однак це викликає проблему відстеження стану. Наприклад, якщо ваш сайт повністю обслуговується CloudFront, як ви підтримуєте користувачів, які увійшли в систему? Якщо я користувач на ім'я Боб, і сторінка <code>/my/account</code> каже «Привіт, Боб!», CloudFront вважатиме, що всі, хто запитує сторінку <code>/my/account</code>, повинні бачити версію сторінки, яка каже «Привіт, Боб!». Користувачі (можливо, крім людей на ім'я Боб...) будуть дуже збентежені. Крім того, що робити, якщо користувач оновлює якесь значення в своєму обліковому записі та очікує, що ця зміна відобразиться миттєво? CloudFront не отримує нову версію сторінки при кожному запиті (це б трохи порушувало б сенс CloudFront), він чекає кілька хвилин, щоб отримати нову версію. CloudFront розв'язав кілька таких питань за допомогою <a href="http://aws.amazon.com/cloudfront/dynamic-content/">нових функцій</a>, але ви повинні бути обізнані про ці наслідки при використанні CloudFront.</p>

<p>У нашому випадку сайт, над яким ми працюємо, не має концепції «користувачів», і ніхто не може увійти в систему. Однак ми все одно хочемо, щоб CloudFront показував різні версії сайту в залежності від того, з якого пристрою ви запитуєте сайт (мобільний чи настільний).</p>

<p>CloudFront може виконувати виявлення пристроїв для вас, а потім надсилати спеціальний заголовок на ваш веб-сервер, щоб сказати «Дайте мені версію сторінки для телефону», однак ми хотіли контролювати метод виявлення пристроїв (відповідаючи на питання — це телефон чи настільний?) і ми хотіли мати можливість для кінцевих користувачів і розробників перевизначати обраний ними пристрій. Наприклад, кінцеві користувачі на планшетах можуть просто захотіти побачити настільну версію, хоча ми спочатку показуємо їм мобільну версію. Нашим розробникам також буде незручно перемикати свій пристрій кожного разу, коли вони хочуть перемикатися між версіями під час побудови сайту.</p>

<h2 id="our-solution">Наше рішення</h2>

<p>Ось метод, який ми придумали, щоб мати як настільну, так і мобільну версії сайту на одному домені та обслуговувати їх через CloudFront. Одним обов'язковим зауваженням є те, що CloudFront зазвичай відключає всі файли cookie для вашого домену, але ви можете налаштувати його так, щоб дозволити файли cookie, які ви називаєте. У нашому випадку ми сказали CloudFront дозволити файл cookie під назвою «device». Також варто відзначити, що ми знаходимося в контексті додатка Rails 4, але цю архітектуру можна повторити в будь-якому стеку. Основна ідея тут полягає в тому, що клієнт повинен визначити, з якого пристрою користувач, дозволити їм перевизначити це, і тримати сервер в курсі типу пристрою, щоб сервер міг обслуговувати правильні сторінки (це робиться за допомогою файлів cookie).</p>

<h3 id="on-every-page-we-need-to-do-something-like-this-snippet-from-appviewslayoutapplicationhtmlerb">На кожній сторінці нам потрібно зробити щось схоже на це (уривок з app/views/layout/application.html.erb)</h3>

<pre><code class="language-html+erb">&lt;%= javascript_include_tag "mobile_detection" %&gt;

&lt;script&gt;

  if (!window.location.href.match(/get_device|set_device/)){
    console.log('logging the window.location.href = ' + window.location.href);
    localStorage.setItem('referrer_href', window.location.href);
  }

  var device_cookie  = cookie.get('device'),
      cookiesEnabled = cookie.enabled();

  if (cookiesEnabled &amp;&amp; device_cookie == undefined) {
    window.location = '/get_device.html'
  }

&lt;/script&gt;
</code></pre>

<p>Вищевказаний код просто запам'ятовує, на якій сторінці ви опинилися (зазвичай це головна сторінка, але ми хочемо, щоб клієнт міг ділитися посиланнями і щоб це працювало на мобільних пристроях), а потім перенаправляє вас на сторінку <code>/get_device</code>, щоб виявити ваш пристрій, якщо ми ще не зробили цього. Зверніть увагу на використання <code>localStorage</code>, що означає, що це працюватиме лише в IE8+ і не працюватиме в Opera Mini.</p>

<p>Також зверніть увагу, що вищевказаний фрагмент розміщений у тегу <code>&lt;head&gt;</code> макету, щоб його виконували якнайшвидше та перед будь-якими скриптами, які можуть бути у настільній версії. У цьому випадку настільна версія інтенсивно використовує JavaScript для завантаження великої кількості контенту, тому ми точно не хотіли, щоб все це відбувалося на телефоні, перш ніж сайт визначив, що користувач повинен бачити мобільну версію сайту.</p>

<h3 id="on-every-mobile-page-we-need-to-do-this-from-appviewslayoutapplicationmobileerb">На кожній мобільній сторінці нам потрібно зробити це (з `app/views/layout/application.mobile.erb):</h3>

<div class="language-js highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #24292f;background-color: #f6f8fa">script</span><span style="color: #0550ae">&gt;</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">device_cookie</span>&nbsp;&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">get</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">device</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">),</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookiesEnabled</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">enabled</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
</div><div class='code-line code-line-4'>&nbsp;
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">if </span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">cookiesEnabled</span>&nbsp;<span style="color: #0550ae">&amp;&amp;</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">device_cookie</span>&nbsp;<span style="color: #0550ae">==</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">desktop</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">)</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">reload</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">true</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #116329">/script</span><span style="color: #f6f8fa;background-color: #82071e">&gt;</span>
</div></code></div>

<p>Це тому, що мобільні пристрої сильно кешують сторінки (що має сенс), тому, якщо користувач змінив свій пристрій, ми повинні переконатися, що відправили цей оновлений файл cookie на сервер, навіть якщо URL не змінився (і, отже, кеш вважає, що це та сама сторінка, яку потрібно показати). <code>true</code> у виклику функції <code>reload</code> каже браузеру ігнорувати те, що знаходиться в кеші.</p>

<p>Зверніть увагу, що ми робимо те саме на кожній настільній сторінці, окрім перевірки, чи користувач змінив свій пристрій на <code>'mobile'</code>.</p>

<h3 id="device-detection-at-get_device-appviewshomeget_devicehtml">Виявлення пристроїв на <code>/get_device</code> (app/views/home/get_device.html)</h3>

<div class="language-js highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #24292f;background-color: #f6f8fa">script</span><span style="color: #0550ae">&gt;</span>
</div><div class='code-line code-line-2'>&nbsp;
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">function</span>&nbsp;<span style="color: #8250df">isMobile</span><span style="color: #24292f;background-color: #f6f8fa">(){</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">MOBILE_USER_AGENTS</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">palm|blackberry|nokia|phone|midp|mobi|symbian|chtml|ericsson|minimo|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">audiovox|motorola|samsung|telit|upg1|windows ce|ucweb|astel|plucker|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">x320|x240|j2me|sgh|portable|sprint|docomo|kddi|softbank|android|mmp|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">pdxgw|netfront|xiino|vodafone|portalmmm|sagem|mot-|sie-|ipod|up</span><span style="color: #0a3069">\\</span><span style="color: #0a3069">.b|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">webos|amoi|novarra|cdm|alcatel|pocket|ipad|iphone|mobileexplorer|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">mobile|zune</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">mobile_regex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">new</span>&nbsp;<span style="color: #953800">RegExp</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">MOBILE_USER_AGENTS</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">i</span><span style="color: #0a3069">"</span><span