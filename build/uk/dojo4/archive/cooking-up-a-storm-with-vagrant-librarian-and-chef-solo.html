```html
<html color-mode="user" lang="uk">
  <head>
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DQVD9T27V4');
</script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

  <!-- meta -->
    <title>Готуємо шторм з Vagrant, Librarian та Chef-Solo</title>

<meta property="og:title" content="Готуємо шторм з Vagrant, Librarian та Chef-Solo"/>
<meta property="og:description" content="йдіть далі." />
<meta property="og:image" content="https://drawohara.io/media/mick.jpg" />


  <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"cooking-up-a-storm-with-vagrant-librarian-and-chef-solo"}">
    <meta property="site:path_info" content=""/cooking-up-a-storm-with-vagrant-librarian-and-chef-solo"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) {
          progressBar.remove();
        }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a>
<hr>
    </header>

    <main>
      <div class="ro markdown">
  <p>Налаштування apache на одній системі нескладно. Це стає цікавіше, якщо у вас є кілька віртуальних хостів. Навіть цікавіше, коли у вас складна конфігурація, яка включає проксі, перенаправлення URL і підстановку тексту.</p>

<p>Та все ж таки, нічого складного для досвідченого системного адміністратора.</p>

<p>Аж доки вам доведеться робити це знову.</p>

<p>Тут на допомогу приходять інструменти, такі як <a href="http://www.opscode.com">Chef</a> та <a href="http://puppetlabs.com">Puppet</a>. Обидва інструменти дозволяють оголосити та визначити, як мають виглядати системи та як їх налаштовувати. Обидва потужні та обидва активно використовуються для налаштування від <a href="https://github.com/boxen/boxen">робочих станцій розробників</a> до <a href="http://www.opscode.com/press-releases/facebook-likes-opscode-and-private-chef/">великих розгортань сотень тисяч машин</a>.</p>

<p>Як і програмне забезпечення, вам все одно потрібно створювати та тестувати конфігурацію, яку ви будуєте. Ваші варіанти тут варіюються від дуже дорогого (купіть один або кілька серверів) до помірно дорогого (запустіть кілька інстансів на EC2) до дуже дешевого. Дуже дешевий варіант - це створення та тестування ваших рецептів на віртуальній машині (або машинах), що працюють на вашій системі. Тут на допомогу приходить <a href="http://www.vagrantup.com/">Vagrant</a>.</p>

<p>Vagrant - це обгортка навколо <a href="https://www.virtualbox.org/">VirtualBox</a> від Oracle - платформи віртуалізації настільних систем. Конфігурація Vagrant побудована навколо кількох простих концепцій. У вас є конфігураційний файл під назвою <code>Vagrantfile</code> в корені проєкту. Цей файл містить базову конфігурацію, таку як базова коробка, яку використовуватиме проєкт, й які порти відкрити для господарської системи. Також важливо те, що він може описувати, як провізіонувати віртуальну машину, щоб вона відповідала потребам вашого проєкту. Хоча Vagrant підтримує і Puppet, і Chef, я обрав Chef-Solo для провізіонування цього проєкту.</p>

<p>Почати роботу з Vagrant просто. Перший крок - встановити гем <code>vagrant</code>. Як і в будь-якому іншому Ruby-проєкті, я обрав встановити <code>vagrant</code> та кілька інших гемів через Bundler. Ось результат у <code>Gemfile</code>:</p>

<div class="language-ruby highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #24292f;background-color: #f6f8fa">source</span>&nbsp;<span style="color: #0a3069">'https://rubygems.org'</span>
</div><div class='code-line code-line-2'>
</div><div class='code-line code-line-3'><span style="color: #24292f;background-color: #f6f8fa">gem</span>&nbsp;<span style="color: #0a3069">'vagrant'</span>
</div><div class='code-line code-line-4'><span style="color: #24292f;background-color: #f6f8fa">gem</span>&nbsp;<span style="color: #0a3069">'librarian'</span>
</div></code></div>

<p>Виконання <code>bundle install</code> встановило необхідні геми в директорії проєкту. Швидке <code>rbenv rehash</code> зробило виконуваний файл vagrant доступним для моєї оболонки.</p>

<p>Наступним кроком було налаштування найпростішої конфігурації Vagrant. Я виконав <code>vagrant init</code>, а потім відредагував Vagrantfile, щоб він виглядав так:</p>

<div class="language-ruby highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #953800">Vagrant</span><span style="color: #0550ae">::</span><span style="color: #953800">Config</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">run</span>&nbsp;<span style="color: #cf222e">do</span>&nbsp;<span style="color: #0550ae">|</span><span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #0550ae">|</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;<span style="color: #6e7781"># Кожне віртуальне середовище Vagrant вимагає коробки для побудови.</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">vm</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">box</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"ubuntu-precise-64"</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;
</div><div class='code-line code-line-5'>&nbsp;&nbsp;<span style="color: #6e7781"># URL, звідки буде завантажено 'config.vm.box', якщо вона</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;<span style="color: #6e7781"># ще не існує на системі користувача.</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">vm</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">box_url</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"http://files.vagrantup.com/precise64.box"</span>
</div><div class='code-line code-line-8'><span style="color: #cf222e">end</span>
</div></code></div>

<p>Це досягає двох речей. Спочатку, це оголошує назву коробки, на якій ми будемо будувати, та де її можна знайти. Швидке <code>vagrant up</code> спочатку завантажить базову коробку, імпортує її в проєкт та запустить ВМ. Завантаження коробки займає час, але вона кешується на вашій системі, тому вам не потрібно завантажувати її знову. Ви також можете повторно використовувати ту саму базову коробку, якщо вирішите зробити це в інших проєктах. Виконання <code>vagrant halt</code> зупиняє ВМ, а виконання <code>vagrant destroy</code> знищує ВМ.</p>

<p>Тим не менш, ми все ще не зробили багато для провізіонування нашої ВМ. Наступним кроком є вказівка Vagrant, як це зробити.</p>

<p><a href="https://github.com/applicationsonline/librarian">Librarian</a> - це ще один гарний гем у стилі Bundler та CocoaPods, який дозволяє оголосити, які рецепти Chef ви використовуєте. У нашому випадку скорочена копія <code>Cheffile</code> проєкту виглядає так:</p>

<div class="language-ruby highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #6e7781">#!/usr/bin/env ruby</span>
</div><div class='code-line code-line-2'><span style="color: #6e7781">#^syntax detection</span>
</div><div class='code-line code-line-3'>
</div><div class='code-line code-line-4'><span style="color: #24292f;background-color: #f6f8fa">site</span>&nbsp;<span style="color: #0a3069">'http://community.opscode.com/api/v1'</span>
</div><div class='code-line code-line-5'>
</div><div class='code-line code-line-6'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'apt'</span>
</div><div class='code-line code-line-7'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'apache2'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">'&gt;= 1.0.0'</span>
</div><div class='code-line code-line-8'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'rbenv'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">:git</span>&nbsp;<span style="color: #0550ae">=&gt;</span>&nbsp;<span style="color: #0a3069">'git://github.com/fnichol/chef-rbenv.git'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">:ref</span>&nbsp;<span style="color: #0550ae">=&gt;</span>&nbsp;<span style="color: #0a3069">'v0.7.2'</span>
</div><div class='code-line code-line-9'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'ruby_build'</span>
</div><div class='code-line code-line-10'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'openssh'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">:git</span>&nbsp;<span style="color: #0550ae">=&gt;</span>&nbsp;<span style="color: #0a3069">'git://github.com/fnichol/chef-openssh.git'</span>
</div><div class='code-line code-line-11'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'git'</span>
</div><div class='code-line code-line-12'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'build-essential'</span>
</div><div class='code-line code-line-13'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'vim'</span>
</div><div class='code-line code-line-14'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'user'</span>
</div><div class='code-line code-line-15'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'sudo'</span>
</div></code></div>

<p>Найбільша перевага полягає в тому, що вам не потрібно вендорити кукбуки в ваші проєкти. Виконання <code>librarian-chef install</code> завантажить кукбуки та встановить їх у директорію <code>cookbooks</code>. Це також створить <code>Cheffile.lock</code>, щоб задокументувати, які версії кукбуків були встановлені.</p>

<p>Тепер я був на етапі, коли міг сказати Vagrant використовувати Chef-Solo для провізіонування коробки, оновивши <code>Vagrantfile</code>:</p>

<div class="language-ruby highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #953800">Vagrant</span><span style="color: #0550ae">::</span><span style="color: #953800">Config</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">run</span>&nbsp;<span style="color: #cf222e">do</span>&nbsp;<span style="color: #0550ae">|</span><span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #0550ae">|</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;<span style="color: #6e7781"># Кожне віртуальне середовище Vagrant вимагає коробки для побудови.</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">vm</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">box</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"ubuntu-precise-64"</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;
</div><div class='code-line code-line-5'>&nbsp;&nbsp;<span style="color: #6e7781"># URL, звідки буде завантажено 'config.vm.box', якщо вона</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;<span style="color: #6e7781"># ще не існує на системі користувача.</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">vm</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">box_url</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"http://files.vagrantup.com/precise64.box"</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;
</div><div class='code-line code-line-9'>&nbsp;&nbsp;<span style="color: #6e7781"># Увімкніть провізіонування з chef solo, вказавши шлях до кукбуків, шлях</span>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;<span style="color: #6e7781"># ролей та шлях до data_bags (все відносно до цього Vagrantfile), а також</span>
</div><div class='code-line code-line-11'>&nbsp;&nbsp;<span style="color: #6e7781"># додавши кілька рецептів і/або ролей.</span>
</div><div class='code-line code-line-12'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">vm</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">provision</span>&nbsp;<span style="color: #0a3069">:chef_solo</span>&nbsp;<span style="color: #cf222e">do</span>&nbsp;<span style="color: #0550ae">|</span><span style="color: #24292f;background-color: #f6f8fa">chef</span><span style="color: #0550ae">|</span>
</div><div class='code-line code-line-13'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">chef</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">cookbooks_path</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">"cookbooks"</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">"site-cookbooks"</span><span style="color: #24292f;background-color: #f6f8fa">]</span>
</div><div class='code-line code-line-14'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">chef</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">add_recipe</span>&nbsp;<span style="color: #0a3069">"apt"</span>
</div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">chef</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">add_recipe</span>&nbsp;<span style="color: #0a3069">"build-essential"</span>
</div><div class='code-line code-line-16'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">chef</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">add_recipe</span>&nbsp;<span style="color: #0a3069">"ruby_build"</span>
</div><div class='code-line code-line-17'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">chef</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">add_recipe</span>&nbsp;<span style="color: #0a3069">"rbenv::system"</span>
</div><div class='code-line code-line-18'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">chef</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">add_recipe</span>&nbsp;<span style="color: #0a3069">"rbenv::vagrant"</span>
</div><div class='code-line code-line-19'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">chef</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">add_recipe</span>&nbsp;<span style="color: #0a3069">"git"</span>
</div><div class='code-line code-line-20'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">chef</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">add_recipe</span>&nbsp;<span style="color: #0a3069">"user"</span>
</div><div class='code-line code-line-21'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">chef</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">add_recipe</span>&nbsp;<span style="color: #0a3069">"vim"</span>
</div><div class='code-line code-line-22'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">chef</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">add_recipe</span>&nbsp;<span style="color: #0a3069">"sudo"</span>
</div><div class='code-line code-line-23'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">chef</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">