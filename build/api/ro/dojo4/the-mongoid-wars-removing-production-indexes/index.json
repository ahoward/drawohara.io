{
  "data": {
    "dojo4/the-mongoid-wars-removing-production-indexes": {
      "author": "ara@dojo4.com",
      "title": "! 'The Mongoid Wars: Removing Production Indexes'",
      "published_at": "2014-06-12 15:09:40 UTC",
      "body": "<div class=\"ro markdown\">\n  <p>Yesterday <a href=\"https://twitter.com/cookrn\">Ryan Cook</a> and I hit one of those dreaded production only issues experienced developers know and hate on the soft launched <a href=\"http://gomoshimoshi.com/\">Moshi Moshi Co</a> product <a href=\"http://wallspacefinder.com/\">Wall Space Finder</a>.</p>\n\n<p>This one was a doozy, models would fail to save in staging only, not locally or in production.  Obviously this was <em>RAILS_ENV</em> related, or so I thought…</p>\n\n<p>First we did the obvious, looked at the code locally in development mode.  Nothing, it totally worked.  No problems.</p>\n\n<p>Then we used the awesome</p>\n\n<div class=\"language-bash highlighter-rouge\"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>\n</div><div class='code-line code-line-2'>\n</div><div class='code-line code-line-3'>&nbsp;&nbsp;~&gt;&nbsp;cap&nbsp;staging&nbsp;db:suck&nbsp;\n</div><div class='code-line code-line-4'>&nbsp;&nbsp;\n</div><div class='code-line code-line-5'>&nbsp;&nbsp;\n</div><div class='code-line code-line-6'>&nbsp;&nbsp;<span style=\"color: #6e7781\">### the inverse is, you guessed it, db:blow, because development needs to be moar funi...</span>\n</div><div class='code-line code-line-7'>\n</div><div class='code-line code-line-8'>\n</div></code></div>\n\n<p>to suck the remote staging db into the local db, thereby replicating code,\ndata, and the <em>RAILS_ENV</em> via</p>\n\n<div class=\"language-bash highlighter-rouge\"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>\n</div><div class='code-line code-line-2'>&nbsp;&nbsp;~&gt;&nbsp;<span style=\"color: #0550ae\">RAILS_ENV</span><span style=\"color: #0550ae\">=</span>production&nbsp;<span style=\"color: #0550ae\">RAILS_STAGE</span><span style=\"color: #0550ae\">=</span>staging&nbsp;./bin/rails&nbsp;server\n</div><div class='code-line code-line-3'>\n</div></code></div>\n\n<p>A quick note on that: Dojo4 runs all staging deploys in <em>RAILS_ENV=production</em> and disambiguates staging vs. production via another environment variable (<em>RAILS_STAGE</em>) precisely for the reason that we like to exercise any and all production behaviors in staging/qa where possible - selectively guarding only <em>crazy</em> behaviors like charging credit cards via <em>RAILS_STAGE</em>.</p>\n\n<p>So rest assured the issue was <em>not</em> because we had <em>./config/environments/staging.rb</em> setup differently than <em>./config/environments/production.rb</em>!</p>\n\n<p>But still, we could not replicate. <em>#WTF</em>!?</p>\n\n<p>Finally, I instrumented the staging deploy to use <a href=\"https://twitter.com/search?f=realtime&amp;q=%23die%C3%BCberawesomesauce&amp;src=typd\">#dieüberawesomesauce</a> <a href=\"https://github.com/Mon-Ouie/pry-remote\">pry-remote</a> and dropped right into the <em>BOOMing</em> code on the staging node.</p>\n\n<p>And there it was: a unique contraint was being violated in the database.  Yet no\nunique indexes were defined in the model, or anywhere else.  Hrmmmmm…</p>\n\n<p>Reviewing the git logs I found that, previously, a unique index <em>had</em> been\ndefined on the offending model.  Problem solved I thought, a quick</p>\n\n<div class=\"language-bash highlighter-rouge\"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>\n</div><div class='code-line code-line-2'>&nbsp;&nbsp;~&gt;&nbsp;rake&nbsp;db:mongoid:remove_indexes\n</div><div class='code-line code-line-3'>\n</div></code></div>\n\n<p>and.  <em>The problem remained.</em></p>\n\n<p>Ok.  Code reading time.  3 minutes later the problem was discovered. In Mongoid 4 the <em>remove_indexes</em> task uses this code</p>\n\n<div class=\"language-ruby highlighter-rouge\"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>\n</div><div class='code-line code-line-2'>\n</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6e7781\"># Return the list of indexes by model that exist in the database but aren't</span>\n</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6e7781\"># specified on the models.</span>\n</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6e7781\">#</span>\n</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6e7781\"># @example Return the list of unused indexes.</span>\n</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6e7781\">#   Mongoid::Tasks::Database.undefined_indexes</span>\n</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6e7781\">#</span>\n</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6e7781\"># @return Hash{Class =&gt; Array(Hash)} The list of undefined indexes by model.</span>\n</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">def</span>&nbsp;<span style=\"color: #8250df\">undefined_indexes</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">models</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #0550ae\">::</span><span style=\"color: #953800\">Mongoid</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">models</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-11'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">undefined_by_model</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">{}</span>\n</div><div class='code-line code-line-12'>\n</div></code></div>\n\n<p>ref: <a href=\"https://github.com/mongoid/mongoid/blob/master/lib/mongoid/tasks/database.rb#L40\" target=\"_blank\">https://github.com/mongoid/mongoid/blob/master/lib/mongoid/tasks/database.rb#L40</a></p>\n\n<p>but, in Mongoid 3.x, which we are using, it has no such logic.</p>\n\n<p>ref: <a href=\"https://github.com/mongoid/mongoid/blob/3.1.0-stable/lib/rails/mongoid.rb\" target=\"_blank\">https://github.com/mongoid/mongoid/blob/3.1.0-stable/lib/rails/mongoid.rb</a></p>\n\n<p>So there you have it: Mongoid 4 ensures that all indexes, even those no longer defined in the code/repo are nuked when indexes are dropped, while Mongoid 3 will leave those indexes lying around in the database!</p>\n\n<p>I decided to write about this experience because:</p>\n\n<ul>\n  <li>20/20 hindsight I’ve hit it before myself.  /cc <a href=\"https://twitter.com/spikex\">@spikex</a></li>\n  <li>It underscores how development and dev-ops need to converge to debug real-world issues: not everything is stateless and lives in the repo, and not all state can be replicated.  Sometimes you gotta do it live.</li>\n  <li>Someone will undoubtedly have the same issue and, I hope, find this post via the magic of teh googlez.</li>\n  <li><a href=\"https://twitter.com/modetojoy\">@modetojoy</a> might consider my current thinking, which is that we should backport the better Mongoid 4 behavior into 3.1.0.</li>\n</ul>\n\n<p>And people wonder why we engineers can’t estimate the time and effort to fix a simple bug.</p>\n\n<p>P.S.  Some of you readers might be wondering how I fixed this.  I simply re-defined the index in the console, so Mongoid would be aware of it, and then used the model level methods to nuke it</p>\n\n<div class=\"language-bash highlighter-rouge\"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>\n</div><div class='code-line code-line-2'><span style=\"color: #0550ae\">[</span>48]&nbsp;pry<span style=\"color: #0550ae\">(</span><span style=\"color: #6e7781\">#&lt;My::SpacesConducer&gt;)&gt; model.save</span>\n</div><div class='code-line code-line-3'>Moped::Errors::OperationFailure:&nbsp;The&nbsp;operation:&nbsp;<span style=\"color: #6e7781\">#&lt;Moped::Protocol::Command</span>\n</div><div class='code-line code-line-4'>&nbsp;&nbsp;@length<span style=\"color: #0550ae\">=</span>89\n</div><div class='code-line code-line-5'>&nbsp;&nbsp;@request_id<span style=\"color: #0550ae\">=</span>604\n</div><div class='code-line code-line-6'>&nbsp;&nbsp;@response_to<span style=\"color: #0550ae\">=</span>0\n</div><div class='code-line code-line-7'>&nbsp;&nbsp;@op_code<span style=\"color: #0550ae\">=</span>2004\n</div><div class='code-line code-line-8'>&nbsp;&nbsp;@flags<span style=\"color: #0550ae\">=[]</span>\n</div><div class='code-line code-line-9'>&nbsp;&nbsp;@full_collection_name<span style=\"color: #0550ae\">=</span><span style=\"color: #0a3069\">\"wall_space_finder-staging.</span><span style=\"color: #0550ae\">$cmd</span><span style=\"color: #0a3069\">\"</span>\n</div><div class='code-line code-line-10'>&nbsp;&nbsp;@skip<span style=\"color: #0550ae\">=</span>0\n</div><div class='code-line code-line-11'>&nbsp;&nbsp;@limit<span style=\"color: #0550ae\">=</span><span style=\"color: #116329\">-1</span>\n</div><div class='code-line code-line-12'>&nbsp;&nbsp;@selector<span style=\"color: #0550ae\">={</span>:getlasterror<span style=\"color: #0550ae\">=&gt;</span>1,&nbsp;:safe<span style=\"color: #0550ae\">=&gt;</span><span style=\"color: #953800\">true</span><span style=\"color: #0550ae\">}</span>\n</div><div class='code-line code-line-13'>&nbsp;&nbsp;@fields<span style=\"color: #0550ae\">=</span>nil&gt;\n</div><div class='code-line code-line-14'>failed&nbsp;with&nbsp;error&nbsp;11000:&nbsp;<span style=\"color: #0a3069\">\"E11000 duplicate key error index: wall_space_finder-staging.art_spaces.</span><span style=\"color: #0550ae\">$profile</span><span style=\"color: #0a3069\">.slug_1  dup key: { : null }\"</span>\n</div><div class='code-line code-line-15'>\n</div><div class='code-line code-line-16'>\n</div><div class='code-line code-line-17'><span style=\"color: #0550ae\">[</span>49]&nbsp;pry<span style=\"color: #0550ae\">(</span><span style=\"color: #6e7781\">#&lt;My::SpacesConducer&gt;)&gt; ArtSpace.index({:slug =&gt; 1}, {:unique =&gt; true})</span>\n</div><div class='code-line code-line-18'><span style=\"color: #0550ae\">=&gt;</span>&nbsp;<span style=\"color: #0550ae\">{</span>:unique<span style=\"color: #0550ae\">=&gt;</span><span style=\"color: #953800\">true</span><span style=\"color: #0550ae\">}</span>\n</div><div class='code-line code-line-19'>\n</div><div class='code-line code-line-20'><span style=\"color: #0550ae\">[</span>50]&nbsp;pry<span style=\"color: #0550ae\">(</span><span style=\"color: #6e7781\">#&lt;My::SpacesConducer&gt;)&gt; ArtSpace.remove_indexes</span>\n</div><div class='code-line code-line-21'><span style=\"color: #0550ae\">=&gt;</span>&nbsp;<span style=\"color: #953800\">true</span>\n</div><div class='code-line code-line-22'>\n</div><div class='code-line code-line-23'><span style=\"color: #0550ae\">[</span>51]&nbsp;pry<span style=\"color: #0550ae\">(</span><span style=\"color: #6e7781\">#&lt;My::SpacesConducer&gt;)&gt; model.save</span>\n</div><div class='code-line code-line-24'><span style=\"color: #0550ae\">=&gt;</span>&nbsp;<span style=\"color: #953800\">true</span>\n</div><div class='code-line code-line-25'>\n</div><div class='code-line code-line-26'>\n</div></code></div>\n\n</div>\n",
      "assets": {},
      "_meta": {
        "identifier": "dojo4/the-mongoid-wars-removing-production-indexes",
        "type": "dojo4",
        "id": "the-mongoid-wars-removing-production-indexes",
        "urls": [
          "/ro/dojo4/the-mongoid-wars-removing-production-indexes/body.md"
        ],
        "created_at": "2025-05-06 08:47:14 +0000",
        "updated_at": "2025-05-06 08:47:14 +0000",
        "rel": {
          "curr": "dojo4/the-mongoid-wars-removing-production-indexes",
          "prev": "dojo4/angularjs-service-rails-api",
          "next": "dojo4/aws-ebs-backups-we-rewrote-drebs"
        }
      }
    }
  },
  "_meta": {
    "url": "/ro",
    "type": "dojo4",
    "id": "the-mongoid-wars-removing-production-indexes"
  }
}