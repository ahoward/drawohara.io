{
  "data": {
    "dojo4/rails-to-json": {
      "published_at": "2010-10-05 00:00:00 UTC",
      "title": "rails to_json",
      "author": "ara@dojo4.com",
      "body": "<div class=\"ro markdown\">\n  <p>rails, including rails3, has this lovely bit of code related to providing a “to_json” method on built-ins:</p>\n\n<div class=\"language-ruby highlighter-rouge\"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>\n</div><div class='code-line code-line-2'><span style=\"color: #6e7781\"># Hack to load json gem first so we can overwrite its to_json.</span>\n</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">begin</span>\n</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #953800\">require</span>&nbsp;<span style=\"color: #0a3069\">'json'</span>\n</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">rescue</span>&nbsp;<span style=\"color: #953800\">LoadError</span>\n</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-7'>\n</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6e7781\"># The JSON gem adds a few modules to Ruby core classes containing :to_json definition, overwriting</span>\n</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6e7781\"># their default behavior. That said, we need to define the basic to_json method in all of them,</span>\n</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6e7781\"># otherwise they will always use to_json gem implementation, which is backwards incompatible in</span>\n</div><div class='code-line code-line-11'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6e7781\"># several cases (for instance, the JSON implementation for Hash does not work) with inheritance</span>\n</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6e7781\"># and consequently classes as ActiveSupport::OrderedHash cannot be serialized to json.</span>\n</div><div class='code-line code-line-13'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">[</span><span style=\"color: #953800\">Object</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">Array</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">FalseClass</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">Float</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">Hash</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">Integer</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">NilClass</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">String</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">TrueClass</span><span style=\"color: #24292f;background-color: #f6f8fa\">].</span><span style=\"color: #8250df\">each</span>&nbsp;<span style=\"color: #cf222e\">do</span>&nbsp;<span style=\"color: #0550ae\">|</span><span style=\"color: #24292f;background-color: #f6f8fa\">klass</span><span style=\"color: #0550ae\">|</span>\n</div><div class='code-line code-line-14'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">klass</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">class_eval</span>&nbsp;<span style=\"color: #0550ae\">&lt;&lt;-</span><span style=\"color: #953800\">RUBY</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #cf222e\">__FILE__</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #cf222e\">__LINE__</span>\n</div><div class='code-line code-line-15'><span style=\"color: #0a3069\"># Dumps object in JSON (JavaScript Object Notation). See www.json.org for more info.</span>\n</div><div class='code-line code-line-16'><span style=\"color: #0a3069\">def to_json(options = nil)</span>\n</div><div class='code-line code-line-17'><span style=\"color: #0a3069\">ActiveSupport::JSON.encode(self, options)</span>\n</div><div class='code-line code-line-18'><span style=\"color: #0a3069\">end</span>\n</div><div class='code-line code-line-19'><span style=\"color: #953800\">RUBY</span>\n</div><div class='code-line code-line-20'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-21'>\n</div></code></div>\n\n<p>what this effectively does is clobber the “to_json” method the json gem provides with one that active_support feels is better. the comment about json being broken is out of date and this was hack to begin with. in my case i really like this sort of thing in my /api controller:</p>\n\n<div class=\"language-ruby highlighter-rouge\"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>\n</div><div class='code-line code-line-2'>&nbsp;&nbsp;<span style=\"color: #cf222e\">def</span>&nbsp;<span style=\"color: #8250df\">to_json</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">object</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">if</span>&nbsp;<span style=\"color: #953800\">Rails</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">env</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">production?</span>\n</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #953800\">JSON</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">generate</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">object</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">else</span>\n</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #953800\">JSON</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">pretty_generate</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">object</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-8'>&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-9'>\n</div></code></div>\n\n<p>since it makes debugging a shit-ton easier. here’s how i did it in a rails3 app -</p>\n\n<p>step one was to make rails3 support the “preinitializer” concept that old-skool rails used to have:</p>\n\n<div class=\"language-ruby highlighter-rouge\"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>\n</div><div class='code-line code-line-2'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #6e7781\">### file: config/preinitializer.rb</span>\n</div><div class='code-line code-line-3'>\n</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">dirname</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #953800\">File</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">dirname</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #953800\">File</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">expand_path</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #cf222e\">__FILE__</span><span style=\"color: #24292f;background-color: #f6f8fa\">))</span>\n</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">glob</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #953800\">File</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">join</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">dirname</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #0a3069\">'preinitializers'</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #0a3069\">'**/**.rb'</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">preinitializers</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #953800\">Dir</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">glob</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">glob</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-7'>\n</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">preinitializers</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">each</span><span style=\"color: #24292f;background-color: #f6f8fa\">{</span><span style=\"color: #0550ae\">|</span><span style=\"color: #24292f;background-color: #f6f8fa\">preinitializer</span><span style=\"color: #0550ae\">|</span>&nbsp;<span style=\"color: #953800\">Kernel</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">load</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">preinitializer</span><span style=\"color: #24292f;background-color: #f6f8fa\">)}</span>\n</div><div class='code-line code-line-9'>\n</div></code></div>\n\n<p>next, i added this preinitializer:</p>\n\n<div class=\"language-ruby highlighter-rouge\"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>\n</div><div class='code-line code-line-2'><span style=\"color: #6e7781\">### file: config/preinitializers/un_fuck_to_json.rb</span>\n</div><div class='code-line code-line-3'>\n</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">begin</span>\n</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #953800\">require</span>&nbsp;<span style=\"color: #0a3069\">'rubygems'</span>\n</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">rescue</span>&nbsp;<span style=\"color: #953800\">LoadError</span>\n</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-8'>\n</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">begin</span>\n</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #953800\">require</span>&nbsp;<span style=\"color: #0a3069\">'json'</span>\n</div><div class='code-line code-line-11'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">rescue</span>&nbsp;<span style=\"color: #953800\">LoadError</span>\n</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-13'>\n</div><div class='code-line code-line-14'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">[</span><span style=\"color: #953800\">Object</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">Array</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">FalseClass</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">Float</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">Hash</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">Integer</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">NilClass</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">String</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">TrueClass</span><span style=\"color: #24292f;background-color: #f6f8fa\">].</span><span style=\"color: #8250df\">each</span>&nbsp;<span style=\"color: #cf222e\">do</span>&nbsp;<span style=\"color: #0550ae\">|</span><span style=\"color: #24292f;background-color: #f6f8fa\">klass</span><span style=\"color: #0550ae\">|</span>\n</div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">klass</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">class_eval</span>&nbsp;<span style=\"color: #cf222e\">do</span>\n</div><div class='code-line code-line-16'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">alias_method</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #0a3069\">'__to_json__'</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #0a3069\">'to_json'</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>&nbsp;<span style=\"color: #cf222e\">if</span>&nbsp;<span style=\"color: #953800\">method_defined?</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #0a3069\">'to_json'</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-17'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-18'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-19'>\n</div></code></div>\n\n<p>finally, this initializer:</p>\n\n<div class=\"language-ruby highlighter-rouge\"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>\n</div><div class='code-line code-line-2'><span style=\"color: #6e7781\">### file: config/preinitializers/un_fuck_to_json.rb</span>\n</div><div class='code-line code-line-3'>\n</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">begin</span>\n</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #953800\">require</span>&nbsp;<span style=\"color: #0a3069\">'rubygems'</span>\n</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">rescue</span>&nbsp;<span style=\"color: #953800\">LoadError</span>\n</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-8'>\n</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">begin</span>\n</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #953800\">require</span>&nbsp;<span style=\"color: #0a3069\">'json'</span>\n</div><div class='code-line code-line-11'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">rescue</span>&nbsp;<span style=\"color: #953800\">LoadError</span>\n</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-13'>\n</div><div class='code-line code-line-14'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">[</span><span style=\"color: #953800\">Object</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">Array</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">FalseClass</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">Float</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">Hash</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">Integer</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">NilClass</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">String</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">TrueClass</span><span style=\"color: #24292f;background-color: #f6f8fa\">].</span><span style=\"color: #8250df\">each</span>&nbsp;<span style=\"color: #cf222e\">do</span>&nbsp;<span style=\"color: #0550ae\">|</span><span style=\"color: #24292f;background-color: #f6f8fa\">klass</span><span style=\"color: #0550ae\">|</span>\n</div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">klass</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">class_eval</span>&nbsp;<span style=\"color: #cf222e\">do</span>\n</div><div class='code-line code-line-16'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">alias_method</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #0a3069\">'__to_json__'</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #0a3069\">'to_json'</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>&nbsp;<span style=\"color: #cf222e\">if</span>&nbsp;<span style=\"color: #953800\">method_defined?</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #0a3069\">'to_json'</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-17'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-18'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-19'>\n</div></code></div>\n\n<p>in english what this does is</p>\n\n<ul>\n  <li>make rails support code that runs before all else</li>\n  <li>during this phase suck in the json gem and remember how it does things</li>\n  <li>nuke the rails’ way and restore the json method of to_json</li>\n</ul>\n\n\n</div>\n",
      "assets": {},
      "_meta": {
        "identifier": "dojo4/rails-to-json",
        "type": "dojo4",
        "id": "rails-to-json",
        "urls": [
          "/ro/dojo4/rails-to-json/body.md"
        ],
        "created_at": "2025-05-06 08:47:14 +0000",
        "updated_at": "2025-05-06 08:47:14 +0000",
        "rel": {
          "curr": "dojo4/rails-to-json",
          "prev": "dojo4/what-a-rush",
          "next": "dojo4/driving-user-behavior-with-game-dynamics"
        }
      }
    }
  },
  "_meta": {
    "url": "/ro",
    "type": "dojo4",
    "id": "rails-to-json"
  }
}