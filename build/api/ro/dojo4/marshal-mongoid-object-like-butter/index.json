{
  "data": {
    "dojo4/marshal-mongoid-object-like-butter": {
      "title": "marshal mongoid object like butter",
      "published_at": "2013-03-01 00:00:00 UTC",
      "author": "ara@dojo4.com",
      "body": "<div class=\"ro markdown\">\n  <p>sticking your models into cache, or serializing them for other reasons shouldnâ€™t be painful.  unfortunately it is with most ORMs, as they have a lame marshal strategy by default.  however this is easy to fix: they key lies in understanding that every ORM already knows how to take a hash of info from the db and instantiate a full blown instance.  knowing this, we can easily make any model serialize like butter.</p>\n\n<p><br /></p>\n\n<div class=\"language-ruby highlighter-rouge\"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style=\"color: #6e7781\">#! /usr/bin/env ruby</span>\n</div><div class='code-line code-line-2'>\n</div><div class='code-line code-line-3'><span style=\"color: #6e7781\"># some models have whack shit that can't survive a marshal round-trip</span>\n</div><div class='code-line code-line-4'><span style=\"color: #6e7781\">#</span>\n</div><div class='code-line code-line-5'>&nbsp;&nbsp;<span style=\"color: #cf222e\">class</span>&nbsp;<span style=\"color: #953800\">Model</span>\n</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">include</span>&nbsp;<span style=\"color: #953800\">Mongoid</span><span style=\"color: #0550ae\">::</span><span style=\"color: #953800\">Document</span>\n</div><div class='code-line code-line-7'>\n</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">def</span>&nbsp;<span style=\"color: #8250df\">initialize</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #0550ae\">*</span><span style=\"color: #24292f;background-color: #f6f8fa\">args</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #0550ae\">&amp;</span><span style=\"color: #24292f;background-color: #f6f8fa\">block</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">super</span>\n</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">ensure</span>\n</div><div class='code-line code-line-11'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #0550ae\">@fail</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #953800\">Class</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">new</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #953800\">open</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #cf222e\">__FILE__</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-13'>&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-14'>\n</div><div class='code-line code-line-15'><span style=\"color: #6e7781\"># so this'll fail</span>\n</div><div class='code-line code-line-16'><span style=\"color: #6e7781\">#</span>\n</div><div class='code-line code-line-17'>&nbsp;&nbsp;<span style=\"color: #cf222e\">begin</span>\n</div><div class='code-line code-line-18'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #953800\">p</span>&nbsp;<span style=\"color: #953800\">Marshal</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">load</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #953800\">Marshal</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">dump</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #953800\">Model</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">create</span><span style=\"color: #24292f;background-color: #f6f8fa\">))</span>\n</div><div class='code-line code-line-19'>&nbsp;&nbsp;<span style=\"color: #cf222e\">rescue</span>&nbsp;<span style=\"color: #953800\">Object</span>&nbsp;<span style=\"color: #0550ae\">=&gt;</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">o</span>\n</div><div class='code-line code-line-20'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #953800\">warn</span>&nbsp;<span style=\"color: #0a3069\">\"</span><span style=\"color: #24292f\">#{</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">o</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">message</span>&nbsp;<span style=\"color: #24292f\">}</span><span style=\"color: #0a3069\"> (</span><span style=\"color: #24292f\">#{</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">o</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">class</span>&nbsp;<span style=\"color: #24292f\">}</span><span style=\"color: #0a3069\">)\"</span>\n</div><div class='code-line code-line-21'>&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-22'>\n</div><div class='code-line code-line-23'><span style=\"color: #6e7781\"># but mongoid models simply need a hash of information from the mongo driver</span>\n</div><div class='code-line code-line-24'><span style=\"color: #6e7781\"># to fully vivify themselves... ergo this is all we need persist when</span>\n</div><div class='code-line code-line-25'><span style=\"color: #6e7781\"># marshaled.  this makes loading from marshaled data *just like* loading from</span>\n</div><div class='code-line code-line-26'><span style=\"color: #6e7781\"># the db.</span>\n</div><div class='code-line code-line-27'><span style=\"color: #6e7781\">#</span>\n</div><div class='code-line code-line-28'><span style=\"color: #6e7781\"># if you ask me this should be the default behavior!</span>\n</div><div class='code-line code-line-29'><span style=\"color: #6e7781\">#</span>\n</div><div class='code-line code-line-30'><span style=\"color: #6e7781\"># hrm - i am on mongoid core... @durran, what do you think?</span>\n</div><div class='code-line code-line-31'><span style=\"color: #6e7781\">#</span>\n</div><div class='code-line code-line-32'><span style=\"color: #6e7781\"># btw - this works just fine with active_record too...</span>\n</div><div class='code-line code-line-33'><span style=\"color: #6e7781\">#</span>\n</div><div class='code-line code-line-34'>&nbsp;&nbsp;<span style=\"color: #cf222e\">class</span>&nbsp;<span style=\"color: #953800\">Model</span>\n</div><div class='code-line code-line-35'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">def</span>&nbsp;<span style=\"color: #8250df\">_dump</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #0550ae\">*</span><span style=\"color: #24292f;background-color: #f6f8fa\">args</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #0550ae\">&amp;</span><span style=\"color: #24292f;background-color: #f6f8fa\">block</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-36'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #953800\">Marshal</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">dump</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">raw_attributes</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #0550ae\">*</span><span style=\"color: #24292f;background-color: #f6f8fa\">args</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #0550ae\">&amp;</span><span style=\"color: #24292f;background-color: #f6f8fa\">block</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-37'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-38'>\n</div><div class='code-line code-line-39'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">def</span>&nbsp;<span style=\"color: #953800\">Model</span><span style=\"color: #0550ae\">.</span><span style=\"color: #8250df\">_load</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">string</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #0550ae\">*</span><span style=\"color: #24292f;background-color: #f6f8fa\">args</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #0550ae\">&amp;</span><span style=\"color: #24292f;background-color: #f6f8fa\">block</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-40'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">raw_attributes</span>&nbsp;<span style=\"color: #0550ae\">=</span>&nbsp;<span style=\"color: #953800\">Marshal</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">load</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">string</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #0550ae\">*</span><span style=\"color: #24292f;background-color: #f6f8fa\">args</span><span style=\"color: #24292f;background-color: #f6f8fa\">,</span>&nbsp;<span style=\"color: #0550ae\">&amp;</span><span style=\"color: #24292f;background-color: #f6f8fa\">block</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-41'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">instantiate</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #24292f;background-color: #f6f8fa\">raw_attributes</span><span style=\"color: #24292f;background-color: #f6f8fa\">)</span>\n</div><div class='code-line code-line-42'>&nbsp;&nbsp;&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-43'>&nbsp;&nbsp;<span style=\"color: #cf222e\">end</span>\n</div><div class='code-line code-line-44'>\n</div><div class='code-line code-line-45'><span style=\"color: #6e7781\"># so now it just werks (TM)</span>\n</div><div class='code-line code-line-46'><span style=\"color: #6e7781\">#</span>\n</div><div class='code-line code-line-47'>&nbsp;&nbsp;<span style=\"color: #953800\">p</span>&nbsp;<span style=\"color: #953800\">Marshal</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">load</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #953800\">Marshal</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">dump</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #953800\">Model</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">create</span><span style=\"color: #24292f;background-color: #f6f8fa\">))</span>\n</div><div class='code-line code-line-48'>\n</div><div class='code-line code-line-49'>\n</div><div class='code-line code-line-50'>\n</div><div class='code-line code-line-51'>\n</div><div class='code-line code-line-52'>\n</div><div class='code-line code-line-53'><span style=\"color: #cf222e\">BEGIN</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">{</span>\n</div><div class='code-line code-line-54'>&nbsp;&nbsp;<span style=\"color: #953800\">require</span>&nbsp;<span style=\"color: #0a3069\">'rubygems'</span>\n</div><div class='code-line code-line-55'>&nbsp;&nbsp;<span style=\"color: #953800\">require</span>&nbsp;<span style=\"color: #0a3069\">'mongoid'</span>\n</div><div class='code-line code-line-56'>\n</div><div class='code-line code-line-57'>&nbsp;&nbsp;<span style=\"color: #953800\">Mongoid</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">configure</span><span style=\"color: #24292f;background-color: #f6f8fa\">{</span><span style=\"color: #0550ae\">|</span><span style=\"color: #24292f;background-color: #f6f8fa\">config</span><span style=\"color: #0550ae\">|</span>&nbsp;<span style=\"color: #24292f;background-color: #f6f8fa\">config</span><span style=\"color: #24292f;background-color: #f6f8fa\">.</span><span style=\"color: #8250df\">connect_to</span><span style=\"color: #24292f;background-color: #f6f8fa\">(</span><span style=\"color: #0a3069\">'mongoid-marshal'</span><span style=\"color: #24292f;background-color: #f6f8fa\">)}</span>\n</div><div class='code-line code-line-58'><span style=\"color: #24292f;background-color: #f6f8fa\">}</span>\n</div><div class='code-line code-line-59'>\n</div><div class='code-line code-line-60'><span style=\"color: #6e7781\">__END__</span>\n</div><div class='code-line code-line-61'>\n</div><div class='code-line code-line-62'><span style=\"color: #6e7781\">teh outputz:</span>\n</div><div class='code-line code-line-63'>\n</div><div class='code-line code-line-64'><span style=\"color: #6e7781\">can't dump anonymous class #&lt;Class:0x007fa89dc23768&gt; (TypeError)</span>\n</div><div class='code-line code-line-65'>\n</div><div class='code-line code-line-66'><span style=\"color: #6e7781\">#&lt;Model _id: 5130edd0af481ccd3d000002, &gt;</span>\n</div><div class='code-line code-line-67'><span style=\"color: #6e7781\"> </span>\n</div></code></div>\n\n<p>ref: <a href=\"https://gist.github.com/ahoward/5066528\" target=\"_blank\">https://gist.github.com/ahoward/5066528</a></p>\n\n\n</div>\n",
      "assets": {},
      "_meta": {
        "identifier": "dojo4/marshal-mongoid-object-like-butter",
        "type": "dojo4",
        "id": "marshal-mongoid-object-like-butter",
        "urls": [
          "/ro/dojo4/marshal-mongoid-object-like-butter/body.md"
        ],
        "created_at": "2025-05-06 08:47:14 +0000",
        "updated_at": "2025-05-06 08:47:14 +0000",
        "rel": {
          "curr": "dojo4/marshal-mongoid-object-like-butter",
          "prev": "dojo4/ann-sekrets-rb-easily-managed-encrypted-data-in-your-rails-applications",
          "next": "dojo4/yak-shaving-at-tax-time"
        }
      }
    }
  },
  "_meta": {
    "url": "/ro",
    "type": "dojo4",
    "id": "marshal-mongoid-object-like-butter"
  }
}