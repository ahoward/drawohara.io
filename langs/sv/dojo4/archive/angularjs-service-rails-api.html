<html color-mode="user" lang="sv">
  <head>
    <base href='/langs/sv' />
    <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DQVD9T27V4');
    </script>

    <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

    <!-- langs -->
    <!--
      https://developers.google.com/search/docs/specialty/international/localized-versions#html
    -->
    <link rel="alternate" hreflang="en" href="/" />
    <link rel="alternate" hreflang="uk" href="https://drawohara.io/langs/uk" />
    <link rel="alternate" hreflang="sv" href="https://drawohara.io/langs/sv" />
    <link rel="alternate" hreflang="fr" href="https://drawohara.io/langs/fr" />
    <link rel="alternate" hreflang="es" href="https://drawohara.io/langs/es" />
    <link rel="alternate" hreflang="it" href="https://drawohara.io/langs/it" />

    <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- meta -->
    <title>Inget att se h칛r.</title>

    <meta property="og:title" content="Inget att se h칛r."/>
    <meta property="og:description" content="G친 vidare." />
    <meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

    <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"angularjs-service-rails-api"}">
    <meta property="site:path_info" content=""/angularjs-service-rails-api"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) { progressBar.remove(); }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a> &mdash;
      <a href="mailto:i-love-this@drawohara.io?subject=/angularjs-service-rails-api">jag 仇벒잺 det h칛r!</a>
      <small>
        <small>
          <small>
            <span title='drick mig'>&lt;&lt; klicka p친 mig 游냍 游삈 游빀</a>
          </small>
        </small>
      </small>
      <hr>
      <strong>/angularjs-service-rails-api</strong>
    </header>

    <main>
      <em>publicerad den: 2014-06-10</em>
      <br>
      <br>
      <div class="ro markdown">
        <p>Nyligen fick jag dyka in i AngularJS p친 en Rails-webbplats som vi byggde f칬r en kund. F칬rutom sidinneh친ll har kunden vissa sidor som visar rubriker som l칛nkar till externa k칛llor men h칛mtas in i v친r Rails-stack via en rake-uppgift som k칬rs periodiskt. Webbplatsen ska cachas tungt via anv칛ndande av ett CDN, som <a href="http://aws.amazon.com/cloudfront/">CloudFront</a>, men f칬r att h친lla rubrikerna aktuella anv칛nde vi <a href="https://angularjs.org/">AngularJS</a> (eftersom kunden var bekant med det och d칛rmed l칛ttare underh친ll f칬r dem) f칬r att fr친ga Rails-stacken direkt efter de senaste rubrikerna.</p>

        <p>Det kr칛vde att g칬ra saker p친 ett s칛tt som korsade dom칛ngr칛nser eftersom webbplatsens dom칛n skulle peka p친 CloudFront. Jag hade inte skrivit ett Rails API som returnerade JSONP eller en AngularJS-tj칛nst tidigare, s친 jag beh칬vde utforska och detta fungerade f칬r mig. <em>(Du kan 칛ven <a href="https://gist.github.com/milesmatthias/fb88c9f066f1c3ab7fae">l칛sa gisten</a>.)</em></p>

        <p><em>Obs: Om du inte 칛r bekant med JSONP kommer detta inte att g칬ra mycket mening. <a href="http://en.wikipedia.org/wiki/JSONP">L칛s detta</a>.</em></p>

        <h2 id="angularjs-service">AngularJS Service</h2>

        <p>AngularJS har konceptet med <a href="https://docs.angularjs.org/guide/services">tj칛nster</a>, som 칛r singletons som kan anv칛ndas var som helst du beh칬ver. I v친rt fall kan du t칛nka p친 v친r rubriktj칛nst som rubrikernas API-klient som omsluter v친ra JSONP-anrop i en enklare och centraliserad syntax. AngularJS tillhandah친ller vissa tj칛nster som standard, men du kan skriva dina egna. Faktiskt kunde vi ha anv칛nt den inbyggda <a href="https://docs.angularjs.org/api/ngResource/service/$resource"><code>$resource</code> tj칛nsten</a> ist칛llet f칬r att skriva v친r egen, men jag hade problem med att f친 JSONP att fungera och jag ville f칬rst친 de l칛gre niv친ernas AngularJS-komponenter b칛ttre, s친 jag skrev min egen:</p>

        <pre><code class="language-html+erb">angular.module('app')
  .factory('HeadlineService', ['$http',
    function($http) {
      'use strict';

      var BASE_URL = "&lt;%= [App.settings.api_base_url, '/services/headlines'].join %&gt;",
          CALLBACK_STRING = "?callback=JSON_CALLBACK";

      return {
        getHeadlines: function(){
          return $http.jsonp(BASE_URL + CALLBACK_STRING)
        },
        getHeadlineForId: function(id){
          return $http.jsonp(BASE_URL + "/" + id + ".json" + CALLBACK_STRING)
        }

      }

    }
  ]);
</code></pre>

        <p>Tj칛nsten ovan anv칛nder den inbyggda <a href="https://docs.angularjs.org/api/ng/service/$http"><code>$http</code> tj칛nsten</a>, som enbart tillhandah친ller en AJAX-omslag, f칬r att g칬ra beg칛randen till v친r Rails-backend f칬r att f친 rubriker. N친gra saker att notera:</p>

        <ul>
          <li><strong>Den returnerar ett objekt med 2 funktioner: <code>getHeadlines</code> och <code>getHeadlineForId</code>.</strong> Vi kan sedan anv칛nda dessa funktioner som genv칛gar f칬r att prata med Rails API i v친ra AngularJS-kontroller.</li>
          <li><strong>Den anv칛nder JSONP.</strong> Observera att vi anv칛nder <code>$http.jsonp</code> och att vi skickar en fr친gestr칛ng <code>?callback=JSON_CALLBACK</code>. AngularJS ers칛tter str칛ngen <code>JSON_CALLBACK</code> med namnet p친 en callback-funktion som den skapar f칬r dig.</li>
          <li><strong>Den anv칛nder en annan dom칛n.</strong> N친ja, det 칛r v칛ntat eftersom vi g칬r JSONP, men vi uppn친r det genom att l칛gga till en <code>.erb</code>-fil칛ndelse och anv칛nda vad vi har st칛llt in f칬r <code>App.settings.api_base_url</code> i Rails-appen som dom칛nen som AngularJS ska prata med. Kom ih친g att detta 칛r f칬r att kringg친 CDN-cachningslagret s친 att v친ra rubriker alltid 칛r de senaste.</li>
        </ul>

        <h2 id="angularjs-controller">AngularJS Controller</h2>

        <p>Med v친r <code>HeadlinesService</code> byggd kan vi nu anv칛nda de 2 funktioner den returnerar i v친r AngularJS-app:</p>

        <div class="language-js highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #24292f;background-color: #f6f8fa">angular</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">module</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">app</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">)</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">controller</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">HeadlinesCtrl</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">'</span><span style="color: #0a3069">$scope</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">HeadlineService</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">$scope</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">HeadlineService</span><span style="color: #24292f;background-color: #f6f8fa">)</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">use strict</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-5'>&nbsp;
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">HeadlineService</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">getHeadlines</span><span style="color: #24292f;background-color: #f6f8fa">().</span><span style="color: #8250df">success</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">data</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">status</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">headers</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #24292f;background-color: #f6f8fa">){</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">$scope</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">headlines</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">data</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">HeadlineService</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">getHeadlineForId</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">data</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0550ae">0</span><span style="color: #24292f;background-color: #f6f8fa">].</span><span style="color: #24292f;background-color: #f6f8fa">id</span><span style="color: #24292f;background-color: #f6f8fa">).</span><span style="color: #8250df">success</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">data</span><span style="color: #24292f;background-color: #f6f8fa">){</span>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">$scope</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">single_headline</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">data</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-11'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}).</span><span style="color: #8250df">error</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">error</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">status</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">headers</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #24292f;background-color: #f6f8fa">){</span>
</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #8250df">alert</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">n친got gick fel n칛r en rubrik h칛mtades</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-13'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">});</span>
</div><div class='code-line code-line-14'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}).</span><span style="color: #8250df">error</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">error</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">status</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">headers</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #24292f;background-color: #f6f8fa">){</span>
</div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #8250df">alert</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">n친got gick fel n칛r alla rubriker h칛mtades</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-16'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">});</span>
</div><div class='code-line code-line-17'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
</div><div class='code-line code-line-18'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">]);</span>
</div></code></div>

        <p>F칬r exempelvisa syften h칛mtar jag enbart det fulla rubrikobjektet f칬r den f칬rsta rubriken som returneras i <code>getHeadlines</code> success-callback.</p>

        <p>Det <code>$scope</code>-objektet 칛r exponerat f칬r vyerna i AngularJS, s친 vi kan visa rubrikerna p친 sidan genom att ha en vy som:</p>

        <pre><code class="language-html+erb">&lt;section class="headline_section" ng-controller="HeadlinesCtrl"&gt;

  &lt;h3&gt;H칛r 칛r n친gra rubriker...&lt;/h3&gt;

  &lt;div class="headlines"&gt;

    &lt;ul&gt;
      &lt;li ng-repeat="headline in headlines"&gt;
        &lt;a href="{{ headline.url }}" target="_none"&gt;{{ headline.title }}&lt;/a&gt;
      &lt;/li&gt;
    &lt;ul&gt;

  &lt;/div&gt;

  &lt;div class="headline"&gt;
    &lt;a href="{{ single_headline.url }}" target="_none"&gt;{{ single_headline.title }}&lt;/a&gt;
  &lt;/div&gt;

&lt;/section&gt;
</code></pre>

        <h2 id="rails-backend">Rails Backend</h2>

        <p>Nu n칛r vi har f친tt AngularJS att ringa v친r Rails-backend beh칬ver vi skriva Rails-backenden! F칬ljande kontrollant 칛r ganska grundl칛ggande ruby on rails, men f칬r att returnera JSONP i st칛llet f칬r gammaldags JSON anv칛nder vi <code>callback</code>-alternativet i <code>render</code>-metoden. Det ber칛ttar f칬r Rails att vi anv칛nder JSONP och att omsluta de JSON-data vi gav den i den callback och st칛lla in <code>Content-Type</code>-headern korrekt s친 att allting 칛r i enlighet med JSONP-standarden och v친r AngularJS-klient kan bearbeta data.</p>

        <div class="language-ruby highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #cf222e">class</span>&nbsp;<span style="color: #953800">Services::HeadlinesController</span>&nbsp;<span style="color: #0550ae">&lt;</span>&nbsp;<span style="color: #953800">ApplicationController</span>
</div><div class='code-line code-line-2'>&nbsp;
</div><div class='code-line code-line-3'>&nbsp;&nbsp;<span style="color: #cf222e">def</span>&nbsp;<span style="color: #8250df">index</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">page</span>&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">params</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">:page</span><span style="color: #24292f;background-color: #f6f8fa">]</span>&nbsp;<span style="color: #0550ae">||</span>&nbsp;<span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">).</span><span style="color: #8250df">to_i</span>
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">per</span>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">params</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">:per</span><span style="color: #24292f;background-color: #f6f8fa">]</span>&nbsp;&nbsp;<span style="color: #0550ae">||</span>&nbsp;<span style="color: #0550ae">5</span><span style="color: #24292f;background-color: #f6f8fa">).</span><span style="color: #8250df">to_i</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">offset</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">page</span>&nbsp;<span style="color: #0550ae">-</span>&nbsp;<span style="color: #0550ae">1</span><span style="color: #24292f;background-color: #f6f8fa">)</span>&nbsp;<span style="color: #0550ae">*</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">per</span>
</div><div class='code-line code-line-7'>&nbsp;
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">@headlines</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #953800">Headline</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">where</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">:disabled</span>&nbsp;<span style="color: #0550ae">=&gt;</span>&nbsp;<span style="color: #cf222e">false</span><span style="color: #24292f;background-color: #f6f8fa">).</span><span style="color: #8250df">offset</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">offset</span><span style="color: #24292f;background-color: #f6f8fa">).</span><span style="color: #8250df">limit</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">per</span><span style="color: #24292f;background-color: #f6f8fa">).</span><span style="color: #8250df">to_a</span>
</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">render</span>&nbsp;<span style="color: #0a3069">:json</span>&nbsp;<span style="color: #0550ae">=&gt;</span>&nbsp;<span style="color: #0550ae">@headlines</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">to_json</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">:callback</span>&nbsp;<span style="color: #0550ae">=&gt;</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">params</span><span style="color: #24292f;background-color: #f6f8fa">[</span><span style="color: #0a3069">:callback</span><span style="color: #24292f;background-color: #f6f8fa">]</span>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;<span style="color: #cf222e">end</span>
</div><div class='code-line code-line-