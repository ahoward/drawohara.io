<html color-mode="user" lang="sv">
  <head>
  <base href='/langs/sv' />
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DQVD9T27V4');
</script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- langs -->
  <!--
    https://developers.google.com/search/docs/specialty/international/localized-versions#html
  -->
   <link rel="alternate" hreflang="en" href="/" />
   <link rel="alternate" hreflang="uk" href="https://drawohara.io/langs/uk" />
   <link rel="alternate" hreflang="sv" href="https://drawohara.io/langs/sv" />
   <link rel="alternate" hreflang="fr" href="https://drawohara.io/langs/fr" />
   <link rel="alternate" hreflang="es" href="https://drawohara.io/langs/es" />
   <link rel="alternate" hreflang="it" href="https://drawohara.io/langs/it" />

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

  <!-- meta -->
    <title>Inget att se h√§r.</title>

<meta property="og:title" content="Inget att se h√§r."/>
<meta property="og:description" content="G√• vidare." />
<meta property="og:image" content="https://drawohara.io/media/mick.jpg" />




  <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"mobile-detection-behind-a-cdn"}">
    <meta property="site:path_info" content=""/mobile-detection-behind-a-cdn"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) { progressBar.remove(); }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a> &mdash;
<a href="mailto:i-love-this@drawohara.io?subject=/mobile-detection-behind-a-cdn">jag ‚ù§Ô∏è det h√§r!</a>
<small>
  <small>
    <small>
      <span title='drick mig'>&lt;&lt; klicka p√• mig üêõ ü´ñ üßö</a>
    </small>
  </small>
</small>
<hr>
<strong>/mobile-detection-behind-a-cdn</strong>
    </header>

    <main>
      <em>publicerat den: 2014-07-23</em>
<br>
<br>
<div class="ro markdown">
  <p>I ett nyligen projekt fick vi i uppdrag att bygga den mobila versionen av en befintlig webbplats. Den befintliga webbplatsen var egentligen inte ett bra kandidat f√∂r ett responsivt design, s√• vi best√§mde oss f√∂r att skapa en helt ny version av webbplatsen f√∂r mobila enheter.</p>

<p>![5547851770<em>3598506559_z.jpg](assets/b.jpeg)<br />
_(foto av <a href="https://www.flickr.com/photos/johanl/5547851770/in/photolist-9sfc3J-63nmeT-3BAAy-dWUBhB-pAZUn-ccjB1w-st5Gc-7B2UEE-bbLNKX-8yTj9M-9e6jeJ-72jTj6-8RU8QS-5TNHyH-8FkSqy-5r7dgL-5A6ymJ-atHdpQ-7BbKMK-8P8X2-7bD7t6-2ViX1A-5E6qqL-6NDF76-9hBh7m-4bSRnn-sZomP-6VbEE-buapa2-5Kw5si-85KrwR-5kpSzg-bjEUUE-bV9J19-5GXRmg-6zbLPt-8yWpiA-akq64F-5n4ciA-9hmSj5-msHvhK-hZpPt-bFe25b-Bjwzo-mFYCVT-d3v8y-6wRQrs-f1p7uv-f8rrUJ-ebxiKS">Johan Larsson</a>)</em></p>

<p>Till en b√∂rjan t√§nkte vi p√• att anv√§nda m√∂nstret m.example.com, d√§r webbplatserna √§r helt separata dom√§ner. Dock eftersom vi inte hanterar infrastrukturen f√∂r den h√§r webbplatsen ville vi g√• med en l√∂sning som skulle kr√§va s√• f√• infrastruktur√§ndringar som m√∂jligt. Att st√∂dja en annan dom√§n p√• samma servrar √§r inte s√§rskilt sv√•rt, men det √§r bara en uppgift som √§r l√§tt att r√•ka fel p√• och inte n√∂dv√§ndig i v√•rt fall.</p>

<p>Jag har √§ven sl√§ppt denna teknik f√∂r alla att enkelt anv√§nda i en rails-app via en rails-motor:</p>

<ul>
  <li>https://github.com/milesmatthias/cdddn</li>
  <li>http://rubygems.org/gems/cdddn</li>
</ul>

<h2 id="intro-till-cloudfront">Intro till CloudFront</h2>

<p>En stor f√∂rdel med den h√§r specifika webbplatsen √§r att den anv√§nder <a href="http://aws.amazon.com/cloudfront/">CloudFront</a>. CloudFront √§r ett inneh√•llsleveransn√§tverk (CDN), d√§r statiska webbsidor √§r v√§rd p√• <a href="http://aws.amazon.com/cloudfront/details/">52 datacenter runt om i v√§rlden</a>. Detta g√∂r att sidan kan serveras till webbl√§saren s√• snabbt som m√∂jligt eftersom oavsett var i v√§rlden du befinner dig, s√• kommer du inte vara l√•ngt ifr√•n en av CloudFronts noder s√• att det tar mindre tid att leverera webbplatsen till din enhet. CloudFront √§r en del av Amazons AWS-erbjudande och f√∂rutom att garantera hastighet, garanterar de √§ven drifttid. (Till skillnad fr√•n <a href="http://aws.amazon.com/s3/">S3</a>, d√§r endast drifttid garanteras.)</p>

<p>N√§r du anv√§nder CloudFront ber du den om var din webbserver finns s√• att CloudFront kan f√• den senaste versionen av webbsidorna den serverar √•t dig. CloudFront fr√•gar √§ven din webbserver efter nya versioner av dina webbsidor varje g√•ng, eller vilken tidsintervall du konfigurerar i ditt CloudFront-kontrollpanel. Normalt sett √§r det n√•gonstans runt 24 timmar. Detta g√∂r att CloudFront kan fokusera p√• tillg√§nglighet och hastighet, samtidigt som belastningen p√• din webbserver minskas mycket. (Det tar √§ven tid f√∂r CloudFront att ta en ny version av en sida och uppdatera alla 52 datacentern.)</p>

<p>Dock introducerar detta problemet med att sp√•ra status. Till exempel, om din webbplats serveras helt av CloudFront, hur ska du st√∂dja anv√§ndare som loggar in p√• din webbplats? Om jag √§r en anv√§ndare som heter Bob och sidan p√• <code>/my/account</code> s√§ger "Hej Bob!", kommer CloudFront att tro att alla som beg√§r sidan p√• <code>/my/account</code> ska se versionen av sidan som s√§ger "Hej Bob!". Anv√§ndare (f√∂rutom kanske personer som heter Bob‚Ä¶) kommer att bli mycket f√∂rvirrade. Inte bara det, utan vad om en anv√§ndare uppdaterar n√•got v√§rde i sitt konto och f√∂rv√§ntar sig att √§ndringen ska visas omedelbart? CloudFront f√•r inte en ny version av sidan p√• varje beg√§ran (det skulle i princip g√∂ra meningen med CloudFront betydelsel√∂s), det v√§ntar varje g√•ng i n√•gra minuter f√∂r att f√• en ny version. CloudFront har adresserat flera av dessa fr√•gor med <a href="http://aws.amazon.com/cloudfront/dynamic-content/">nya funktioner</a>, men du m√•ste vara medveten om dessa implikationer n√§r du anv√§nder CloudFront.</p>

<p>I v√•rt fall har webbplatsen vi jobbar med inte konceptet "anv√§ndare" och ingen kan logga in p√• systemet. Dock vill vi fortfarande att CloudFront ska visa olika versioner av webbplatsen beroende p√• vilken enhet du beg√§r webbplatsen ifr√•n (mobil eller dator).</p>

<p>CloudFront kan g√∂ra enhetsdetektion √•t dig och sedan skicka en speciell huvudtext till din webbserver f√∂r att s√§ga "Ge mig versionen av sidan f√∂r en telefon", dock ville vi ha kontroll √∂ver metoden f√∂r enhetsdetektion (besvara fr√•gan - √§r detta en telefon eller en dator?) och vi ville ha m√∂jligheten f√∂r slutanv√§ndare och utvecklare att √•sidos√§tta den enhet som valts f√∂r dem. Till exempel kan slutanv√§ndare p√• en surfplatta bara vilja se datorversionen √§ven om vi visar dem mobilversionen till en b√∂rjan. V√•ra utvecklare kommer √§ven att hitta det besv√§rligt att byta enhet varje g√•ng de vill byta mellan versionerna n√§r de bygger webbplatsen.</p>

<h2 id="v√•r-l√∂sning">V√•r l√∂sning</h2>

<p>S√• h√§r √§r metoden vi kom p√• f√∂r att ha b√•de en dator- och mobilversion av en webbplats p√• samma dom√§n och serveras av CloudFront. Ett n√∂dv√§ndigt p√•pekande √§r att CloudFront normalt inaktiverar alla cookies f√∂r din dom√§n, men du kan konfigurera den att till√•ta cookies som du namnger. I v√•rt fall sa vi till CloudFront att till√•ta en cookie som heter 'enhet'. Observera √§ven att vi √§r i kontexten av en rails 4-app, men den h√§r arkitekturen kan replikeras i vilken stack som helst. Huvudpo√§ngen h√§r √§r att klienten m√•ste lista ut vilken enhet anv√§ndaren √§r p√•, till√•ta dem att √•sidos√§tta det, och h√•lla servern informerad om enhetstypen s√• att servern kan servera de r√§tta sidorna (detta g√∂rs via cookies).</p>

<h3 id="p√•-varje-sida-m√•ste-vi-g√∂ra-n√•got-likt-detta-kodsnutt-fr√•n-appviewslayoutapplicationhtmlerb">P√• varje sida m√•ste vi g√∂ra n√•got likt detta (kodsnutt fr√•n app/views/layout/application.html.erb)</h3>

<pre><code class="language-html+erb">&lt;%= javascript_include_tag "mobile_detection" %&gt;

&lt;script&gt;

  if (!window.location.href.match(/get_device|set_device/)){
    console.log('loggar window.location.href = ' + window.location.href);
    localStorage.setItem('referrer_href', window.location.href);
  }

  var device_cookie  = cookie.get('device'),
      cookiesEnabled = cookie.enabled();

  if (cookiesEnabled &amp;&amp; device_cookie == undefined) {
    window.location = '/get_device.html'
  }

&lt;/script&gt;
</code></pre>

<p>Ovanst√•ende kod kommer enbart ih√•g vilken sida du landade p√• (vanligtvis startsidan, men vi vill att klienten ska kunna dela l√§nkar och f√• det att fungera p√• mobilen ocks√•), och sedan omdirigerar dig till <code>/get_device</code>-sidan f√∂r att detektera din enhet om vi inte gjort det √§nnu. Observera anv√§ndandet av <code>localStorage</code>, vilket inneb√§r att detta endast kommer att fungera p√• IE8+ och inte kommer att fungera p√• Opera Mini.</p>

<p>Observera √§ven att ovanst√•ende kodsnutt placeras i <code>&lt;head&gt;</code> i layouten s√• att den kommer att k√∂ras s√• snabbt som m√∂jligt och f√∂re n√•gra skript som datorversionen kan ha. I det h√§r fallet anv√§nder datorversionen mycket javascript f√∂r att ladda mycket inneh√•ll, s√• vi ville egentligen inte att allt det skulle h√§nda p√• en telefon innan webbplatsen ins√•g att anv√§ndaren skulle se mobilversionen av webbplatsen.</p>

<h3 id="p√•-varje-mobil-sida-m√•ste-vi-g√∂ra-detta-fr√•n-appviewslayoutapplicationmobileerb">P√• varje mobil sida m√•ste vi g√∂ra detta (fr√•n `app/views/layout/application.mobile.erb):</h3>

<div class="language-js highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #24292f;background-color: #f6f8fa">script</span><span style="color: #0550ae">&gt;</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">device_cookie</span>&nbsp;&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">get</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">device</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">),</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookiesEnabled</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">enabled</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
</div><div class='code-line code-line-4'>&nbsp;
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">if </span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">cookiesEnabled</span>&nbsp;<span style="color: #0550ae">&amp;&amp;</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">device_cookie</span>&nbsp;<span style="color: #0550ae">==</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">desktop</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">)</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">reload</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">true</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #116329">/script</span><span style="color: #f6f8fa;background-color: #82071e">&gt;</span>
</div></code></div>

<p>Detta eftersom mobila enheter cachar sidorna kraftigt (vilket √§r f√∂rst√•eligt) s√• om anv√§ndaren har √§ndrat enheten de √§r p√•, m√•ste vi se till att vi skickar den uppdaterade cookien till servern √§ven om URL:en inte har √§ndrats (och d√§rmed cachen tror att det √§r samma sida som ska serveras). <code>true</code> i <code>reload</code>-funktionsanropet ber webbl√§saren att ignorera vad som finns i cachen.</p>

<p>Observera att vi g√∂r exakt samma sak p√• varje dator-sida ocks√•, f√∂rutom att kontrollera om anv√§ndaren har √§ndrat sin enhet till <code>'mobile'</code>.</p>

<h3 id="enhetsdetektion-p√•-get_device-appviewshomeget_devicehtml">Enhetsdetektion p√• <code>/get_device</code> (app/views/home/get_device.html)</h3>

<div class="language-js highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #24292f;background-color: #f6f8fa">script</span><span style="color: #0550ae">&gt;</span>
</div><div class='code-line code-line-2'>&nbsp;
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">function</span>&nbsp;<span style="color: #8250df">isMobile</span><span style="color: #24292f;background-color: #f6f8fa">(){</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">MOBILE_USER_AGENTS</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">palm|blackberry|nokia|phone|midp|mobi|symbian|chtml|ericsson|minimo|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">audiovox|motorola|samsung|telit|upg1|windows ce|ucweb|astel|plucker|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">x320|x240|j2me|sgh|portable|sprint|docomo|kddi|softbank|android|mmp|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">pdxgw|netfront|xiino|vodafone|portalmmm|sagem|mot-|sie-|ipod|up</span><span style="color: #0a3069">\\</span><span style="color: #0a3069">.b|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">webos|amoi|novarra|cdm|alcatel|pocket|ipad|iphone|mobileexplorer|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">mobile|zune</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">mobile_regex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">new</span>&nbsp;<span style="color: #953800">RegExp</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">MOBILE_USER_AGENTS</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">i</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-11'>&nbsp;
</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">return</span>&nbsp;<span style="color: #953800">navigator</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">userAgent</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">match</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">mobile_regex</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-13'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
</div><div class='code-line code-line-14'>&nbsp;
</div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// st√§ller in cookien f√∂r enhet till vad vi detekterar</span>
</div><div class='code-line code-line-16'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">detected_device</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #8250df">isMobile</span><span style="color: #24292f;background-color: #f6f8fa">()</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">?</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">mobile</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">:</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">desktop</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-17'>&nbsp;
</div><div class='code-line code-line-18'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">set</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">device</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">detected_device</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-19'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #116329">domain</span><span style="color: #24292f;background-color: #f6f8fa">:</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">&lt;%= Rails.env.development? ? </span><span style="color: #0a3069">''</span><span style="color: #0a3069"> : Settings.host %&gt;</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
</div><div class='code-line code-line-20'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #116329">path</span>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">:</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">/</span><span style="color: #0a3069">'</span>
</div><div class='code-line code-line-21'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">});</span>
</div><div class='code-line code-line-22'>&nbsp;
</div><div class='code-line code-line-23'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// window.location till varifr√•n du kom ifr√•n</span>
</div><div class='code-line code-line-24'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">assign</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">localStorage</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">getItem</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">referrer_href</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">));</span>
</div><div class='code-line code-line-25'>&nbsp;
</div><div class='code-line code-line-26'>&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #116329">/script</span><span style="color: #f6f8fa;background-color: #82071e">&gt;</span>
</div></code></div>

<h3 id="enhet-√•sidos√§ttning-p√•-set_device-appviewshomeset_devicehtml">Enhet √•sidos√§ttning p√• <code>/set_device</code> (app/views/home/set_device.html)</h3>

<pre><code class="language-html+erb">&lt;body style="background-color:#f1f1f2"&gt;

  &lt;h1&gt;Vilken enhet vill du se webbplatsen som?&lt;/h1&gt;

  &lt;form id="device_selection_form"&gt;
    &lt;input type="radio" name="device_option" value="desktop"&gt;Dator&lt;/input&gt;
    &lt;input type="radio" name="device_option" value="mobile"&gt;Mobil&lt;/input&gt;

    &lt;button id="set_device_btn"&gt;St√§ll in enhet&lt;/button&gt;
  &lt;/form&gt;


  &lt;script&gt;

    document.getElementById('set_device_btn').addEventListener('click', function(e){

      // st√§ller in cookien f√∂r enhet till ditt val
      var options         = document.getElementsByName('device_option'),
          selected_device = '';

      for(var i=0; i &lt; options.length; i++){
        if (options[i].checked) {
          selected_device = options[i].value;
        }
      }

      cookie.set('device', selected_device, {
        domain: '&lt;%= Rails.env.development? ? '' : Settings.host %&gt;',
        path  : '/'
      });

      // window.location till varifr√•n du kom ifr√•n
      window.location.assign(localStorage.getItem('referrer_href'));

      alert('Okej, vi st√§llde in din enhet till ' + selected_device);

      e.preventDefault();
      return false;
    });


  &lt;/script&gt;

&lt;/body&gt;
</code></pre>

<p>N√§r du har st√§llt in din CloudFront-distribution f√∂r att f√• webbsidor fr√•n din webbserver (aka origin i CloudFront-termer), kan du navigera till CloudFront-dom√§nen via din webbl√§sare f√∂r att verifiera att CloudFront cachar dina webbsidor. I Chrome inneb√§r det att navigera till fliken "Network" i utvecklarverktygen, klicka p√• den inledande sidbeg√§ran och leta efter en huvudtext som heter "X-Cache". Huvudtextens v√§rde kommer antingen vara "Hit from CloudFront" eller "Miss from CloudFront", beroende p√• om CloudFront hade den h√§r speciella sidan/cookien-kombinationen cachad eller inte.</p>

<p>Om du vill anv√§nda den h√§r tekniken i din egen rails-app har jag skapat en Rails-motor f√∂r att enkelt inkorporera. Se:</p>

<ul>
  <li>https://github.com/milesmatthias/cdddn</li>
  <li>http://rubygems.org/gems/cdddn</li>
</ul>

</div>
    </main>

    <footer>
      <hr>
<a href="/goto" name="goto">&mdash;&gt; g√• till</a>
<blockquote>
<ul>
  <li>
    <a href="mailto:i-hate-this@drawohara.io?subject=/mobile-detection-behind-a-cdn">üò©, jag üñ§ ^det h√§r!</a>
  </li>
  <li>
    <a href="/now">/nu</a>
  </li>
  <li>
    <a href="/about">/om</a>
  </li>
  <li>
    <a href="/contact">/kontakt</a>
  </li>
</ul>
</blockquote>
<a href="/">&lt;&mdash; avbryt</a>
    </footer>
  </body>
</html>