<html color-mode="user" lang="sv">
  <head>
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DQVD9T27V4');
</script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

  <!-- meta -->
    <title>Laga mat med Vagrant, Librarian och Chef-Solo</title>

<meta property="og:title" content="Laga mat med Vagrant, Librarian och Chef-Solo"/>
<meta property="og:description" content="gå vidare." />
<meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

<meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content="/dojo4/archive/:id">
    <meta property="site:params" content="{"ext":null,"id":"cooking-up-a-storm-with-vagrant-librarian-and-chef-solo}">
    <meta property="site:path_info" content="/cooking-up-a-storm-with-vagrant-librarian-and-chef-solo">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) {
          progressBar.remove();
        }
      });
    </script>
    <base href='/sv' />
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a>
<hr>
    </header>

    <main>
      <div class="ro markdown">
  <p>Det är ganska enkelt att konfigurera apache på en enskild dator. Det blir lite mer intressant om du har flera värdar i konfigurationen. Det blir ännu roligare när du har en komplex konfiguration som inkluderar proxy, URL-omskrivning och någon textersättning.</p>

<p>Men fortfarande inget som en erfaren systemadministratör inte kan hantera med lite omsorg.</p>

<p>Tills nu, när du måste göra det igen.</p>

<p>Här kommer verktyg som <a href="http://www.opscode.com">Chef</a> och <a href="http://puppetlabs.com">Puppet</a> in i bilden. Båda verktygen låter dig deklarera och definiera vad system skulle se ut och hur de skulle konfigureras. Båda är kraftfulla och båda används aktivt för att konfigurera allt från <a href="https://github.com/boxen/boxen">utvecklar</a> <a href="https://github.com/atmos/cinderella">arbetsstationer</a> till <a href="http://www.opscode.com/press-releases/facebook-likes-opscode-and-private-chef/">stora distributioner av hundratals tusen maskiner</a>.</p>

<p>Precis som mjukvara måste du fortfarande bygga och testa konfigurationen som du bygger. Dina alternativ för att göra detta sträcker sig från den riktigt dyra (köp en eller flera servrar), till den måttligt dyra (kör några instanser på EC2) till den riktigt, riktigt billiga. Den riktigt billiga alternativet skulle vara att bygga och testa dina recept på virtuell maskin(er) som körs på ditt system. Här kommer <a href="http://www.vagrantup.com/">Vagrant</a> in i bilden.</p>

<p>Vagrant är ett omslag kring Oracles <a href="https://www.virtualbox.org/">VirtualBox</a> skrivbordsvirtualiseringsplattform. Vagrants konfiguration kretsar kring några enkla koncept. Du har en konfigurationsfil med namnet <code>Vagrantfile</code> i rotkatalogen för projektet. Den filen innehåller någon grundläggande konfiguration, såsom vilken basbox som ska användas för projektet och vilka portar som ska exponeras för värdsystemet. Och lika viktigt, den kan beskriva hur den virtuella maskinen ska förberedas så att den passar behoven i ditt projekt. Även om Vagrant stöder både Puppet och Chef, valde jag att använda Chef-Solo för att förbereda detta projekt.</p>

<p>Att komma igång med Vagrant är enkelt. Det första steget är enkelt att installera <code>vagrant</code> gem. Precis som varje annat Ruby-projekt valde jag att installera <code>vagrant</code> och några andra gems via Bundler. Här är den resulterande <code>Gemfile</code>:</p>

<div class="language-ruby highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #24292f;background-color: #f6f8fa">source</span>&nbsp;<span style="color: #0a3069">'https://rubygems.org'</span>
</div><div class='code-line code-line-2'>
</div><div class='code-line code-line-3'><span style="color: #24292f;background-color: #f6f8fa">gem</span>&nbsp;<span style="color: #0a3069">'vagrant'</span>
</div><div class='code-line code-line-4'><span style="color: #24292f;background-color: #f6f8fa">gem</span>&nbsp;<span style="color: #0a3069">'librarian'</span>
</div></code></div>

<p>Att köra <code>bundle install</code> installerade de nödvändiga gems i projektkatalogen. En snabb <code>rbenv rehash</code> gjorde Vagrant-skriptet tillgängligt för mitt skal.</p>

<p>Nästa steg var att ställa in den mest grundläggande av Vagrants konfiguration. Jag körde <code>vagrant init</code> och redigerade sedan den resulterande Vagrantfilen så att den såg ut så här:</p>

<div class="language-ruby highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #953800">Vagrant</span><span style="color: #0550ae">::</span><span style="color: #953800">Config</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">run</span>&nbsp;<span style="color: #cf222e">do</span>&nbsp;<span style="color: #0550ae">|</span><span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #0550ae">|</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;<span style="color: #6e7781"># Varje Vagrant virtuella miljö kräver en box för att bygga från.</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">vm</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">box</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"ubuntu-precise-64"</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;
</div><div class='code-line code-line-5'>&nbsp;&nbsp;<span style="color: #6e7781"># URL:en från vilken 'config.vm.box' box kommer att hämtas om den</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;<span style="color: #6e7781"># redan inte finns på användarens system.</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">vm</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">box_url</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"http://files.vagrantup.com/precise64.box"</span>
</div><div class='code-line code-line-8'><span style="color: #cf222e">end</span>
</div></code></div>

<p>Detta uppnår två saker. Först, det deklarerar namnet på boxen som vi ska bygga på och var vi kan hitta den boxen. En snabb <code>vagrant up</code> kommer initialt att ladda ner basboxen, importera den i projektet och starta den virtuella maskinen. Det tar en stund att ladda ner boxen, men den är cachelagrad på ditt system så du behöver inte ladda ner den igen. Du kan även återanvända samma basbox om du väljer att göra det i andra projekt. Att anropa <code>vagrant halt</code> stoppar den virtuella maskinen och att anropa <code>vagrant destroy</code>, ja, förstör den virtuella maskinen.</p>

<p>Vi har fortfarande inte gjort mycket för att förbereda vår virtuella maskin dock. Nästa steg är att berätta för Vagrant hur man gör det.</p>

<p><a href="https://github.com/applicationsonline/librarian">Librarian</a> är en annan fin gem i linje med Bundler och CocoaPods som låter dig deklarera vilka Chef-recept du använder. I vårt fall ser en redigerad kopia av projektets <code>Cheffile</code> ut så här:</p>

<div class="language-ruby highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #6e7781">#!/usr/bin/env ruby</span>
</div><div class='code-line code-line-2'><span style="color: #6e7781">#^syntax detection</span>
</div><div class='code-line code-line-3'>
</div><div class='code-line code-line-4'><span style="color: #24292f;background-color: #f6f8fa">site</span>&nbsp;<span style="color: #0a3069">'http://community.opscode.com/api/v1'</span>
</div><div class='code-line code-line-5'>
</div><div class='code-line code-line-6'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'apt'</span>
</div><div class='code-line code-line-7'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'apache2'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">'&gt;= 1.0.0'</span>
</div><div class='code-line code-line-8'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'rbenv'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">:git</span>&nbsp;<span style="color: #0550ae">=&gt;</span>&nbsp;<span style="color: #0a3069">'git://github.com/fnichol/chef-rbenv.git'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">:ref</span>&nbsp;<span style="color: #0550ae">=&gt;</span>&nbsp;<span style="color: #0a3069">'v0.7.2'</span>
</div><div class='code-line code-line-9'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'ruby_build'</span>
</div><div class='code-line code-line-10'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'openssh'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">:git</span>&nbsp;<span style="color: #0550ae">=&gt;</span>&nbsp;<span style="color: #0a3069">'git://github.com/fnichol/chef-openssh.git'</span>
</div><div class='code-line code-line-11'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'git'</span>
</div><div class='code-line code-line-12'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'build-essential'</span>
</div><div class='code-line code-line-13'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'vim'</span>
</div><div class='code-line code-line-14'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'user'</span>
</div><div class='code-line code-line-15'><span style="color: #24292f;background-color: #f6f8fa">cookbook</span>&nbsp;<span style="color: #0a3069">'sudo'</span>
</div></code></div>

<p>Den största fördelen är att du inte behöver sälja kokböckerna i dina projekt. Att köra <code>librarian-chef install</code> kommer att hämta kokböckerna och installera dem under katalogen <code>cookbooks</code>. Detta genererade även en <code>Cheffile.lock</code> för att dokumentera vilka versioner av kokböckerna som installerades.</p>

<p>Jag var då i en position där jag kunde berätta för Vagrant att använda Chef-Solo för att förbereda boxen genom att uppdatera <code>Vagrantfile</code>:</p>

<div class="language-ruby highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #953800">Vagrant</span><span style="color: #0550ae">::</span><span style="color: #953800">Config</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">run</span>&nbsp;<span style="color: #cf222e">do</span>&nbsp;<span style="color: #0550ae">|</span><span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #0550ae">|</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;<span style="color: #6e7781"># Varje Vagrant virtuella miljö kräver en box för att bygga från.</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">vm</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">box</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"ubuntu-precise-64"</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;
</div><div class='code-line code-line-5'>&nbsp;&nbsp;<span style="color: #6e7781"># URL:en från vilken 'config.vm.box' box kommer att hämtas om den</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;<span style="color: #6e7781"># redan inte finns på användarens system.</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">config</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">vm</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">box_url</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"http://files.vagrantup.com/precise64.box"</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;
</div><div class='code-line code-line-9'>&nbsp;&nbsp;<span style="color: #6e7781"># Aktivera provisioning med chef solo, specificera en kokbokssökväg, roll</span>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;<span style="color: #6e7781"># sökväg och data_bags sökväg (alla relativt till denna Vagrantfile), och lägg</div><div class='code-line code-line-11'>&nbsp;&nbsp;<span style="color: #6e7781"># till några recept och/eller roller.</span>
</div><div class='code-line code-line-