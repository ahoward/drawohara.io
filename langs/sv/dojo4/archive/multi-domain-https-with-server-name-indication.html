<html color-mode="user" lang="sv">
  <head>
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DQVD9T27V4');
    </script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- langs -->
  <!--
    https://developers.google.com/search/docs/specialty/international/localized-versions#html
  -->
   <link rel="alternate" hreflang="en" href="/" />
   <link rel="alternate" hreflang="uk" href="https://drawohara.io/langs/uk" />
   <link rel="alternate" hreflang="sv" href="https://drawohara.io/langs/sv" />
   <link rel="alternate" hreflang="fr" href="https://drawohara.io/langs/fr" />
   <link rel="alternate" hreflang="es" href="https://drawohara.io/langs/es" />
   <link rel="alternate" hreflang="it" href="https://drawohara.io/langs/it" />

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <base href='/langs/sv' />

  <!-- meta -->
    <title>Inget att se h√§r.</title>

    <meta property="og:title" content="Inget att se h√§r."/>
    <meta property="og:description" content="G√• vidare." />
    <meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

    <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content="/dojo4/archive/:id">
    <meta property="site:params" content="{&quot;ext&quot;:null,&quot;id&quot;:&quot;multi-domain-https-with-server-name-indication&quot;}">
    <meta property="site:path_info" content="/multi-domain-https-with-server-name-indication">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) { progressBar.remove(); }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a> &mdash;
      <a href="mailto:i-love-this@drawohara.io?subject=/multi-domain-https-with-server-name-indication">jag ‚ù§Ô∏è det h√§r!</a>
      <small>
        <small>
          <small>
            <span title='drick mig'>&lt;&lt; klicka p√• mig üêõ ü´ñ üßö</a>
          </small>
        </small>
      </small>
      <hr>
      <strong>/multi-domain-https-with-server-name-indication</strong>
    </header>

    <main>
      <em>publicerad den: 2014-12-18</em>
      <br>
      <br>
      <div class="ro markdown">
        <p>(Detta √§r en f√∂rkortad version av <a href="http://www.stuff-things.net/2014/11/14/yes-virginia-you-can-use-sni/">Ja, Virginia, du kan anv√§nda SNI</a> som ursprungligen publicerades p√• Spikes <a href="http://www.stuff-things.net/">Saker‚Ä¶ Och Grejer‚Ä¶ blogg</a>)</p>

        <p>N√§r du ansluter till en webbserver s√§kert med HTTPS f√∂rhandlas s√§kerheten med hj√§lp av <a href="http://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</a>. Tv√• saker h√§nder, serverns identitet verifieras och anslutningen krypteras.</p>

        <p>Verifieringen √§r viktig, det spelar ingen roll om anslutningen √§r krypterad om du p√• n√•got s√§tt har omdirigerats till en ondskingsfulls server. Dock kan verifieringen vara problematisk om en webbserver betj√§nar mer √§n ett dom√§nnamn.</p>

        <p>Du kan l√§sa de <a href="http://en.wikipedia.org/wiki/Transport_Layer_Security#TLS_handshake">blodiga detaljerna</a>, men den f√∂renklade versionen av processen √§r att servern skickar ett signerat <a href="http://en.wikipedia.org/wiki/Public_key_certificate">offentligt nyckelcertifikat</a> som m√•ste matcha dom√§nnamnet i URL:en. Om en klient bl√§ddrar till dojo4.com m√•ste certifikatet vara f√∂r dojo4.com, om det inte √§r det visar webbl√§saren ett stort skr√§mmande varning.</p>

        <p>Tekniskt sett √§r det m√∂jligt att ha flera dom√§nnamn p√• ett certifikat, faktiskt √§r det vanligt att ha till exempel b√•de ‚Äúdojo4.com‚Äù och ‚Äúwww.dojo.com‚Äù f√∂r fullst√§ndighet. Dock √§r det en enorm sm√§rta i rumpan att l√§gga till och ta bort dom√§nnamn fr√•n ett certifikat. Du m√•ste f√• utf√§rdaren att generera ett nytt och √•terkalla det gamla. Och om du arbetar med ett Content Delivery Network, √§r de ganska osannolika att l√§gga till dina dom√§nnamn till deras certifikat.</p>

        <p>Ursprungligen st√∂dde TLS endast ett certifikat per webbserver (eller mer korrekt, per IP-adress som √§r kopplad till webbservern). <a href="http://en.wikipedia.org/wiki/Server_Name_Indication">Server Name Indication (SNI)</a> lades till i TLS f√∂r att l√∂sa detta problem. I b√∂rjan av TLS-f√∂rhandlingen ber√§ttar klienten f√∂r servern namnet p√• den v√§rd den f√∂rs√∂ker ansluta till och servern kan d√• v√§lja och skicka en korrekt certifikatfil. Problem l√∂st!</p>

        <p>Men‚Ä¶ Inte alla webbl√§sare st√∂djer SNI. Alla <em>vet</em> detta, och som ett resultat tenderar de att hoppa √∂ver SNI och g√• direkt till dedikerade IP-adresser per plats eller till och med flera servrar. Detta √§r en dyr alternativ, speciellt n√§r man arbetar med CDN:er som CloudFront. N√§r detta kom upp f√∂r mig best√§mde jag mig f√∂r att se vad ‚Äúinte alla webbl√§sare‚Äù verkligen betydde.</p>

        <p>Det visar sig att SNI st√∂ds brett, med de stora problemen som √§r IE8 och l√§gre och n√•gon version av IE som k√∂rs p√• Windows XP (eftersom det underliggande operativsystemsbiblioteket inte st√∂djer SNI). Det finns √§ven n√•gra gamla versioner av Android d√§r som saknar st√∂d.</p>

        <p>S√•, de flesta bes√∂kare kommer inte att ha n√•gra problem med SNI och gruppen som g√∂r det √§r liten nog att vi kan hantera dem som ett specialfall.</p>

        <p>F√∂r de webbl√§sare utan SNI-st√∂d √§r l√∂sningen att omdirigera dem till ett certifikat som kommer att fungera eller en sarkastisk ‚Äúuppgradera din webbl√§sare‚Äù-sida. Om du googlar hittar du en massa l√∂sningar kring att bygga vita listor f√∂r bra webbl√§sare och/eller svarta listor f√∂r d√•liga och sedan anv√§nda dessa listor i serversida omdirigeringsregler. Fult. Listorna m√•ste underh√•llas och beroende p√• servern bryter cachen.</p>

        <p>Det finns ett smartare s√§tt. Medan jag vadade genom ett hav av exempel p√• Apache-omdirigeringskonfigurationer hittade jag det i denna <a href="https://www.ebower.com/wiki/Detecting_SNI_with_Apache">post</a>. Postens k√§rnid√© kan destilleras ner till detta, om en webbl√§sare som inte st√∂djer SNI f√∂rs√∂ker ladda SNI-inneh√•ll kommer den att f√• ett fel. Om vi testar detta i bakgrunden och skiljer mellan fel och framg√•ng, kan vi omdirigera bes√∂karen enligt det. Och det enklaste s√§ttet att g√∂ra det √§r att f√∂rs√∂ka l√§gga till en pixeldocka till sidan.</p>

        <p>I kod ser det ut s√• h√§r:</p>

        <div class="language-javascript highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'><span style="color: #cf222e">function</span>&nbsp;<span style="color: #8250df">secure_redirect</span><span style="color: #24292f;background-color: #f6f8fa">()</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #0550ae">=</span><span style="color: #953800">document</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">createElement</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">img</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">);</span>&nbsp;<span style="color: #6e7781">// skapa ett img-element.</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Ange src till en SNI-URL f√∂r en pixeldocka</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">src</span><span style="color: #0550ae">=</span><span style="color: #0a3069">'</span><span style="color: #0a3069">https://www.example.org/pixel.gif</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Detta utf√∂rs om SNI fungerar.</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">onload</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">()</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Omdirigera till den s√§kra sidan.</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">href</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">https://example.org/</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">};</span>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Detta utf√∂rs om SNI inte fungerar.</span>
</div><div class='code-line code-line-11'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">onerror</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">function</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">e</span><span style="color: #24292f;background-color: #f6f8fa">)</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Omdirigera annorst√§des</span>
</div><div class='code-line code-line-13'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">href</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">http://example.org/snarky-old-browser-message</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-14'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">};</span>
</div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// Visa inte faktiskt bilden</span>
</div><div class='code-line code-line-16'>&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">style</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">display</span><span style="color: #0550ae">=</span><span style="color: #0a3069">'</span><span style="color: #0a3069">none</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">;</span>
</div><div class='code-line code-line-17'>&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// men l√§gg till den till sidorna s√• att den laddas.</span>
</div><div class='code-line code-line-18'>&nbsp;&nbsp;&nbsp;<span style="color: #953800">document</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">body</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">appendChild</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">img</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-19'>&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
</div></code></div>

        <p>H√§r utnyttjar jag tv√• HTML-callbacks p√• <em>img</em>-taggen, ‚ÄòOnLoad‚Äô som avfyras n√§r en bild har slutat laddas, och ‚ÄòOnError‚Äô som avfyras om bilden inte kan laddas. Om en webbl√§sare inte st√∂djer SNI kommer bilden att misslyckas med att ladda p√• grund av ett certifikatfel, och ‚ÄòOnError‚Äô kommer att avfyras. Men eftersom vi l√§gger till bilden till en redan laddad sida kommer den inte att orsaka ett fel i webbl√§saren.</p>

        <p>Nu kan vi testa f√∂r SNI och hantera brist p√• st√∂d med elegans. Julen √§r r√§ddad!</p>

        <p>Dock √§r det vi egentligen kommit fram till n√•got mer slugt. Observera att koden inte testar f√∂r SNI, bara f√∂rm√•gan att s√§kert ladda bilden. Om HTTPS-URL:en i fr√•ga inte verkligen kr√§ver SNI, finns det bara ett certifikat eller det f√∂rsta certifikatet matchar den beg√§rda dom√§nen, fungerar det fortfarande. Problemet har reducerats till ‚ÄúKan denna bes√∂karens webbl√§sare visa den s√§kra sidan eller inte?‚Äù och n√§r allt kommer omkring √§r det allt vi egentligen bryr oss om.</p>

      </div>
    </main>

    <footer>
      <hr>
      <a href="/goto" name="goto">&mdash;&gt; goto</a>
      <blockquote>
      <ul>
        <li>
          <a href="mailto:i-hate-this@drawohara.io?subject=/multi-domain-https-with-server-name-indication">üò©, jag üñ§ ^det h√§r!<a>
        </li>
        <li>
          <a href="/now">/nu<a>
        </li>
        <li>
          <a href="/about">/om<a>
        </li>
        <li>
          <a href="/contact">/kontakt<a>
        </li>
      </ul>
      </blockquote>
      <a href="/">&lt;&mdash; avbryt</a>
    </footer>
  </body>
</html>