<html color-mode="user" lang="sv">
  <head>
    <base href='/langs/sv' />
    <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-DQVD9T27V4');
    </script>

    <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

    <!-- langs -->
    <!--
      https://developers.google.com/search/docs/specialty/international/localized-versions#html
    -->
    <link rel="alternate" hreflang="en" href="/" />
    <link rel="alternate" hreflang="uk" href="https://drawohara.io/langs/uk" />
    <link rel="alternate" hreflang="sv" href="https://drawohara.io/langs/sv" />
    <link rel="alternate" hreflang="fr" href="https://drawohara.io/langs/fr" />
    <link rel="alternate" hreflang="es" href="https://drawohara.io/langs/es" />
    <link rel="alternate" hreflang="it" href="https://drawohara.io/langs/it" />

    <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

    <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

    <!-- meta -->
    <title>Inget att se h칛r.</title>

    <meta property="og:title" content="Inget att se h칛r."/>
    <meta property="og:description" content="Forts칛tt." />
    <meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

    <meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"tips-for-mongodb-migrations-in-rails"}">
    <meta property="site:path_info" content=""/tips-for-mongodb-migrations-in-rails"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) { progressBar.remove(); }
      });
    </script>
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a> &mdash;
      <a href="mailto:i-love-this@drawohara.io?subject=/tips-for-mongodb-migrations-in-rails">jag 仇벒잺 det h칛r!</a>
      <small>
        <small>
          <small>
            <span title='drick mig'>&lt;&lt; klicka p친 mig 游냍 游삈 游빀</a>
          </small>
        </small>
      </small>
      <hr>
      <strong>/tips-for-mongodb-migrations-in-rails</strong>
    </header>

    <main>
      <em>publicerad den: 2011-12-27</em>
      <br>
      <br>
      <p>Jag vill dela en snabb och enkel metod f칬r att testa Rails-migreringar n칛r man anv칛nder MongoDB-databasen. MongoDB:s och rubys flexibilitet g칬r detta ganska enkelt. I det h칛r exemplet kommer vi att byta namn p친 en f칛lt i v친r exempel "books"-samling fr친n "isbn" till "book_number". Det 칛r en ganska vanlig typ av migrering och n칛r du v칛l har f친tt hang av det h칛r enkla fallet, f칬ljer mer komplexa migreringar samma m칬nster. F칬rst, l친t oss generera v친r tidst칛mlade migreringsskriptmall.</p>
      <pre><code>rails generate migration rename_isbn_to_book_number
</code>
      </pre>
      <p>Sedan redigerar vi filen som genererades under <code>db/migrate</code>. Vi delar upp v친r kod i flera avsnitt enligt f칬ljande.</p>
      <ol>
        <li>N친gra klasskonstanter delade av alla metoder</li>
        <li>Metoden <code>self.up</code> som utf칬r migreringen fram친t</li>
        <li>En hj칛lpmetod f칬r att st칛lla in n친gra exempeldata f칬r att testa migreringen fram친t</li>
        <li>Metoden <code>self.down</code> som utf칬r 친terst칛llningen</li>
        <li>En hj칛lpmetod f칬r att st칛lla in n친gra exempeldata (om s친 beh칬vs) f칬r att testa 친terst칛llningen</li>
      </ol>
      <p>F칬rst, definiera bara n친gra konstanter som v친ra metoder kommer att anv칛nda. Vi lagrar Mongo-uppdateringsalternativhash <code>MultiUpdate</code> f칬r bekv칛mlighet eftersom de flesta migreringsuppdateringsoperationer vill upsert false (skapa inga nya dokument), multi true (uppdatera alla matchande dokument) och safe true.</p>
      <p>Vi definierar ocks친 en konstant f칬r samlingsnamnet. F칬r den riktiga migreringen 칛r samlingen "books", men f칬r testning kommer vi att skapa en ny samling som heter "test_books_migration" n칛r vi utvecklar v친r kod.</p>
      <pre><code>class RenameIsbnToBookNumber &lt; Mongoid::Migration
  MultiUpdate = {:upsert =&gt; false, :multi =&gt; true, :safe=&gt;true}
  Collection = db.collection("books") #Slutlig produktionskod
  Collection = db.collection("test_books_migration") #Endast f칬r testning i konsolen
  def up
  end

  def down
  end
end
</code>
      </pre>
      <p>OK, det 칛r v친r initiala mall. N칛sta steg 칛r att ta en s칛kerhetskopia av v친r utvecklingsdatabas om det finns n친gra data d칛r som vi inte vill r친ka f칬rst칬ra. Sedan b칬rjar vi koda en liten hj칛lpmetod f칬r att fylla i v친r testsamling med falska dokument som liknar det vi f칬rv칛ntar oss se i produktion, men bara fokuserar p친 de f칛lt som 칛r relevanta f칬r migreringen. L칛gg till den h칛r metoden i din migrationsklass.</p>
      <pre><code>def mock_data_for_testing_up
  3.times {|number| Collection.insert({"isbn" =&gt; "#{number}"})}
end

def show_collection
  Collection.find({}).each {|_| puts _}
end
</code>
      </pre>
      <p>Detta kommer att skapa 3 dummydokument som vi kan anv칛nda f칬r testning. Vi l칛gger den h칛r koden i en metod s친 att den 칛r enkel att k칬ra igen n칛r vi justerar och testar v친r migrationskod. F칬r komplexa migreringar kan m친nga justeringsomg친ngar beh칬vas f칬r att f친 alla gr칛nsfall.</p>
      <p>Vi kan nu starta en Rails-konsol och k칬ra den h칛r koden genom att kopiera och klistra in de tv친 klasskonstanterna och metoden mock_data_for_testing_up i konsolen och sedan k칬ra mock_data_for_testing_up</p>
      <pre><code>$ bundle exec rails console
Loading development environment (Rails 3.1.1)
irb(main):001:0&gt; #Klistra in f칬ljande i konsolen
MultiUpdate = {:upsert =&gt; false, :multi =&gt; true, :safe=&gt;true}
Collection = db.collection("test_books_migration") #Endast f칬r testning i konsolen
def mock_data_for_testing_up
  3.times {|number| Collection.insert({"isbn" =&gt; "#{number}"})}
  Collection.find({}).each {|_| puts _}
end
def show_collection
  Collection.find({}).each {|_| puts _}
end
irb(main):008:0&gt; mock_data_for_testing_up
mock_data_for_testing_up
MONGODB app_development['test_books_migration'].insert([{"isbn"=&gt;"0", :_id=&gt;BSON::ObjectId('4ef5f43b2a4397a5d7000001')}])
MONGODB app_development['test_books_migration'].insert([{"isbn"=&gt;"1", :_id=&gt;BSON::ObjectId('4ef5f43b2a4397a5d7000002')}])
MONGODB app_development['test_books_migration'].insert([{"isbn"=&gt;"2", :_id=&gt;BSON::ObjectId('4ef5f43b2a4397a5d7000003')}])
irb(main):009:0&gt; show_collection
MONGODB app_development['test_books_migration'].find({})
{"_id"=&gt;BSON::ObjectId('4ef5f3812a4397a5bd000001'), "isbn"=&gt;"0"}
{"_id"=&gt;BSON::ObjectId('4ef5f3812a4397a5bd000002'), "isbn"=&gt;"1"}
{"_id"=&gt;BSON::ObjectId('4ef5f3812a4397a5bd000003'), "isbn"=&gt;"2"}
=&gt; nil
</code>
      </pre>
      <p>S친 nu har vi en separat, v칛lf칬rst친dd testsamling redo att testa v친r enkla migrering. L친t oss koda v친r <code>up</code>-metod. F칬r att utf칬ra v친r migrering.</p>
      <pre><code>def up
  #Vi vill byta namn p친 f칛ltet book.isbn till book.book_number
  Collection.find({"isbn" =&gt; {"$exists" =&gt; 1}}).each do |book|
    update_op = {
      "$unset" =&gt; {"isbn" =&gt; 1},
      "$set" =&gt; {"book_number" =&gt; book["isbn"]}
    }
  Collection.update({"_id" =&gt; book["_id"]}, update_op, MultiUpdate)
end
</code>
      </pre>
      <p>Vi kan klistra in det i konsolen och k칬ra det f칬r att testa v친r migrering. Vi kan verifiera resultaten med <code>show_colletion</code>. Om vi vill testa andra poster f칬r 친terst칛llningen kan vi skapa en <code>mock_data_for_testing_down</code>-metod.</p>
      <p>Detta b칬r ge dig ett mycket snabbt s칛tt att experimentera och f친 din migrationskod att fungera. Mongo har n친gra avancerade fr친ge- och modifieringsm칬jligheter som kan g칬ra fantastiska saker, och ett enkelt s칛tt att g칬ra lite pr칬vning och fel 칛r anv칛ndbart. Om du g칬r ett oreda av dina testdata kan du anv칛nda <code>Collection.drop</code> f칬r att f친 en ren ritning. H칛r 칛r den slutliga migrationskoden f칬r referens. <strong>Gl칬m inte</strong> att ta bort testsamlingens konstant och ta bort testsamlingen fr친n din databas n칛r du 칛r redo att b칬rja k칬ra din kod p친 riktigt med <code>rake db:migrate</code>.</p>
      <pre><code>class RenameIsbnToBookNumber &lt; Mongoid::Migration
  MultiUpdate = {:upsert =&gt; false, :multi =&gt; true, :safe=&gt;true}
  Collection = db.collection("books") #Slutlig produktionskod

  def up
    #Vi vill byta namn p친 f칛ltet book.isbn till book.book_number
    Collection.find({"isbn" =&gt; {"$exists" =&gt; 1}}).each do |book|
      update_op = {
        "$unset" =&gt; {"isbn" =&gt; 1},
        "$set" =&gt; {"book_number" =&gt; book["isbn"]}
      }
      Collection.update({"_id" =&gt; book["_id"]}, update_op, MultiUpdate)
    end
  end

  def down
    #Vi vill byta namn p친 f칛ltet book.book_number till book.isbn
    Collection.find({"book_number" =&gt; {"$exists" =&gt; 1}}).each do |book|
      update_op = {
        "$unset" =&gt; {"book_number" =&gt; 1},
        "$set" =&gt; {"isbn" =&gt; book["book_number"]}
      }
      Collection.update({"_id" =&gt; book["_id"]}, update_op, MultiUpdate)
    end
  end

  #Dessa metoder anropas inte av migreringen. Endast f칬r manuell testning
  #genom att kopiera/klistra in i konsolen
  #F칬r att testa (genom att kopiera/klistra in h칛rifr친n till konsolen)
  #1. St칛ll in konstanten MultiUpdate. Justera "Collection" till att vara en testsamling
  #2. Kopiera/klistra in de 2 metoderna nedan
  #2. K칬r mock_data_for_testing_up
  #3. K칬r kroppen p친 self.up
  #3b. K칬r alternativt kroppen p친 self.up igen f칬r att se till att den 칛r idempotent
  def mock_data_for_testing_up
    3.times {|number| Collection.insert({"isbn" =&gt; "#{number}"})}
  end

  def show_collection
    Collection.find({}).each {|_| puts _}
  end
end
</code>
      </pre>
    </main>

    <footer>
      <hr>
      <a href="/goto" name="goto">&mdash;&gt; g친 till</a>
      <blockquote>
        <ul>
          <li>
            <a href="mailto:i-hate-this@drawohara.io?subject=/tips-for-mongodb-migrations-in-rails">游땰, jag 游둯 ^det h칛r!<a>
          </li>
          <li>
            <a href="/now">/nu<a>
          </li>
          <li>
            <a href="/about">/om<a>
          </li>
          <li>
            <a href="/contact">/kontakt<a>
          </li>
        </ul>
      </blockquote>
      <a href="/">&lt;&mdash; avsluta</a>
    </footer>
  </body>
</html>