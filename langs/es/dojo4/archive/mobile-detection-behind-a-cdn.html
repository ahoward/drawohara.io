<html color-mode="user" lang="es">
  <head>
  <!-- ga -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-DQVD9T27V4"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-DQVD9T27V4');
</script>

  <!-- deps -->
    <script type="module" src="/assets/js/turbo.es2017-esm.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.fluid.classless.fuchsia.min.css"
    >

  <!-- langs -->
  <!--
    https://developers.google.com/search/docs/specialty/international/localized-versions#html
  -->
   <link rel="alternate" hreflang="en" href="/" />
   <link rel="alternate" hreflang="uk" href="https://drawohara.io/langs/uk" />
   <link rel="alternate" hreflang="sv" href="https://drawohara.io/langs/sv" />
   <link rel="alternate" hreflang="fr" href="https://drawohara.io/langs/fr" />
   <link rel="alternate" hreflang="es" href="https://drawohara.io/langs/es" />
   <link rel="alternate" hreflang="it" href="https://drawohara.io/langs/it" />

  <!-- defaults -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />

  <!-- favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">

  <!-- meta -->
    <title>nada que ver aqu√≠.</title>

<meta property="og:title" content="nada que ver aqu√≠."/>
<meta property="og:description" content="siga adelante." />
<meta property="og:image" content="https://drawohara.io/media/mick.jpg" />

<meta property="og:image:type" content="image/jpeg" />

    <meta property="site:route" content=""/dojo4/archive/:id"">
    <meta property="site:params" content="{"ext":null,"id":"mobile-detection-behind-a-cdn"}">
    <meta property="site:path_info" content=""/mobile-detection-behind-a-cdn"">

    <style>
      /* anti pico */
      a {text-decoration: none !important; }

      /* anti turbo */
      html { transition: none !important; }
      .turbo-progress-bar { visibility: hidden; }

      /* anti progressive */
      html { margin: 1em; }
      img { display: block; text-align: center; }
    </style>

    <script>
      document.addEventListener("turbo:load", function() {
        const progressBar = document.querySelector('.turbo-progress-bar');
        if (progressBar) { progressBar.remove(); }
      });
    </script>
    <base href='/langs/es' />
  </head>

  <body>
    <header>
      <a href="/home">@drawohara</a> &mdash;
<a href="mailto:i-love-this@drawohara.io?subject=/mobile-detection-behind-a-cdn">¬°me ‚ù§Ô∏è  esto!</a>
<small>
  <small>
    <small>
      <span title='b√©belo'>&lt;&lt; haz clic üêõ ü´ñ üßö</span>
    </small>
  </small>
</small>
<hr>
<strong>/detecci√≥n-m√≥vil-detr√°s-de-un-cdn</strong>
    </header>

    <main>
      <em>publicado el: 2014-07-23</em>
<br>
<br>
<div class="ro markdown">
  <p>En un proyecto reciente, nos asignaron la tarea de construir la versi√≥n m√≥vil de un sitio web existente. El sitio web existente realmente no era un buen candidato para un dise√±o responsivo, por lo que decidimos crear una versi√≥n completamente nueva del sitio para dispositivos m√≥viles.</p>

<p>![5547851770<em>3598506559_z.jpg](assets/b.jpeg)<br />
_(foto por <a href="https://www.flickr.com/photos/johanl/5547851770/in/photolist-9sfc3J-63nmeT-3BAAy-dWUBhB-pAZUn-ccjB1w-st5Gc-7B2UEE-bbLNKX-8yTj9M-9e6jeJ-72jTj6-8RU8QS-5TNHyH-8FkSqy-5r7dgL-5A6ymJ-atHdpQ-7BbKMK-8P8X2-7bD7t6-2ViX1A-5E6qqL-6NDF76-9hBh7m-4bSRnn-sZomP-6VbEE-buapa2-5Kw5si-85KrwR-5kpSzg-bjEUUE-bV9J19-5GXRmg-6zbLPt-8yWpiA-akq64F-5n4ciA-9hmSj5-msHvhK-hZpPt-bFe25b-Bjwzo-mFYCVT-d3v8y-6wRQrs-f1p7uv-f8rrUJ-ebxiKS">Johan Larsson</a>)</em></p>

<p>Al principio est√°bamos pensando en usar el patr√≥n m.example.com, donde los sitios son dominios completamente separados. Sin embargo, dado que no administramos la infraestructura de este sitio, quer√≠amos optar por un enfoque que requiriera la menor cantidad posible de cambios en la infraestructura. Soportar otro dominio en los mismos servidores no es muy dif√≠cil, pero es solo otra tarea que es f√°cil de estropear y no es necesaria en nuestro caso.</p>

<p>Tambi√©n he publicado esta t√©cnica para que cualquiera pueda usarla f√°cilmente en una aplicaci√≥n de rails a trav√©s de un motor de rails:</p>

<ul>
  <li>https://github.com/milesmatthias/cdddn</li>
  <li>http://rubygems.org/gems/cdddn</li>
</ul>

<h2 id="intro-a-cloudfront">Intro a CloudFront</h2>

<p>Una gran ventaja de este sitio web en particular es que utiliza <a href="http://aws.amazon.com/cloudfront/">CloudFront</a>. CloudFront es una red de entrega de contenido (tambi√©n conocida como CDN), donde las p√°ginas web est√°ticas se alojan en <a href="http://aws.amazon.com/cloudfront/details/">52 centros de datos en todo el mundo</a>. Esto permite que la p√°gina se sirva al navegador lo m√°s r√°pido posible porque, sin importar d√≥nde est√©s en el mundo, no estar√°s lejos de uno de los nodos de CloudFront, por lo que tomar√° menos tiempo para que el sitio web se entregue a tu dispositivo. CloudFront es parte de la oferta de AWS de Amazon y, adem√°s de garantizar la velocidad, garantizan el tiempo de actividad. (A diferencia de <a href="http://aws.amazon.com/s3/">S3</a>, donde solo se garantiza el tiempo de actividad.)</p>

<p>Cuando usas CloudFront, le dices d√≥nde est√° tu servidor web para que CloudFront pueda obtener la √∫ltima versi√≥n de las p√°ginas web que est√° sirviendo para ti. CloudFront tambi√©n solo le pide a tu servidor web nuevas versiones de tus p√°ginas web cada pocos minutos, o el intervalo de tiempo que configures en tu panel de CloudFront. Normalmente, es en alg√∫n lugar alrededor de 24 horas. Esto permite que CloudFront se centre en la disponibilidad y la velocidad, al mismo tiempo que reduce considerablemente la carga en tu servidor web. (Tambi√©n lleva tiempo para que CloudFront tome una nueva versi√≥n de una p√°gina y actualice los 52 centros de datos.)</p>

<p>Sin embargo, esto introduce el problema de rastrear el estado. Por ejemplo, si tu sitio es enteramente servido por CloudFront, ¬øc√≥mo soportas que los usuarios inicien sesi√≥n en tu sitio? Si soy un usuario llamado Bob y la p√°gina en <code>/mi/cuenta</code> dice ‚ÄúHola Bob!‚Äù, CloudFront pensar√° que todos los que soliciten la p√°gina en <code>/mi/cuenta</code> deben ver la versi√≥n de la p√°gina que dice ‚ÄúHola Bob!‚Äù. Los usuarios (excepto tal vez las personas llamadas Bob‚Ä¶) estar√°n muy confundidos. No solo eso, sino ¬øqu√© pasa si un usuario actualiza alg√∫n valor en su cuenta y espera que ese cambio se muestre al instante? CloudFront no obtiene una nueva versi√≥n de la p√°gina en cada solicitud (eso m√°s o menos derrotar√≠a el prop√≥sito de CloudFront), espera cada pocos minutos para obtener una nueva versi√≥n. CloudFront ha abordado varias de estas preguntas con <a href="http://aws.amazon.com/cloudfront/dynamic-content/">nuevas funciones</a>, pero debes ser consciente de estas implicaciones al usar CloudFront.</p>

<p>En nuestro caso, el sitio en el que estamos trabajando no tiene el concepto de "usuarios" y nadie puede iniciar sesi√≥n en el sistema. Sin embargo, a√∫n queremos que CloudFront muestre diferentes versiones del sitio dependiendo del dispositivo desde el que se solicita el sitio (m√≥vil vs. escritorio).</p>

<p>CloudFront puede detectar el dispositivo para ti y luego enviar un encabezado especial a tu servidor web para decir "Dame la versi√≥n de la p√°gina para un tel√©fono", sin embargo, quer√≠amos controlar el m√©todo de detecci√≥n del dispositivo (respondiendo a la pregunta - ¬øes esto un tel√©fono o un escritorio?) y quer√≠amos la capacidad de que los usuarios finales y los desarrolladores anulen el dispositivo elegido para ellos. Por ejemplo, los usuarios finales en una tablet pueden querer ver la versi√≥n de escritorio incluso si inicialmente les mostramos la versi√≥n m√≥vil. Nuestros desarrolladores tambi√©n encontrar√°n que es una molestia cambiar su dispositivo cada vez que quieran cambiar entre las versiones al construir el sitio.</p>

<h2 id="nuestra-soluci√≥n">Nuestra Soluci√≥n</h2>

<p>Entonces, este es el m√©todo que se nos ocurri√≥ para tener tanto una versi√≥n de escritorio como m√≥vil de un sitio en el mismo dominio y servido por CloudFront. Una nota requerida es que CloudFront normalmente deshabilita todas las cookies para tu dominio, pero puedes configurarlo para permitir las cookies que nombres. En nuestro caso, le dijimos a CloudFront que permitiera una cookie llamada 'dispositivo'. Tambi√©n ten en cuenta que estamos en el contexto de una aplicaci√≥n de rails 4, pero esta arquitectura se puede replicar en cualquier stack. El punto principal aqu√≠ es que el cliente necesita averiguar qu√© dispositivo est√° usando el usuario, permitirle anularlo y mantener al servidor informado del tipo de dispositivo para que el servidor pueda servir las p√°ginas correctas (esto se hace a trav√©s de cookies).</p>

<h3 id="en-cada-p√°gina-necesitamos-hacer-algo-como-este-fragmento-de-appviewslayoutapplicationhtmlerb">En cada p√°gina necesitamos hacer algo como esto (fragmento de app/views/layout/application.html.erb)</h3>

<pre><code class="language-html+erb">&lt;%= javascript_include_tag "mobile_detection" %&gt;

&lt;script&gt;

  if (!window.location.href.match(/get_device|set_device/)){
    console.log('logging the window.location.href = ' + window.location.href);
    localStorage.setItem('referrer_href', window.location.href);
  }

  var device_cookie  = cookie.get('device'),
      cookiesEnabled = cookie.enabled();

  if (cookiesEnabled &amp;&amp; device_cookie == undefined) {
    window.location = '/get_device.html'
  }

&lt;/script&gt;
</code></pre>

<p>El c√≥digo anterior simplemente recuerda en qu√© p√°gina aterrizaste (generalmente la p√°gina de inicio, pero queremos que el cliente pueda compartir enlaces y que funcione en m√≥vil tambi√©n), y luego te redirige a la p√°gina <code>/get_device</code> para detectar tu dispositivo si no lo hemos hecho a√∫n. Ten en cuenta el uso de <code>localStorage</code>, lo que significa que esto solo funcionar√° en IE8+ y no funcionar√° en Opera Mini.</p>

<p>Tambi√©n ten en cuenta que el fragmento anterior se coloca en el <code>&lt;head&gt;</code> del dise√±o para que se ejecute lo antes posible y antes de cualquier script que pueda tener la versi√≥n de escritorio. En este caso, la versi√≥n de escritorio usa mucho javascript para cargar mucho y mucho contenido, por lo que realmente no quer√≠amos que todo eso sucediera en un tel√©fono antes de que el sitio reconociera que el usuario deber√≠a estar viendo la versi√≥n m√≥vil del sitio.</p>

<h3 id="en-cada-p√°gina-m√≥vil-necesitamos-hacer-esto-de-appviewslayoutapplicationmobileerb">En cada p√°gina m√≥vil necesitamos hacer esto (de `app/views/layout/application.mobile.erb):</h3>

<div class="language-js highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #24292f;background-color: #f6f8fa">script</span><span style="color: #0550ae">&gt;</span>
</div><div class='code-line code-line-2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">device_cookie</span>&nbsp;&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">get</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0a3069">'</span><span style="color: #0a3069">device</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">),</span>
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookiesEnabled</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">cookie</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">enabled</span><span style="color: #24292f;background-color: #f6f8fa">();</span>
</div><div class='code-line code-line-4'>&nbsp;
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">if </span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">cookiesEnabled</span>&nbsp;<span style="color: #0550ae">&amp;&amp;</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">device_cookie</span>&nbsp;<span style="color: #0550ae">==</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">desktop</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">)</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">{</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #953800">window</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">location</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">reload</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #0550ae">true</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #116329">/script</span><span style="color: #f6f8fa;background-color: #82071e">&gt;</span>
</div></code></div>

<p>Esto se debe a que los dispositivos m√≥viles almacenan en cach√© las p√°ginas en gran medida (lo cual tiene sentido) por lo que si el usuario ha cambiado el dispositivo en el que se encuentra, debemos asegurarnos de enviar esa cookie actualizada al servidor aunque la url no haya cambiado (y por lo tanto la cach√© piensa que es la misma p√°gina que debe servirse). El <code>true</code> en la llamada a la funci√≥n <code>reload</code> le dice al navegador que ignore lo que hay en la cach√©.</p>

<p>Ten en cuenta que hacemos exactamente lo mismo en cada p√°gina de escritorio tambi√©n, excepto que verificamos si el usuario ha cambiado su dispositivo a <code>'m√≥vil'</code>.</p>

<h3 id="detecci√≥n-de-dispositivo-en-get_device-appviewshomeget_devicehtml">Detecci√≥n de Dispositivo en <code>/get_device</code> (app/views/home/get_device.html)</h3>

<div class="language-js highlighter-rouge"><code class='code' style='white-space:pre;'><div class='code-line code-line-1'>&nbsp;&nbsp;<span style="color: #0550ae">&lt;</span><span style="color: #24292f;background-color: #f6f8fa">script</span><span style="color: #0550ae">&gt;</span>
</div><div class='code-line code-line-2'>&nbsp;
</div><div class='code-line code-line-3'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">function</span>&nbsp;<span style="color: #8250df">isMobile</span><span style="color: #24292f;background-color: #f6f8fa">(){</span>
</div><div class='code-line code-line-4'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">var</span>&nbsp;<span style="color: #24292f;background-color: #f6f8fa">MOBILE_USER_AGENTS</span>&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">palm|blackberry|nokia|phone|midp|mobi|symbian|chtml|ericsson|minimo|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">audiovox|motorola|samsung|telit|upg1|windows ce|ucweb|astel|plucker|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">x320|x240|j2me|sgh|portable|sprint|docomo|kddi|softbank|android|mmp|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-7'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">pdxgw|netfront|xiino|vodafone|portalmmm|sagem|mot-|sie-|ipod|up</span><span style="color: #0a3069">\\</span><span style="color: #0a3069">.b|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-8'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">webos|amoi|novarra|cdm|alcatel|pocket|ipad|iphone|mobileexplorer|</span><span style="color: #0a3069">'</span>&nbsp;<span style="color: #0550ae">+</span>
</div><div class='code-line code-line-9'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0a3069">'</span><span style="color: #0a3069">mobile|zune</span><span style="color: #0a3069">'</span><span style="color: #24292f;background-color: #f6f8fa">,</span>
</div><div class='code-line code-line-10'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">mobile_regex</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #0550ae">=</span>&nbsp;<span style="color: #cf222e">new</span>&nbsp;<span style="color: #953800">RegExp</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">MOBILE_USER_AGENTS</span><span style="color: #24292f;background-color: #f6f8fa">,</span>&nbsp;<span style="color: #0a3069">"</span><span style="color: #0a3069">i</span><span style="color: #0a3069">"</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-11'>&nbsp;
</div><div class='code-line code-line-12'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #cf222e">return</span>&nbsp;<span style="color: #953800">navigator</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #24292f;background-color: #f6f8fa">userAgent</span><span style="color: #24292f;background-color: #f6f8fa">.</span><span style="color: #8250df">match</span><span style="color: #24292f;background-color: #f6f8fa">(</span><span style="color: #24292f;background-color: #f6f8fa">mobile_regex</span><span style="color: #24292f;background-color: #f6f8fa">);</span>
</div><div class='code-line code-line-13'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #24292f;background-color: #f6f8fa">}</span>
</div><div class='code-line code-line-14'>&nbsp;
</div><div class='code-line code-line-15'>&nbsp;&nbsp;&nbsp;&nbsp;<span style="color: #6e7781">// estableciendo la cookie del dispositivo en